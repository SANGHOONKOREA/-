<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tesseract OCR ê¸°ë°˜ ë‹¤êµ­ì–´ ëª…í•¨ ê´€ë¦¬ ì•±</title>
    <!-- Tesseract.js for OCR - ìµœì‹  ì•ˆì •í™” ë²„ì „ ì‚¬ìš© -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <!-- OpenCV.js for image preprocessing -->
    <script src="https://docs.opencv.org/4.7.0/opencv.js" type="text/javascript"></script>
    <!-- TensorFlow.js for AI-based text analysis -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans', 'Noto Sans KR', 'Noto Sans JP', 'Noto Sans SC', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 100%;
            padding: 15px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        header h1 {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 5px;
        }
        
        header p {
            color: #007bff;
            font-size: 0.9rem;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            background-color: #f0f0f0;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .tab.active {
            background-color: #007bff;
            color: white;
        }
        
        .content {
            display: none;
        }
        
        .content.active {
            display: block;
        }
        
        .card-form {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: inline-block;
            margin-right: 10px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        .camera-container {
            width: 100%;
            position: relative;
            margin-bottom: 20px;
        }
        
        #video, #canvas, #capturedImage {
            width: 100%;
            border-radius: 8px;
            display: block;
        }
        
        #capturedImage {
            margin-top: 10px;
            display: none;
        }
        
        .progress-bar {
            height: 5px;
            background-color: #f0f0f0;
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar-fill {
            height: 100%;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .progress-bar-pulse {
            height: 100%;
            width: 100%;
            position: absolute;
            background: linear-gradient(90deg, 
                transparent 0%, 
                transparent 40%, 
                rgba(255, 255, 255, 0.5) 50%, 
                transparent 60%, 
                transparent 100%);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .card-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        
        .card-item {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 15px;
            position: relative;
        }
        
        .card-item h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .card-details {
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .card-details p {
            margin-bottom: 5px;
        }
        
        .card-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }
        
        .card-actions button {
            padding: 8px 12px;
            font-size: 14px;
            margin-left: 10px;
        }
        
        .delete-btn {
            background-color: #dc3545;
        }
        
        .delete-btn:hover {
            background-color: #c82333;
        }
        
        .edit-btn {
            background-color: #6c757d;
        }
        
        .edit-btn:hover {
            background-color: #5a6268;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 0;
            color: #6c757d;
        }
        
        #processingMessage {
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
            color: #007bff;
        }
        
        .search-container {
            margin-bottom: 20px;
        }
        
        #searchInput {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .hidden {
            display: none;
        }
        
        /* ì–¸ì–´ ì„ íƒ */
        .language-selector {
            margin-bottom: 15px;
            text-align: center;
        }
        
        .language-btn {
            margin: 0 5px;
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 4px;
        }
        
        .language-btn.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }
        
        .close-modal:hover {
            color: #333;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
        }

        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* ì¶”ê°€ëœ ìŠ¤íƒ€ì¼: ì´ë¯¸ì§€ ì „ì²˜ë¦¬ ì˜µì…˜ ë©”ë‰´ */
        .preprocessing-options {
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }
        
        .preprocessing-options h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .option-item {
            display: flex;
            align-items: center;
        }
        
        .option-item input {
            margin-right: 5px;
        }
        
        /* ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .preview-container {
            display: flex;
            margin-top: 10px;
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 10px;
        }
        
        .preview-item {
            flex: 0 0 auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            width: 120px;
        }
        
        .preview-item img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .preview-item p {
            font-size: 12px;
            text-align: center;
            padding: 4px;
            background-color: #f5f5f5;
        }
        
        /* ì²˜ë¦¬ ë‹¨ê³„ í‘œì‹œ */
        .steps-indicator {
            display: flex;
            margin-bottom: 15px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .step {
            flex: 1;
            min-width: 80px;
            text-align: center;
            padding: 8px 4px;
            background-color: #f0f0f0;
            border-right: 1px solid #ddd;
            font-size: 12px;
            position: relative;
        }
        
        .step:last-child {
            border-right: none;
        }
        
        .step.active {
            background-color: #e6f7ff;
            font-weight: bold;
        }
        
        .step.completed {
            background-color: #d4edda;
        }
        
        .step.current {
            background-color: #007bff;
            color: white;
        }
        
        /* ê²°ê³¼ ì‹ ë¢°ë„ í‘œì‹œ */
        .confidence-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .confidence-bar {
            flex: 1;
            height: 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin-right: 10px;
        }
        
        .confidence-fill {
            height: 100%;
            background-color: #28a745;
            width: 0%;
        }
        
        .confidence-text {
            font-size: 14px;
            font-weight: bold;
            min-width: 60px;
            text-align: right;
        }
        
        /* ì´ë¯¸ì§€ íšŒì „ ë²„íŠ¼ */
        .rotate-buttons {
            display: flex;
            justify-content: center;
            margin-top: 10px;
            margin-bottom: 15px;
        }
        
        .rotate-buttons button {
            padding: 6px 12px;
            margin: 0 5px;
            font-size: 14px;
        }
        
        /* ì›ì‹œ OCR ê²°ê³¼ */
        .raw-ocr-container {
            max-height: 200px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 15px;
            white-space: pre-wrap;
            word-break: break-all;
            display: none;
        }
        
        /* ëª…í•¨ ì´ë¯¸ì§€ ì—…ë¡œë“œ */
        .upload-container {
            margin-bottom: 15px;
            text-align: center;
        }
        
        #fileInput {
            display: none;
        }
        
        .upload-btn {
            padding: 8px 16px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .upload-btn:hover {
            background-color: #5a6268;
        }
        
        /* OpenCV ë¡œë”© ìƒíƒœ */
        #opencvStatus {
            text-align: center;
            font-size: 12px;
            color: #6c757d;
            margin: 5px 0;
        }
        
        /* Tesseract ë‹¤ìš´ë¡œë“œ ìƒíƒœ */
        #tesseractStatus {
            text-align: center;
            font-size: 12px;
            color: #6c757d;
            margin: 5px 0;
        }
        
        /* AI ëª¨ë¸ ìƒíƒœ */
        #aiModelStatus {
            text-align: center;
            font-size: 12px;
            color: #6c757d;
            margin: 5px 0;
        }
        
        /* ê³ ê¸‰ ëª¨ë“œ ìŠ¤ìœ„ì¹˜ */
        .advanced-switch {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin: 0 10px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #2196F3;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #007bff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* AI ë¶„ì„ ê²°ê³¼ */
        .ai-results {
            background-color: #f0f7ff;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid #b8daff;
            display: none;
        }
        
        .ai-results h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #0056b3;
        }
        
        .ai-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .ai-category {
            font-weight: bold;
            flex: 1;
        }
        
        .ai-text {
            flex: 2;
        }
        
        .ai-confidence {
            flex: 0 0 60px;
            text-align: right;
            color: #6c757d;
            font-size: 12px;
        }
        
        /* ëª…í•¨ ì¸ì‹ ê°€ì´ë“œ ìŠ¤íƒ€ì¼ */
        .card-detection-guide {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 100;
        }
        
        .guide-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 85%;
            height: 55%;
            transform: translate(-50%, -50%);
            border: 2px solid rgba(40, 167, 69, 0.8);
            border-radius: 8px;
            box-shadow: 0 0 0 2000px rgba(0, 0, 0, 0.3);
        }
        
        .guide-corner {
            position: absolute;
            width: 20px;
            height: 20px;
        }
        
        .corner-tl {
            top: -5px;
            left: -5px;
            border-top: 3px solid rgba(40, 167, 69, 1);
            border-left: 3px solid rgba(40, 167, 69, 1);
            border-top-left-radius: 4px;
        }
        
        .corner-tr {
            top: -5px;
            right: -5px;
            border-top: 3px solid rgba(40, 167, 69, 1);
            border-right: 3px solid rgba(40, 167, 69, 1);
            border-top-right-radius: 4px;
        }
        
        .corner-bl {
            bottom: -5px;
            left: -5px;
            border-bottom: 3px solid rgba(40, 167, 69, 1);
            border-left: 3px solid rgba(40, 167, 69, 1);
            border-bottom-left-radius: 4px;
        }
        
        .corner-br {
            bottom: -5px;
            right: -5px;
            border-bottom: 3px solid rgba(40, 167, 69, 1);
            border-right: 3px solid rgba(40, 167, 69, 1);
            border-bottom-right-radius: 4px;
        }
        
        .guide-text {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            transition: background-color 0.3s;
        }
        
        .auto-capture-btn {
            position: absolute;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            display: none;
            pointer-events: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 101;
        }
        
        /* ì¹´ë©”ë¼ ì»¨íŠ¸ë¡¤ ì˜ì—­ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ */
        .camera-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 50;
        }
        
        /* ì‹¤ì‹œê°„ í’ˆì§ˆ ë¶„ì„ ì§€í‘œ ìŠ¤íƒ€ì¼ */
        .quality-indicators {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 8px;
            padding: 5px 10px;
            color: white;
            font-size: 12px;
            display: none;
        }
        
        .indicator-item {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }
        
        .indicator-label {
            flex: 1;
        }
        
        .indicator-bar {
            flex: 2;
            height: 6px;
            background-color: #444;
            border-radius: 3px;
            margin: 5px 10px 0 10px;
        }
        
        .indicator-fill {
            height: 100%;
            background-color: #007bff;
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .indicator-value {
            width: 30px;
            text-align: right;
        }
        
        /* í”Œë˜ì‹œ íš¨ê³¼ ìŠ¤íƒ€ì¼ */
        .flash-effect {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: white;
            opacity: 0;
            z-index: 999;
            transition: opacity 0.2s ease;
        }
        
        /* ë¹„ë„¤íŒ… íš¨ê³¼ (ëª…í•¨ ê°•ì¡°) */
        .vignette-effect {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 50;
            background: radial-gradient(
                ellipse at center,
                transparent 40%,
                rgba(0, 0, 0, 0.3) 100%
            );
        }
        
        /* ì¡°ëª… ìƒíƒœ ì•„ì´ì½˜ */
        .lighting-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 20px;
        }
        
        /* í’ˆì§ˆ ìƒì„¸ ì •ë³´ íŒì—… */
        .quality-details {
            position: absolute;
            bottom: 70px;
            left: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            padding: 10px;
            color: white;
            font-size: 13px;
            z-index: 100;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .quality-details.active {
            max-height: 300px;
        }
        
        .details-toggle {
            position: absolute;
            right: 10px;
            bottom: 30px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 101;
            cursor: pointer;
        }
        
        /* ì¹´ë©”ë¼ ì•ˆë‚´ í…ìŠ¤íŠ¸ ê°•í™” */
        .camera-guide {
            text-align: center;
            background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.7));
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .camera-guide h3 {
            margin-top: 0;
            color: #007bff;
        }
        
        .camera-guide ul {
            text-align: left;
            margin-bottom: 0;
            padding-left: 20px;
        }
        
        .camera-guide ul li {
            margin-bottom: 5px;
        }
        
        /* íˆ´íŒ ìŠ¤íƒ€ì¼ */
        .tooltip {
            position: absolute;
            background-color: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .tooltip:after {
            content: '';
            position: absolute;
            border-style: solid;
            border-width: 5px;
        }
        
        .tooltip.top:after {
            border-color: #333 transparent transparent transparent;
            top: 100%;
            left: 50%;
            margin-left: -5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Tesseract OCR ê¸°ë°˜ ë‹¤êµ­ì–´ ëª…í•¨ ê´€ë¦¬ ì•±</h1>
            <p>ê³ ê¸‰ ì´ë¯¸ì§€ ì²˜ë¦¬ ë° AI ë¶„ì„ ê¸°ìˆ  í™œìš©</p>
        </header>
        
        <div id="opencvStatus">OpenCV.js ë¡œë”© ì¤‘...</div>
        <div id="tesseractStatus">Tesseract ì—”ì§„ ì´ˆê¸°í™” ì¤‘...</div>
        <div id="aiModelStatus">AI ëª¨ë¸ ì¤€ë¹„ ì¤‘...</div>
        
        <div class="tab-container">
            <div class="tab active" data-tab="camera">ëª…í•¨ ì¶”ê°€</div>
            <div class="tab" data-tab="dashboard">ëŒ€ì‹œë³´ë“œ</div>
            <div class="tab" data-tab="settings">ì„¤ì •</div>
        </div>
        
        <div id="cameraContent" class="content active">
            <div class="language-selector">
                <button class="language-btn active" data-lang="kor">í•œêµ­ì–´</button>
                <button class="language-btn" data-lang="eng">ì˜ì–´</button>
                <button class="language-btn" data-lang="jpn">ì¼ë³¸ì–´</button>
                <button class="language-btn" data-lang="chi_sim">ì¤‘êµ­ì–´</button>
                <button class="language-btn" data-lang="multi">ë‹¤êµ­ì–´</button>
            </div>
            
            <div class="advanced-switch">
                <span>ì¼ë°˜ ëª¨ë“œ</span>
                <label class="switch">
                    <input type="checkbox" id="advancedModeToggle">
                    <span class="slider"></span>
                </label>
                <span>ê³ ê¸‰ ëª¨ë“œ</span>
            </div>
            
            <div class="camera-container">
                <button id="accessCameraBtn" class="primary-button">ì¹´ë©”ë¼ ì ‘ê·¼ í—ˆìš©</button>
                <video id="video" autoplay playsinline style="display: none;"></video>
                <canvas id="canvas" style="display: none;"></canvas>
                <img id="capturedImage" alt="ì´¬ì˜ëœ ì´ë¯¸ì§€">
                
                <div class="upload-container">
                    <input type="file" id="fileInput" accept="image/*">
                    <button id="uploadBtn" class="upload-btn">ë˜ëŠ” ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
                </div>
                
                <!-- ì´ë¯¸ì§€ íšŒì „ ë²„íŠ¼ ì¶”ê°€ -->
                <div class="rotate-buttons" style="display: none;" id="rotateButtons">
                    <button id="rotateLeftBtn">â† 90Â° íšŒì „</button>
                    <button id="rotateRightBtn">90Â° íšŒì „ â†’</button>
                </div>
                
                <!-- ëª…í•¨ ì¸ì‹ ê°€ì´ë“œ êµ¬ì„±ìš”ì†Œ -->
                <div id="cardScanningGuide" class="card-detection-guide" style="display: none;">
                    <div class="guide-frame">
                        <div class="guide-corner corner-tl"></div>
                        <div class="guide-corner corner-tr"></div>
                        <div class="guide-corner corner-bl"></div>
                        <div class="guide-corner corner-br"></div>
                    </div>
                    <div id="cardDetectionGuide" class="guide-text">ëª…í•¨ì„ ê°€ì´ë“œ ì˜ì—­ ì•ˆì— ë§ì¶°ì£¼ì„¸ìš”</div>
                    <button id="autoCaptureBtn" class="auto-capture-btn">ìµœì  ìƒíƒœ ê°ì§€ë¨ - ì´¬ì˜í•˜ê¸°</button>
                    
                    <div class="quality-indicators" id="qualityIndicators">
                        <div class="indicator-item">
                            <div class="indicator-label">ë°ê¸°</div>
                            <div class="indicator-bar"><div class="indicator-fill" id="brightnessIndicator"></div></div>
                            <div class="indicator-value" id="brightnessValue">0%</div>
                        </div>
                        <div class="indicator-item">
                            <div class="indicator-label">ì„ ëª…ë„</div>
                            <div class="indicator-bar"><div class="indicator-fill" id="sharpnessIndicator"></div></div>
                            <div class="indicator-value" id="sharpnessValue">0%</div>
                        </div>
                        <div class="indicator-item">
                            <div class="indicator-label">ì •ë ¬</div>
                            <div class="indicator-bar"><div class="indicator-fill" id="alignmentIndicator"></div></div>
                            <div class="indicator-value" id="alignmentValue">0%</div>
                        </div>
                    </div>
                    
                    <div id="qualityDetails" class="quality-details">
                        <h4 style="margin-top: 0;">í’ˆì§ˆ ì„¸ë¶€ ì •ë³´</h4>
                        <div id="qualityDetailsList"></div>
                    </div>
                    
                    <button id="detailsToggle" class="details-toggle">i</button>
                    <div id="lightingIndicator" class="lighting-indicator">ğŸ’¡</div>
                    <div id="flashEffect" class="flash-effect"></div>
                    <div class="vignette-effect"></div>
                </div>
            </div>
            
            <div class="button-group" style="text-align: center; margin-bottom: 20px;">
                <button id="captureBtn" style="display: none;">ëª…í•¨ ì´¬ì˜</button>
                <button id="retakeBtn" style="display: none;">ë‹¤ì‹œ ì´¬ì˜</button>
                <button id="analyzeBtn" style="display: none;">ëª…í•¨ ë¶„ì„</button>
                <button id="advancedBtn" style="display: none; background-color: #6c757d;">ê³ ê¸‰ ì˜µì…˜</button>
                <button id="improveImageBtn" style="display: none; background-color: #28a745;">ì´ë¯¸ì§€ ê°œì„ </button>
            </div>
            
            <!-- AI ë¶„ì„ ê²°ê³¼ -->
            <div class="ai-results" id="aiResults">
                <h3>AI ë¶„ì„ ê²°ê³¼</h3>
                <div id="aiResultsList"></div>
            </div>
            
            <!-- ê³ ê¸‰ ì „ì²˜ë¦¬ ì˜µì…˜ -->
            <div class="preprocessing-options" id="preprocessingOptions">
                <h3>ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜µì…˜</h3>
                <div class="options-grid">
                    <div class="option-item">
                        <input type="checkbox" id="optGrayscale" checked>
                        <label for="optGrayscale">ê·¸ë ˆì´ìŠ¤ì¼€ì¼</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="optAdaptiveThreshold">
                        <label for="optAdaptiveThreshold">ì ì‘í˜• ì´ì§„í™”</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="optContrast" checked>
                        <label for="optContrast">ëŒ€ë¹„ í–¥ìƒ</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="optSharpen" checked>
                        <label for="optSharpen">ì„ ëª…í•˜ê²Œ</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="optDenoise">
                        <label for="optDenoise">ë…¸ì´ì¦ˆ ì œê±°</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="optThreshold">
                        <label for="optThreshold">ì¼ë°˜ ì´ì§„í™”</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="optEdgeEnhance">
                        <label for="optEdgeEnhance">ìœ¤ê³½ì„  ê°•í™”</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="optDeskew">
                        <label for="optDeskew">ê¸°ìš¸ê¸° ë³´ì •</label>
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    <button id="applyPreprocessingBtn">ì ìš©í•˜ê¸°</button>
                    <button id="resetPreprocessingBtn" style="background-color: #6c757d;">ì›ë³¸ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°</button>
                </div>
            </div>
            
            <!-- ì²˜ë¦¬ ë‹¨ê³„ í‘œì‹œ -->
            <div class="steps-indicator" id="stepsIndicator" style="display: none;">
                <div class="step" data-step="capture">ì´ë¯¸ì§€ ì´¬ì˜</div>
                <div class="step" data-step="preprocess">ì´ë¯¸ì§€ ì²˜ë¦¬</div>
                <div class="step" data-step="ocr">í…ìŠ¤íŠ¸ ì¸ì‹</div>
                <div class="step" data-step="extract">ì •ë³´ ì¶”ì¶œ</div>
                <div class="step" data-step="review">ê²°ê³¼ í™•ì¸</div>
            </div>
            
            <div id="statusMessage" class="status-message info" style="display: none;">ëª…í•¨ ë¶„ì„ ì¤€ë¹„ ì¤‘...</div>
            
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-bar-fill" id="progressBarFill"></div>
                <div class="progress-bar-pulse" id="progressBarPulse" style="display: none;"></div>
            </div>
            
            <!-- ì‹ ë¢°ë„ í‘œì‹œ -->
            <div class="confidence-indicator" id="confidenceIndicator" style="display: none;">
                <div class="confidence-bar">
                    <div class="confidence-fill" id="confidenceFill"></div>
                </div>
                <div class="confidence-text" id="confidenceText">0%</div>
            </div>
            
            <!-- ì›ì‹œ OCR ê²°ê³¼ í‘œì‹œ -->
            <div class="raw-ocr-container" id="rawOcrResult" style="display: none;"></div>
            
            <!-- ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆ -->
            <div class="preview-container" id="previewContainer" style="display: none;">
                <!-- ì—¬ê¸°ì— ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ê°€ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
            
            <div class="card-form" id="cardForm" style="display: none;">
                <div class="form-group">
                    <label for="name">ì´ë¦„</label>
                    <input type="text" id="name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                
                <div class="form-group">
                    <label for="position">ì§ì±…</label>
                    <input type="text" id="position" placeholder="ì§ì±…ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                
                <div class="form-group">
                    <label for="company">íšŒì‚¬</label>
                    <input type="text" id="company" placeholder="íšŒì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                
                <div class="form-group">
                    <label for="department">ë¶€ì„œ</label>
                    <input type="text" id="department" placeholder="ë¶€ì„œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                
                <div class="form-group">
                    <label for="phone">íœ´ëŒ€í° ë²ˆí˜¸</label>
                    <input type="tel" id="phone" placeholder="íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                
                <div class="form-group">
                    <label for="email">ì´ë©”ì¼</label>
                    <input type="email" id="email" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                
                <div class="form-group">
                    <label for="address">ì£¼ì†Œ</label>
                    <input type="text" id="address" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                
                <div class="form-group">
                    <label for="website">ì›¹ì‚¬ì´íŠ¸</label>
                    <input type="url" id="website" placeholder="ì›¹ì‚¬ì´íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                
                <div class="form-group">
                    <label for="notes">ë©”ëª¨</label>
                    <textarea id="notes" placeholder="ì´ ì‚¬ëŒì— ëŒ€í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>
                
                <button id="saveBtn">ëª…í•¨ ì €ì¥</button>
            </div>
        </div>
        
        <div id="dashboardContent" class="content">
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="ì´ë¦„, íšŒì‚¬, ì§ì±… ë“±ìœ¼ë¡œ ê²€ìƒ‰">
            </div>
            
            <div id="cardList" class="card-list">
                <!-- ëª…í•¨ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            
            <div id="emptyState" class="empty-state">
                <p>ë“±ë¡ëœ ëª…í•¨ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                <p>ì¹´ë©”ë¼ íƒ­ì—ì„œ ìƒˆ ëª…í•¨ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>
            </div>
        </div>
        
        <div id="settingsContent" class="content">
            <div class="card-form">
                <h2>OCR ì„¤ì •</h2>
                
                <div class="form-group">
                    <label for="tesseractParams">Tesseract ê³ ê¸‰ ë§¤ê°œë³€ìˆ˜</label>
                    <textarea id="tesseractParams" placeholder="í˜•ì‹: ë§¤ê°œë³€ìˆ˜_ì´ë¦„=ê°’ (í•œ ì¤„ì— í•˜ë‚˜ì”©)">tessedit_char_whitelist=ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.,-@+():;/'\" 
preserve_interword_spaces=1
tessedit_pageseg_mode=4
textord_tabfind_force_vertical_text=0
textord_tablefind_recognize_tables=0</textarea>
                </div>
                
                <div class="form-group">
                    <label for="imageQuality">ì´ë¯¸ì§€ í’ˆì§ˆ (ì—…ë¡œë“œ ë° ìº¡ì²˜)</label>
                    <select id="imageQuality">
                        <option value="0.6">ë‚®ìŒ (ë¹ ë¥¸ ì²˜ë¦¬)</option>
                        <option value="0.8" selected>ì¤‘ê°„ (ê¶Œì¥)</option>
                        <option value="0.95">ë†’ìŒ (ëŠë¦° ì²˜ë¦¬)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="showRawOcr">
                        OCR ì›ë³¸ ê²°ê³¼ í‘œì‹œ
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="autoPreprocess" checked>
                        ìë™ ì´ë¯¸ì§€ ê°œì„  ì ìš©
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="useAI" checked>
                        AI ë¶„ì„ ì‚¬ìš© (ë” ì •í™•í•œ ëª…í•¨ ì •ë³´ ì¸ì‹)
                    </label>
                </div>
                
                <div class="form-group">
                    <label for="psm">PSM (Page Segmentation Mode)</label>
                    <select id="psm">
                        <option value="3">3 - ìë™ í˜ì´ì§€ ë¶„í•  (ê¸°ë³¸ê°’)</option>
                        <option value="4" selected>4 - ê°€ë³€ í¬ê¸° í…ìŠ¤íŠ¸ ë‹¨ì¼ ì¹¼ëŸ¼ ê°€ì •</option>
                        <option value="6">6 - ë‹¨ì¼ í…ìŠ¤íŠ¸ ë¸”ë¡ ê°€ì •</option>
                        <option value="11">11 - í…ìŠ¤íŠ¸ íšŒì „ ì—†ì´ í¬ì†Œ í…ìŠ¤íŠ¸</option>
                        <option value="12">12 - ë°€ì§‘ëœ í…ìŠ¤íŠ¸ + OSD</option>
                    </select>
                </div>
                
                <button id="saveSettingsBtn">ì„¤ì • ì €ì¥</button>
                <button id="resetSettingsBtn" style="background-color: #6c757d;">ê¸°ë³¸ê°’ìœ¼ë¡œ ì¬ì„¤ì •</button>
            </div>
            
            <div class="card-form" style="margin-top: 20px;">
                <h2>ë°ì´í„° ê´€ë¦¬</h2>
                
                <div class="form-group">
                    <label>ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°</label>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button id="exportDataBtn">ëª…í•¨ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
                        <button id="importDataBtn">ëª…í•¨ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ë°ì´í„° ì´ˆê¸°í™”</label>
                    <button id="clearDataBtn" style="background-color: #dc3545; margin-top: 10px;">ëª¨ë“  ëª…í•¨ ë°ì´í„° ì‚­ì œ</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ëª…í•¨ ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>ëª…í•¨ ìˆ˜ì •</h2>
            
            <div class="form-group">
                <label for="editName">ì´ë¦„</label>
                <input type="text" id="editName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            
            <div class="form-group">
                <label for="editPosition">ì§ì±…</label>
                <input type="text" id="editPosition" placeholder="ì§ì±…ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            
            <div class="form-group">
                <label for="editCompany">íšŒì‚¬</label>
                <input type="text" id="editCompany" placeholder="íšŒì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            
            <div class="form-group">
                <label for="editDepartment">ë¶€ì„œ</label>
                <input type="text" id="editDepartment" placeholder="ë¶€ì„œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            
            <div class="form-group">
                <label for="editPhone">íœ´ëŒ€í° ë²ˆí˜¸</label>
                <input type="tel" id="editPhone" placeholder="íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            
            <div class="form-group">
                <label for="editEmail">ì´ë©”ì¼</label>
                <input type="email" id="editEmail" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            
            <div class="form-group">
                <label for="editAddress">ì£¼ì†Œ</label>
                <input type="text" id="editAddress" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            
            <div class="form-group">
                <label for="editWebsite">ì›¹ì‚¬ì´íŠ¸</label>
                <input type="url" id="editWebsite" placeholder="ì›¹ì‚¬ì´íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            
            <div class="form-group">
                <label for="editNotes">ë©”ëª¨</label>
                <textarea id="editNotes" placeholder="ì´ ì‚¬ëŒì— ëŒ€í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            </div>
            
            <button id="updateBtn">ìˆ˜ì • ì™„ë£Œ</button>
        </div>
    </div>
    
    <!-- ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ëª¨ë‹¬ -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <span class="close-modal import-close">&times;</span>
            <h2>ëª…í•¨ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</h2>
            
            <div class="form-group">
                <label for="importData">JSON ë°ì´í„°</label>
                <textarea id="importData" placeholder="ë‚´ë³´ë‚¸ JSON ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”" rows="10"></textarea>
            </div>
            
            <button id="confirmImportBtn">ê°€ì ¸ì˜¤ê¸°</button>
            <button class="import-close" style="background-color: #6c757d;">ì·¨ì†Œ</button>
        </div>
    </div>
    

<script>
    // í˜¸í™˜ì„± ë„ìš°ë¯¸ í•¨ìˆ˜ë“¤ - ìŠ¤í¬ë¦½íŠ¸ ìµœìƒë‹¨ì— ì¶”ê°€
    function boxPoints(rotatedRect) {
        try {
            // ìµœì‹  OpenCV.js ë²„ì „ì—ì„œ boxPoints í•¨ìˆ˜ ì‚¬ìš© ì‹œë„
            return cv.boxPoints(rotatedRect);
        } catch (e) {
            console.log('boxPoints í•¨ìˆ˜ ëŒ€ì²´ ì‚¬ìš©');
            // ìˆ˜ë™ìœ¼ë¡œ íšŒì „ëœ ì‚¬ê°í˜•ì˜ ì ë“¤ ê³„ì‚°
            const center = rotatedRect.center;
            const size = rotatedRect.size;
            const angle = rotatedRect.angle * Math.PI / 180.0; // ë¼ë””ì•ˆ ë³€í™˜
            
            const b = Math.cos(angle) * 0.5;
            const a = Math.sin(angle) * 0.5;
            
            // Float32Array ìƒì„± (OpenCV ë°©ì‹ê³¼ ìœ ì‚¬í•˜ê²Œ)
            const points_data = new Float32Array(8);
            
            // ë„¤ ê¼­ì§€ì  ê³„ì‚° ë° ë°°ì—´ì— ì €ì¥
            points_data[0] = center.x - a * size.height - b * size.width; 
            points_data[1] = center.y + b * size.height - a * size.width;
            
            points_data[2] = center.x + a * size.height - b * size.width; 
            points_data[3] = center.y - b * size.height - a * size.width;
            
            points_data[4] = center.x + a * size.height + b * size.width; 
            points_data[5] = center.y - b * size.height + a * size.width;
            
            points_data[6] = center.x - a * size.height + b * size.width; 
            points_data[7] = center.y + b * size.height + a * size.width;
            
            return {
                data32F: points_data
            };
        }
    }

    // ë…¸ì´ì¦ˆ ì œê±° ì•ˆì „ í•¨ìˆ˜
    function safeNlMeansDenoising(src, dst, h = 10, templateWindowSize = 7, searchWindowSize = 21) {
        try {
            // ìµœì‹  ë²„ì „ ì‚¬ìš© ì‹œë„
            cv.fastNlMeansDenoising(src, dst, h, templateWindowSize, searchWindowSize);
        } catch (e) {
            console.log('fastNlMeansDenoising í•¨ìˆ˜ ëŒ€ì²´ ì‚¬ìš©');
            // ëŒ€ì²´ ê¸°ëŠ¥: ê°€ìš°ì‹œì•ˆ ë¸”ëŸ¬ ì ìš©
            cv.GaussianBlur(src, dst, new cv.Size(5, 5), 0, 0, cv.BORDER_DEFAULT);
        }
    }

    // DOM ìš”ì†Œ
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const capturedImage = document.getElementById('capturedImage');
        const captureBtn = document.getElementById('captureBtn');
        const retakeBtn = document.getElementById('retakeBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const cardForm = document.getElementById('cardForm');
        const saveBtn = document.getElementById('saveBtn');
        const statusMessage = document.getElementById('statusMessage');
        const progressBar = document.getElementById('progressBar');
        const progressBarFill = document.getElementById('progressBarFill');
        const progressBarPulse = document.getElementById('progressBarPulse');
        const cardList = document.getElementById('cardList');
        const emptyState = document.getElementById('emptyState');
        const searchInput = document.getElementById('searchInput');
        const editModal = document.getElementById('editModal');
        const closeModal = document.querySelector('.close-modal');
        const updateBtn = document.getElementById('updateBtn');
        const accessCameraBtn = document.getElementById('accessCameraBtn');
        const languageButtons = document.querySelectorAll('.language-btn');
        const improveImageBtn = document.getElementById('improveImageBtn');
        const advancedBtn = document.getElementById('advancedBtn');
        const preprocessingOptions = document.getElementById('preprocessingOptions');
        const applyPreprocessingBtn = document.getElementById('applyPreprocessingBtn');
        const resetPreprocessingBtn = document.getElementById('resetPreprocessingBtn');
        const confidenceIndicator = document.getElementById('confidenceIndicator');
        const confidenceFill = document.getElementById('confidenceFill');
        const confidenceText = document.getElementById('confidenceText');
        const stepsIndicator = document.getElementById('stepsIndicator');
        const previewContainer = document.getElementById('previewContainer');
        const rotateButtons = document.getElementById('rotateButtons');
        const rotateLeftBtn = document.getElementById('rotateLeftBtn');
        const rotateRightBtn = document.getElementById('rotateRightBtn');
        const rawOcrResult = document.getElementById('rawOcrResult');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const tesseractParams = document.getElementById('tesseractParams');
        const imageQuality = document.getElementById('imageQuality');
        const showRawOcr = document.getElementById('showRawOcr');
        const autoPreprocess = document.getElementById('autoPreprocess');
        const useAI = document.getElementById('useAI');
        const psm = document.getElementById('psm');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const resetSettingsBtn = document.getElementById('resetSettingsBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const importModal = document.getElementById('importModal');
        const importData = document.getElementById('importData');
        const confirmImportBtn = document.getElementById('confirmImportBtn');
        const importClose = document.querySelectorAll('.import-close');
        const opencvStatus = document.getElementById('opencvStatus');
        const tesseractStatus = document.getElementById('tesseractStatus');
        const aiModelStatus = document.getElementById('aiModelStatus');
        const advancedModeToggle = document.getElementById('advancedModeToggle');
        const aiResults = document.getElementById('aiResults');
        const aiResultsList = document.getElementById('aiResultsList');
        
// ì²˜ë¦¬ ë‹¨ê³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateProcessingStep(step) {
    processingStep = step;
    
    // ëª¨ë“  ë‹¨ê³„ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
    const stepElements = document.querySelectorAll('.step');
    if (stepElements.length === 0) return; // ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨
    
    stepElements.forEach(el => {
        el.classList.remove('active', 'completed', 'current');
    });
    
    // í˜„ì¬ ë‹¨ê³„ê¹Œì§€ í™œì„±í™”
    const steps = ['capture', 'preprocess', 'ocr', 'extract', 'review'];
    const currentIndex = steps.indexOf(step);
    
    if (currentIndex >= 0) {
        for (let i = 0; i < steps.length; i++) {
            const el = document.querySelector(`.step[data-step="${steps[i]}"]`);
            if (el) { // ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                if (i < currentIndex) {
                    el.classList.add('completed');
                } else if (i === currentIndex) {
                    el.classList.add('current');
                }
            }
        }
    }
}


        // ë³€ìˆ˜ ì¶”ê°€
        let isCardDetectionActive = false;
        let cardDetectionTimer = null;
        let lastDetectionResult = null;
        let realTimeBoundaryDetection = true;
        
        // ì–¸ì–´ ì„ íƒ
        let selectedLanguage = 'kor';
        
        // ì„¤ì • ê°ì²´
        let appSettings = {
            tesseractParams: "tessedit_char_whitelist=ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.,-@+():;/'\" \npreserve_interword_spaces=1\ntessedit_pageseg_mode=4\ntextord_tabfind_force_vertical_text=0\ntextord_tablefind_recognize_tables=0",
            imageQuality: "0.8",
            showRawOcr: false,
            autoPreprocess: true,
            useAI: true,
            psm: "4"
        };
        
        // ì „ì—­ ë³€ìˆ˜
        let tesseractWorker = null;
        let useModel = null;
        let isOpencvReady = false;
        let isTesseractReady = false;
        let isAiModelReady = false;
        let isModelLoading = false;
        let isAdvancedMode = false;
        
        // íƒ­ ê´€ë ¨ ë³€ìˆ˜
        const tabs = document.querySelectorAll('.tab');
        const contents = document.querySelectorAll('.content');
        
        // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ëª…í•¨ ID
        let currentEditId = null;
        
        // ì›ë³¸ ì´ë¯¸ì§€ ë°ì´í„° ì €ì¥
        let originalImageData = null;
        
        // í˜„ì¬ ì´ë¯¸ì§€ íšŒì „ ê°ë„
        let currentRotation = 0;
        
        // ì²˜ë¦¬ ë‹¨ê³„ ì§„í–‰ ìƒíƒœ
        let processingStep = 'capture';
        
        // OCR ê²°ê³¼ ì €ì¥ìš© ë³€ìˆ˜
        let lastOcrResult = null;
        
        // ëª…í•¨ ë°ì´í„° ë³€ìˆ˜
        let businessCards = [];
        
        // OpenCV ëª¨ë“ˆ ë¡œë“œ ì²´í¬
        function onOpenCvReady() {
            isOpencvReady = true;
            opencvStatus.textContent = "OpenCV.js ë¡œë“œ ì™„ë£Œ";
            opencvStatus.style.color = "#155724";
            checkAllModulesReady();
        }
        
        // OpenCV ëª¨ë“ˆ ì´ˆê¸°í™”
        window.onOpenCvReady = onOpenCvReady;
        
        // ëª¨ë¸ ë¡œë”© í•¨ìˆ˜
        async function loadUSEModel() {
            if (useModel) return useModel;
            if (isModelLoading) return null;
            
            isModelLoading = true;
            try {
                aiModelStatus.innerHTML = '<div class="spinner"></div> AI ë¶„ì„ ëª¨ë¸ ë¡œë”© ì¤‘...';
                
                // TensorFlow.jsì™€ ëª¨ë¸ì„ ì§ì ‘ ë™ì ìœ¼ë¡œ ë¡œë“œ
                try {
                    // ëª¨ë¸ì„ ë™ì ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
                    useModel = await tf.loadGraphModel('https://tfhub.dev/tensorflow/tfjs-model/universal-sentence-encoder-lite/1/default/1', { fromTFHub: true });
                    
                    isAiModelReady = true;
                    aiModelStatus.textContent = "AI ëª¨ë¸ ì¤€ë¹„ ì™„ë£Œ";
                    aiModelStatus.style.color = "#155724";
                    
                    checkAllModulesReady();
                    return useModel;
                } catch (loadError) {
                    console.error('ëª¨ë¸ ë¡œë“œ ì˜¤ë¥˜:', loadError);
                    throw loadError;
                }
            } catch (error) {
                console.error('AI ëª¨ë¸ ë¡œë”© ì˜¤ë¥˜:', error);
                aiModelStatus.textContent = "AI ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨ - ì¼ë°˜ ë¶„ì„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤";
                aiModelStatus.style.color = "#721c24";
                
                // AI ê¸°ëŠ¥ ë¹„í™œì„±í™”
                appSettings.useAI = false;
                localStorage.setItem('appSettings', JSON.stringify(appSettings));
                
                return null;
            } finally {
                isModelLoading = false;
            }
        }
        
        // í…ìŠ¤íŠ¸ ìœ ì‚¬ë„ ë¹„êµ í•¨ìˆ˜
        async function findMostSimilarCategory(text, categories) {
            try {
                const model = await loadUSEModel();
                if (!model) return null;
                
                // AI ëª¨ë¸ ì—†ì´ ê°„ë‹¨í•œ ê·œì¹™ ê¸°ë°˜ ë¶„ì„ìœ¼ë¡œ ëŒ€ì²´
                // ê° ì¹´í…Œê³ ë¦¬ í‚¤ì›Œë“œì— ëŒ€í•œ ì¼ì¹˜ ì ìˆ˜ ê³„ì‚°
                const scores = {};
                const lowerText = text.toLowerCase();
                
                Object.keys(categories).forEach(category => {
                    const examples = categories[category].toLowerCase().split(' ');
                    let score = 0;
                    
                    // ë‹¨ì–´ ì¼ì¹˜ ê²€ìƒ‰
                    examples.forEach(example => {
                        if (lowerText.includes(example)) {
                            score += example.length; // ê¸´ ë‹¨ì–´ì— ë” ë†’ì€ ì ìˆ˜
                        }
                    });
                    
                    // íŠ¹ì • íŒ¨í„´ ê²€ì‚¬ (ì´ë©”ì¼, ì „í™”ë²ˆí˜¸ ë“±)
                    if (category === "ì´ë©”ì¼" && /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g.test(text)) {
                        score += 100;
                    } else if (category === "ì „í™”ë²ˆí˜¸" && /(?:\+?\d{1,4}[\s-]?)?(?:\(?\d{2,4}\)?[\s-]?)?\d{3,4}[\s-]?\d{3,4}/g.test(text)) {
                        score += 100;
                    } else if (category === "ì›¹ì‚¬ì´íŠ¸" && /(?:https?:\/\/)?(?:www\.)?[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+/g.test(text)) {
                        score += 100;
                    }
                    
                    scores[category] = score;
                });
                
                // ìµœê³  ì ìˆ˜ ì¹´í…Œê³ ë¦¬ ì°¾ê¸°
                let bestCategory = null;
                let highestScore = 0;
                
                Object.keys(scores).forEach(category => {
                    if (scores[category] > highestScore) {
                        highestScore = scores[category];
                        bestCategory = category;
                    }
                });
                
                // ìœ ì‚¬ë„ ì ìˆ˜ ì •ê·œí™” (0-1 ë²”ìœ„ë¡œ)
                const normalizedScore = highestScore > 0 ? Math.min(highestScore / 100, 1) : 0;
                
                return { 
                    category: bestCategory, 
                    similarity: normalizedScore 
                };
            } catch (error) {
                console.error('ìœ ì‚¬ë„ ë¶„ì„ ì˜¤ë¥˜:', error);
                return null;
            }
        }
        
        // ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ê³„ì‚°
        function cosineSimilarity(a, b) {
            let dotProduct = 0;
            let normA = 0;
            let normB = 0;
            
            for (let i = 0; i < a.length; i++) {
                dotProduct += a[i] * b[i];
                normA += a[i] * a[i];
                normB += b[i] * b[i];
            }
            
            normA = Math.sqrt(normA);
            normB = Math.sqrt(normB);
            
            return dotProduct / (normA * normB);
        }
        
        // Tesseract ì´ˆê¸°í™”
        async function initTesseract() {
            try {
                tesseractStatus.innerHTML = '<div class="spinner"></div> Tesseract ì—”ì§„ ì´ˆê¸°í™” ì¤‘...';
                
                // ê¸°ì¡´ ì›Œì»¤ê°€ ìˆìœ¼ë©´ ì¢…ë£Œ
                if (tesseractWorker) {
                    await tesseractWorker.terminate();
                }
                
                // ìƒˆ ì›Œì»¤ ìƒì„±
                tesseractWorker = await Tesseract.createWorker({
                    logger: progress => {
                        if (progress.status === 'downloading') {
                            tesseractStatus.innerHTML = `<div class="spinner"></div> ì–¸ì–´ ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì¤‘: ${Math.round(progress.progress * 100)}%`;
                        } else if (progress.status === 'recognizing text') {
                            const percentage = Math.round(progress.progress * 100);
                            progressBarFill.style.width = `${percentage}%`;
                        }
                    }
                });
                
                // í•œêµ­ì–´ ë¡œë“œ
                await tesseractWorker.loadLanguage('kor');
                await tesseractWorker.initialize('kor');
                
                // PSM ì„¤ì •
                const psmValue = parseInt(appSettings.psm || "4");
                await tesseractWorker.setParameters({
                    preserve_interword_spaces: '1',
                    tessedit_pageseg_mode: psmValue.toString()
                });
                
                // ì„¤ì •ì—ì„œ í…Œì„œë ‰íŠ¸ íŒŒë¼ë¯¸í„° ë¡œë“œ
                if (appSettings.tesseractParams) {
                    const params = parseTesseractParams(appSettings.tesseractParams);
                    if (Object.keys(params).length > 0) {
                        await tesseractWorker.setParameters(params);
                    }
                }
                
                isTesseractReady = true;
                tesseractStatus.textContent = "Tesseract ì—”ì§„ ì¤€ë¹„ ì™„ë£Œ";
tesseractStatus.style.color = "#155724";
                checkAllModulesReady();
                
            } catch (error) {
                console.error('Tesseract ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                tesseractStatus.textContent = "Tesseract ì´ˆê¸°í™” ì‹¤íŒ¨ - ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”";
                tesseractStatus.style.color = "#721c24";
            }
        }
        
        // ëª¨ë“  ëª¨ë“ˆ ì¤€ë¹„ í™•ì¸
        function checkAllModulesReady() {
            if (isOpencvReady && isTesseractReady) {
                // UI í™œì„±í™”
                accessCameraBtn.disabled = false;
                uploadBtn.disabled = false;
                
                // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                showStatus('ëª¨ë“  ê¸°ë³¸ ëª¨ë“ˆì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ëª…í•¨ì„ ì´¬ì˜í•˜ê±°ë‚˜ ì—…ë¡œë“œí•˜ì„¸ìš”.', 'success');
                
                // ìƒíƒœ í‘œì‹œ ìˆ¨ê¸°ê¸° (3ì´ˆ í›„)
                setTimeout(() => {
                    opencvStatus.style.display = 'none';
                    tesseractStatus.style.display = 'none';
                    
                    if (isAiModelReady) {
                        aiModelStatus.style.display = 'none';
                    }
                }, 3000);
            }
        }
        
        // Tesseract íŒŒë¼ë¯¸í„° íŒŒì‹±
        function parseTesseractParams(paramsStr) {
            const params = {};
            const lines = paramsStr.split('\n');
            
            for (const line of lines) {
                const trimmedLine = line.trim();
                if (trimmedLine && !trimmedLine.startsWith('#')) {
                    const [key, value] = trimmedLine.split('=');
                    if (key && value !== undefined) {
                        params[key.trim()] = value.trim();
                    }
                }
            }
            
            return params;
        }
        
        // ì–¸ì–´ë³„ ì¸ì‹ ì„¤ì •
        const languageMap = {
            'kor': { 
                lang: 'kor',
                label: 'í•œêµ­ì–´',
                keywords: {
                    company: ['ì£¼ì‹íšŒì‚¬', '(ì£¼)', 'ãˆœ', 'ê¸°ì—…', 'ê·¸ë£¹', 'ì—°êµ¬ì†Œ', 'í•™êµ', 'ëŒ€í•™êµ', 'ìœ í•œíšŒì‚¬', 'ì¬ë‹¨', 'í˜‘íšŒ', 'ì„¼í„°', 'ê³µì‚¬', 'ì€í–‰'],
                    position: ['ëŒ€í‘œ', 'ì‚¬ì¥', 'ì´ì‚¬', 'ë¶€ì¥', 'ì°¨ì¥', 'ê³¼ì¥', 'ëŒ€ë¦¬', 'ì‚¬ì›', 'ì—°êµ¬ì›', 'ì±…ì„', 'ì„ ì„', 'ìˆ˜ì„', 'íŒ€ì¥', 'ë§¤ë‹ˆì €', 'ì»¨ì„¤í„´íŠ¸', 'ë³€í˜¸ì‚¬', 'êµìˆ˜', 'ì›ì¥', 'ì†Œì¥', 'ì‹¤ì¥', 'ì „ë¬¸ê°€', 'ëŒ€í‘œì´ì‚¬', 'ë¶€ì‚¬ì¥', 'ì „ë¬´', 'ìƒë¬´', 'ì„¼í„°ì¥', 'íŒ€ì¥', 'êµì‚¬', 'ê°•ì‚¬'],
                    department: ['ë¶€', 'íŒ€', 'ê³¼', 'ì‹¤', 'ë³¸ë¶€', 'ì„¼í„°', 'ì—°êµ¬ì†Œ', 'ì‚¬ì—…ë¶€', 'ì˜ì—…', 'ë§ˆì¼€íŒ…', 'ê°œë°œ', 'ê¸°íš', 'ì¸ì‚¬', 'ì´ë¬´', 'ì¬ë¬´', 'íšŒê³„', 'ê´€ë¦¬', 'ìƒì‚°', 'í’ˆì§ˆ', 'R&D', 'ë¹„ì„œ', 'ë²•ë¬´', 'í™ë³´', 'êµìœ¡', 'ì„œë¹„ìŠ¤', 'ê³ ê°', 'ì§€ì›'],
                    contactKeywords: ['ì „í™”', 'íœ´ëŒ€í°', 'í•¸ë“œí°', 'ëª¨ë°”ì¼', 'ì—°ë½ì²˜', 'Tel', 'Mobile', 'íŒ©ìŠ¤', 'Fax', 'ì´ë©”ì¼', 'Email', 'e-mail', 'ë©”ì¼', 'ì£¼ì†Œ', 'Address', 'í™ˆí˜ì´ì§€', 'ì›¹ì‚¬ì´íŠ¸', 'Website', 'Homepage', 'http', 'www'],
                    emailRegex: /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,
                    phoneRegex: /(?:(?:\+|00)?82|0)?[ -]?(?:(?:(?:1[0-9]|[2-6][1-3]|70)[ -]?[0-9]{3,4})|(?:50[1-9])[ -]?[0-9]{2,3})[ -]?[0-9]{4}$/
                }
            },
            'eng': { 
                lang: 'eng',
                label: 'ì˜ì–´',
                keywords: {
                    company: ['Inc.', 'LLC', 'Corp', 'Corporation', 'Company', 'Co.', 'Ltd', 'Limited', 'Group', 'Institute', 'University', 'College', 'Association', 'Foundation', 'Society', 'Partners', 'Consultants', 'Agency', 'Bank', 'Industries', 'International', 'Systems', 'Solutions', 'Services'],
                    position: ['CEO', 'CTO', 'CFO', 'COO', 'President', 'Director', 'Manager', 'Executive', 'Associate', 'Assistant', 'Specialist', 'Engineer', 'Consultant', 'Analyst', 'Officer', 'Supervisor', 'Coordinator', 'Representative', 'Developer', 'Designer', 'Chief', 'Lead', 'Senior', 'Junior', 'VP', 'Head', 'Partner', 'Founder', 'Chairman', 'Principal', 'Attorney', 'Lawyer', 'Doctor', 'Professor'],
                    department: ['Department', 'Division', 'Team', 'Group', 'Unit', 'R&D', 'HR', 'Sales', 'Marketing', 'Finance', 'IT', 'Development', 'Engineering', 'Support', 'Service', 'Operations', 'Accounting', 'Administration', 'Management', 'Legal', 'Communications', 'Research', 'Production', 'Quality', 'Procurement', 'Customer', 'Product', 'Business', 'Corporate'],
                    contactKeywords: ['Tel', 'Phone', 'Mobile', 'Cell', 'Contact', 'Fax', 'Email', 'E-mail', 'Mail', 'Address', 'Website', 'Homepage', 'Web', 'URL', 'http', 'www'],
                    emailRegex: /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,
                    phoneRegex: /(?:\+?1[-\s\.]?)?\(?([0-9]{3})\)?[-\s\.]?([0-9]{3})[-\s\.]?([0-9]{4})/g
                }
            },
            'jpn': { 
                lang: 'jpn',
                label: 'ì¼ë³¸ì–´',
                keywords: {
                    company: ['æ ªå¼ä¼šç¤¾', '(æ ª)', 'æœ‰é™ä¼šç¤¾', 'å›£ä½“', 'ã‚°ãƒ«ãƒ¼ãƒ—', 'ç ”ç©¶æ‰€', 'å­¦æ ¡', 'å¤§å­¦', 'è²¡å›£', 'å”ä¼š', 'ã‚»ãƒ³ã‚¿ãƒ¼', 'å…¬ç¤¾', 'éŠ€è¡Œ', 'åˆåŒä¼šç¤¾', 'ç›¸äº’ä¼šç¤¾', 'ä¼æ¥­', 'äº‹å‹™æ‰€'],
                    position: ['ä»£è¡¨', 'ç¤¾é•·', 'å–ç· å½¹', 'éƒ¨é•·', 'èª²é•·', 'ä¿‚é•·', 'ä¸»ä»»', 'ç¤¾å“¡', 'ç ”ç©¶å“¡', 'ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼', 'ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ', 'æ•™æˆ', 'è¬›å¸«', 'ç§˜æ›¸', 'å°‚é–€å®¶', 'å¼è­·å£«', 'åŒ»å¸«', 'æŠ€å¸«', 'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢', 'ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼', 'ãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼', 'ãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼', 'ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ã‚¿ãƒ¼'],
                    department: ['éƒ¨', 'èª²', 'ãƒãƒ¼ãƒ ', 'æœ¬éƒ¨', 'ã‚»ãƒ³ã‚¿ãƒ¼', 'ç ”ç©¶æ‰€', 'äº‹æ¥­éƒ¨', 'å–¶æ¥­', 'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°', 'é–‹ç™º', 'ä¼ç”»', 'äººäº‹', 'ç·å‹™', 'è²¡å‹™', 'çµŒç†', 'ç®¡ç†', 'ç”Ÿç”£', 'å“è³ª', 'èª¿é”', 'è³¼è²·', 'ã‚«ã‚¹ã‚¿ãƒãƒ¼', 'é¡§å®¢', 'ã‚µãƒãƒ¼ãƒˆ', 'ã‚µãƒ¼ãƒ“ã‚¹'],
                    contactKeywords: ['é›»è©±', 'Tel', 'æºå¸¯', 'Mobile', 'ãƒ•ã‚¡ãƒƒã‚¯ã‚¹', 'Fax', 'ãƒ¡ãƒ¼ãƒ«', 'Email', 'E-mail', 'ä½æ‰€', 'Address', 'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ', 'ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸', 'Website', 'Homepage', 'http', 'www'],
                    emailRegex: /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,
                    phoneRegex: /(?:(?:\+?81)|0)[-\s]?(?:[1-9]0(?:[1-9]|0)|\d{2}|\d{1})[-\s]?\d{4}[-\s]?\d{4}/g
                }
            },
            'chi_sim': { 
                lang: 'chi_sim',
                label: 'ì¤‘êµ­ì–´',
                keywords: {
                    company: ['æœ‰é™å…¬å¸', 'è‚¡ä»½å…¬å¸', 'å…¬å¸', 'é›†å›¢', 'ç ”ç©¶æ‰€', 'å­¦æ ¡', 'å¤§å­¦', 'åŸºé‡‘ä¼š', 'åä¼š', 'ä¸­å¿ƒ', 'é“¶è¡Œ', 'ä¼ä¸š', 'äº‹åŠ¡æ‰€', 'å·¥ä½œå®¤', 'åˆä¼™äºº', 'å·¥å‚', 'åˆ¶é€ '],
                    position: ['æ€»è£', 'è‘£äº‹é•¿', 'æ€»ç»ç†', 'ç»ç†', 'ä¸»ç®¡', 'ä¸»ä»»', 'èŒå‘˜', 'ç ”ç©¶å‘˜', 'é¡¾é—®', 'ä¸“å®¶', 'å·¥ç¨‹å¸ˆ', 'è®¾è®¡å¸ˆ', 'æ€»ç›‘', 'å‰¯æ€»', 'æ‰§è¡Œå®˜', 'å¾‹å¸ˆ', 'åŒ»ç”Ÿ', 'æ•™æˆ', 'è®²å¸ˆ', 'åŠ©ç†', 'ä¸»å¸­', 'ç§˜ä¹¦', 'è´Ÿè´£äºº'],
                    department: ['éƒ¨', 'ç»„', 'ç§‘', 'å¤„', 'ä¸­å¿ƒ', 'ç ”ç©¶æ‰€', 'äº‹ä¸šéƒ¨', 'é”€å”®', 'å¸‚åœº', 'å¼€å‘', 'ç­–åˆ’', 'äººäº‹', 'è¡Œæ”¿', 'è´¢åŠ¡', 'ä¼šè®¡', 'ç®¡ç†', 'ç”Ÿäº§', 'å“è´¨', 'é‡‡è´­', 'å®¢æˆ·', 'æœåŠ¡', 'æ”¯æŒ', 'æŠ€æœ¯', 'æ³•åŠ¡', 'å®£ä¼ ', 'æ•™è‚²'],
                    contactKeywords: ['ç”µè¯', 'Tel', 'æ‰‹æœº', 'Mobile', 'ä¼ çœŸ', 'Fax', 'ç”µå­é‚®ä»¶', 'Email', 'E-mail', 'é‚®ç®±', 'åœ°å€', 'Address', 'ç½‘ç«™', 'Website', 'ä¸»é¡µ', 'Homepage', 'http', 'www'],
                    emailRegex: /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,
                    phoneRegex: /(?:\+?86)?[-\s]?(?:(?:1[3-9][0-9]))[-\s]?[0-9]{4}[-\s]?[0-9]{4}|(?:\d{3,4})[-\s]?(?:\d{7,8})/g
                }
            },
            'multi': { 
                lang: 'kor+eng+jpn+chi_sim',
                label: 'ë‹¤êµ­ì–´',
                keywords: {
                    company: [
                        // í•œêµ­ì–´
                        'ì£¼ì‹íšŒì‚¬', '(ì£¼)', 'ãˆœ', 'ê¸°ì—…', 'ê·¸ë£¹', 'ì—°êµ¬ì†Œ', 'í•™êµ', 'ëŒ€í•™êµ', 'ìœ í•œíšŒì‚¬', 'ì¬ë‹¨', 'í˜‘íšŒ', 'ì„¼í„°', 'ê³µì‚¬', 'ì€í–‰',
                        // ì˜ì–´
                        'Inc.', 'LLC', 'Corp', 'Corporation', 'Company', 'Co.', 'Ltd', 'Limited', 'Group', 'Institute', 'University', 'College', 'Association', 'Foundation', 'Society', 'Partners', 'Consultants', 'Agency', 'Bank',
                        // ì¼ë³¸ì–´
                        'æ ªå¼ä¼šç¤¾', '(æ ª)', 'æœ‰é™ä¼šç¤¾', 'å›£ä½“', 'ã‚°ãƒ«ãƒ¼ãƒ—', 'ç ”ç©¶æ‰€', 'å­¦æ ¡', 'å¤§å­¦', 'è²¡å›£', 'å”ä¼š', 'ã‚»ãƒ³ã‚¿ãƒ¼', 'å…¬ç¤¾', 'éŠ€è¡Œ',
                        // ì¤‘êµ­ì–´
                        'æœ‰é™å…¬å¸', 'è‚¡ä»½å…¬å¸', 'å…¬å¸', 'é›†å›¢', 'ç ”ç©¶æ‰€', 'å­¦æ ¡', 'å¤§å­¦', 'åŸºé‡‘ä¼š', 'åä¼š', 'ä¸­å¿ƒ', 'é“¶è¡Œ'
                    ],
                    position: [
                        // í•œêµ­ì–´
                        'ëŒ€í‘œ', 'ì‚¬ì¥', 'ì´ì‚¬', 'ë¶€ì¥', 'ì°¨ì¥', 'ê³¼ì¥', 'ëŒ€ë¦¬', 'ì‚¬ì›', 'ì—°êµ¬ì›', 'ì±…ì„', 'ì„ ì„', 'ìˆ˜ì„', 'íŒ€ì¥', 'ë§¤ë‹ˆì €', 'ì»¨ì„¤í„´íŠ¸', 'ë³€í˜¸ì‚¬', 'êµìˆ˜', 'ì›ì¥', 'ì†Œì¥',
                        // ì˜ì–´
                        'CEO', 'CTO', 'CFO', 'COO', 'President', 'Director', 'Manager', 'Executive', 'Associate', 'Assistant', 'Specialist', 'Engineer', 'Consultant', 'Analyst', 'Officer', 'Supervisor', 'Coordinator', 'Representative', 'Developer', 'Designer',
                        // ì¼ë³¸ì–´
                        'ä»£è¡¨', 'ç¤¾é•·', 'å–ç· å½¹', 'éƒ¨é•·', 'èª²é•·', 'ä¿‚é•·', 'ä¸»ä»»', 'ç¤¾å“¡', 'ç ”ç©¶å“¡', 'ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼', 'ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ', 'æ•™æˆ', 'è¬›å¸«',
                        // ì¤‘êµ­ì–´
                        'æ€»è£', 'è‘£äº‹é•¿', 'æ€»ç»ç†', 'ç»ç†', 'ä¸»ç®¡', 'ä¸»ä»»', 'èŒå‘˜', 'ç ”ç©¶å‘˜', 'é¡¾é—®', 'ä¸“å®¶', 'å·¥ç¨‹å¸ˆ', 'è®¾è®¡å¸ˆ', 'æ€»ç›‘'
                    ],
                    department: [
                        // í•œêµ­ì–´
'ë¶€', 'íŒ€', 'ê³¼', 'ì‹¤', 'ë³¸ë¶€', 'ì„¼í„°', 'ì—°êµ¬ì†Œ', 'ì‚¬ì—…ë¶€', 'ì˜ì—…', 'ë§ˆì¼€íŒ…', 'ê°œë°œ', 'ê¸°íš', 'ì¸ì‚¬', 'ì´ë¬´', 'ì¬ë¬´', 'íšŒê³„', 'ê´€ë¦¬', 'ìƒì‚°', 'í’ˆì§ˆ',
                        // ì˜ì–´
                        'Department', 'Division', 'Team', 'Group', 'Unit', 'R&D', 'HR', 'Sales', 'Marketing', 'Finance', 'IT', 'Development', 'Engineering', 'Support', 'Service', 'Operations', 'Accounting', 'Administration', 'Management',
                        // ì¼ë³¸ì–´
                        'éƒ¨', 'èª²', 'ãƒãƒ¼ãƒ ', 'æœ¬éƒ¨', 'ã‚»ãƒ³ã‚¿ãƒ¼', 'ç ”ç©¶æ‰€', 'äº‹æ¥­éƒ¨', 'å–¶æ¥­', 'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°', 'é–‹ç™º', 'ä¼ç”»', 'äººäº‹', 'ç·å‹™', 'è²¡å‹™', 'çµŒç†',
                        // ì¤‘êµ­ì–´
                        'éƒ¨', 'ç»„', 'ç§‘', 'å¤„', 'ä¸­å¿ƒ', 'ç ”ç©¶æ‰€', 'äº‹ä¸šéƒ¨', 'é”€å”®', 'å¸‚åœº', 'å¼€å‘', 'ç­–åˆ’', 'äººäº‹', 'è¡Œæ”¿', 'è´¢åŠ¡', 'ä¼šè®¡'
                    ],
                    contactKeywords: [
                        // í•œêµ­ì–´
                        'ì „í™”', 'íœ´ëŒ€í°', 'í•¸ë“œí°', 'ëª¨ë°”ì¼', 'íŒ©ìŠ¤', 'ì´ë©”ì¼', 'ë©”ì¼', 'ì£¼ì†Œ', 'í™ˆí˜ì´ì§€', 'ì›¹ì‚¬ì´íŠ¸',
                        // ì˜ì–´
                        'Tel', 'Phone', 'Mobile', 'Cell', 'Fax', 'Email', 'E-mail', 'Mail', 'Address', 'Website', 'Homepage',
                        // ì¼ë³¸ì–´
                        'é›»è©±', 'æºå¸¯', 'ãƒ•ã‚¡ãƒƒã‚¯ã‚¹', 'ãƒ¡ãƒ¼ãƒ«', 'ä½æ‰€', 'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ', 'ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸',
                        // ì¤‘êµ­ì–´
                        'ç”µè¯', 'æ‰‹æœº', 'ä¼ çœŸ', 'ç”µå­é‚®ä»¶', 'é‚®ç®±', 'åœ°å€', 'ç½‘ç«™', 'ä¸»é¡µ',
                        // ê³µí†µ
                        'http', 'www'
                    ],
                    emailRegex: /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,
                    // í†µí•© ì „í™”ë²ˆí˜¸ íŒ¨í„´
                    phoneRegex: /(?:(?:\+|00)?82|0)?[ -]?(?:(?:(?:1[0-9]|[2-6][1-3]|70)[ -]?[0-9]{3,4})|(?:50[1-9])[ -]?[0-9]{2,3})[ -]?[0-9]{4}$|(?:\+?1[-\s\.]?)?\(?([0-9]{3})\)?[-\s\.]?([0-9]{3})[-\s\.]?([0-9]{4})|(?:(?:\+?81)|0)[-\s]?(?:[1-9]0(?:[1-9]|0)|\d{2}|\d{1})[-\s]?\d{4}[-\s]?\d{4}|(?:\+?86)?[-\s]?(?:(?:1[3-9][0-9]))[-\s]?[0-9]{4}[-\s]?[0-9]{4}|(?:\d{3,4})[-\s]?(?:\d{7,8})/g
                }
            }
        };
        
        // ì„¤ì • ë¡œë“œ
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('appSettings');
                if (savedSettings) {
                    appSettings = JSON.parse(savedSettings);
                    
                    // ì„¤ì • í¼ì— ê°’ ì„¤ì •
                    tesseractParams.value = appSettings.tesseractParams || '';
                    imageQuality.value = appSettings.imageQuality || '0.8';
                    showRawOcr.checked = appSettings.showRawOcr || false;
                    autoPreprocess.checked = appSettings.autoPreprocess !== false;
                    useAI.checked = appSettings.useAI !== false;
                    psm.value = appSettings.psm || '4';
                    
                    // ì‹¤ì‹œê°„ ëª…í•¨ ê°ì§€ ì„¤ì •
                    realTimeBoundaryDetection = appSettings.realTimeBoundaryDetection !== false;
                    
                    // ëª…í•¨ ê°ì§€ í† ê¸€ ì„¤ì • ì¶”ê°€
                    setTimeout(addCardDetectionToggle, 500);
                }
            } catch (error) {
                console.error('ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', error);
                // ê¸°ë³¸ ì„¤ì • ìœ ì§€
            }
        }
        
        // ì„¤ì • ì €ì¥
        function saveSettings() {
            try {
                appSettings.tesseractParams = tesseractParams.value;
                appSettings.imageQuality = imageQuality.value;
                appSettings.showRawOcr = showRawOcr.checked;
                appSettings.autoPreprocess = autoPreprocess.checked;
                appSettings.useAI = useAI.checked;
                appSettings.psm = psm.value;
                
                localStorage.setItem('appSettings', JSON.stringify(appSettings));
                showStatus('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                
                // Tesseract ì›Œì»¤ ì¬ì´ˆê¸°í™” (ì„¤ì • ë³€ê²½ ì ìš©)
                initTesseract();
                
            } catch (error) {
                console.error('ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', error);
                showStatus('ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        // ì„¤ì • ì´ˆê¸°í™”
        function resetSettings() {
            if (confirm('ëª¨ë“  ì„¤ì •ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                appSettings = {
                    tesseractParams: "tessedit_char_whitelist=ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.,-@+():;/'\" \npreserve_interword_spaces=1\ntessedit_pageseg_mode=4\ntextord_tabfind_force_vertical_text=0\ntextord_tablefind_recognize_tables=0",
                    imageQuality: "0.8",
                    showRawOcr: false,
                    autoPreprocess: true,
                    useAI: true,
                    psm: "4",
                    realTimeBoundaryDetection: true
                };
                
                // ì„¤ì • í¼ ì´ˆê¸°í™”
                tesseractParams.value = appSettings.tesseractParams;
                imageQuality.value = appSettings.imageQuality;
                showRawOcr.checked = appSettings.showRawOcr;
                autoPreprocess.checked = appSettings.autoPreprocess;
                useAI.checked = appSettings.useAI;
                psm.value = appSettings.psm;
                
                // ì‹¤ì‹œê°„ ê°ì§€ ì„¤ì •
                if (document.getElementById('cardDetectionToggle')) {
                    document.getElementById('cardDetectionToggle').checked = true;
                }
                realTimeBoundaryDetection = true;
                
                // ì„¤ì • ì €ì¥ ë° Tesseract ì¬ì´ˆê¸°í™”
                localStorage.setItem('appSettings', JSON.stringify(appSettings));
                showStatus('ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                
                // Tesseract ì›Œì»¤ ì¬ì´ˆê¸°í™”
                initTesseract();
            }
        }
        
        // ì–¸ì–´ ì„ íƒ ì´ë²¤íŠ¸
        languageButtons.forEach(btn => {
            btn.addEventListener('click', async () => {
                // ì´ì „ í™œì„±í™”ëœ ë²„íŠ¼ ë¹„í™œì„±í™”
                document.querySelector('.language-btn.active').classList.remove('active');
                
                // í˜„ì¬ ë²„íŠ¼ í™œì„±í™”
                btn.classList.add('active');
                
                // ì„ íƒëœ ì–¸ì–´ ì„¤ì •
                const newLanguage = btn.getAttribute('data-lang');
                
                // ì–¸ì–´ê°€ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ ì²˜ë¦¬
                if (selectedLanguage !== newLanguage) {
                    selectedLanguage = newLanguage;
                    
                    // Tesseract ì›Œì»¤ ì–¸ì–´ ë³€ê²½
                    await changeTesseractLanguage(selectedLanguage);
                }
            });
        });
        
        // Tesseract ì–¸ì–´ ë³€ê²½ í•¨ìˆ˜
        async function changeTesseractLanguage(langCode) {
            try {
                showStatus(`${languageMap[langCode].label} ì–¸ì–´ ëª¨ë¸ ë¡œë“œ ì¤‘...`, 'info');
                
                // ì–¸ì–´ ë³€ê²½
                // Tesseract.js v4ì—ì„œëŠ” ì–¸ì–´ ë³€ê²½ ë°©ë²•ì´ ë‹¤ë¦„
                try {
                    await tesseractWorker.loadLanguage(languageMap[langCode].lang);
                    await tesseractWorker.initialize(languageMap[langCode].lang);
                    
                    // íŒŒë¼ë¯¸í„° ë‹¤ì‹œ ì„¤ì •
                    const psmValue = parseInt(appSettings.psm || "4");
                    await tesseractWorker.setParameters({
                        preserve_interword_spaces: '1',
                        tessedit_pageseg_mode: psmValue.toString()
                    });
                    
                    // ì„¤ì •ì—ì„œ í…Œì„œë ‰íŠ¸ íŒŒë¼ë¯¸í„° ë¡œë“œ
                    if (appSettings.tesseractParams) {
                        const params = parseTesseractParams(appSettings.tesseractParams);
                        if (Object.keys(params).length > 0) {
                            await tesseractWorker.setParameters(params);
                        }
                    }
                } catch (error) {
                    console.error('ì–¸ì–´ ë³€ê²½ ì¤‘ ì˜¤ë¥˜:', error);
                    // ì‹¤íŒ¨ ì‹œ ì›Œì»¤ ì¬ìƒì„± ì‹œë„
                    await tesseractWorker.terminate();
                    tesseractWorker = await Tesseract.createWorker();
                    await tesseractWorker.loadLanguage(languageMap[langCode].lang);
                    await tesseractWorker.initialize(languageMap[langCode].lang);
                    
                    // íŒŒë¼ë¯¸í„° ë‹¤ì‹œ ì„¤ì •
                    const psmValue = parseInt(appSettings.psm || "4");
                    await tesseractWorker.setParameters({
                        preserve_interword_spaces: '1',
                        tessedit_pageseg_mode: psmValue.toString()
                    });
                }
                
                showStatus(`${languageMap[langCode].label} ì–¸ì–´ ëª¨ë¸ ë¡œë“œ ì™„ë£Œ`, 'success');
            } catch (error) {
                console.error('ì–¸ì–´ ë³€ê²½ ì˜¤ë¥˜:', error);
                showStatus('ì–¸ì–´ ëª¨ë¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        // íƒ­ ì „í™˜ ì´ë²¤íŠ¸
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.getAttribute('data-tab');
                
                // íƒ­ í™œì„±í™”
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // ì½˜í…ì¸  í™œì„±í™”
                contents.forEach(content => {
                    content.classList.remove('active');
                });
                
                document.getElementById(targetTab + 'Content').classList.add('active');
                
                // ëŒ€ì‹œë³´ë“œ íƒ­ í´ë¦­ ì‹œ ëª…í•¨ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                if (targetTab === 'dashboard') {
                    renderCardList();
                }
            });
        });
        
        // ê³ ê¸‰ ëª¨ë“œ í† ê¸€
        advancedModeToggle.addEventListener('change', function() {
            isAdvancedMode = this.checked;
            
            // ê³ ê¸‰ ëª¨ë“œì— ë”°ë¼ UI ìš”ì†Œ í‘œì‹œ/ìˆ¨ê¹€
            if (isAdvancedMode) {
                if (rawOcrResult) rawOcrResult.style.display = 'block';
                advancedBtn.style.display = 'inline-block';
                if (aiResults) aiResults.style.display = 'block';
            } else {
                if (rawOcrResult) rawOcrResult.style.display = 'none';
                if (preprocessingOptions.style.display !== 'none') {
                    preprocessingOptions.style.display = 'none';
                    advancedBtn.textContent = 'ê³ ê¸‰ ì˜µì…˜';
                }
                advancedBtn.style.display = 'none';
                if (aiResults) aiResults.style.display = 'none';
            }
        });
        
        // ì¹´ë©”ë¼ ì ‘ê·¼ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ìˆ˜ì •
        accessCameraBtn.addEventListener('click', async () => {
            try {
                // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ê°€ì ¸ì˜¤ê¸° ì „ì— ì´ì „ ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
                if (video.srcObject) {
                    const tracks = video.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                }
                
                // ì¹´ë©”ë¼ ì ‘ê·¼ ìš”ì²­ (ê³ í•´ìƒë„ ì˜µì…˜ ì¶”ê°€)
                const constraints = {
                    audio: false,
                    video: {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1920 },  // ê³ í•´ìƒë„ë¡œ ë³€ê²½
                        height: { ideal: 1080 }, // ê³ í•´ìƒë„ë¡œ ë³€ê²½
                        frameRate: { ideal: 30 },
                        focusMode: { ideal: 'continuous' }, // ì—°ì† ìë™ ì´ˆì 
                        exposureMode: { ideal: 'continuous' }, // ì—°ì† ìë™ ë…¸ì¶œ
                        whiteBalanceMode: { ideal: 'continuous' } // ì—°ì† ìë™ í™”ì´íŠ¸ë°¸ëŸ°ìŠ¤
                    }
                };
                
                console.log('ê³ ê¸‰ ì¹´ë©”ë¼ ì ‘ê·¼ ìš”ì²­ ì¤‘...');
                
                try {
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    console.log('ê³ ê¸‰ ì¹´ë©”ë¼ ì ‘ê·¼ ì„±ê³µ!', stream);
                    setupCameraStream(stream);
                } catch (advancedError) {
                    console.warn('ê³ ê¸‰ ì¹´ë©”ë¼ ê¸°ëŠ¥ ì ‘ê·¼ ì‹¤íŒ¨, ê¸°ë³¸ ëª¨ë“œë¡œ ì‹œë„í•©ë‹ˆë‹¤.', advancedError);
                    
                    // ê¸°ë³¸ ì˜µì…˜ìœ¼ë¡œ ë‹¤ì‹œ ì‹œë„
                    const basicConstraints = {
                        audio: false,
                        video: {
                            facingMode: { ideal: 'environment' }
                        }
                    };
                    
                    const basicStream = await navigator.mediaDevices.getUserMedia(basicConstraints);
                    console.log('ê¸°ë³¸ ì¹´ë©”ë¼ ì ‘ê·¼ ì„±ê³µ', basicStream);
                    setupCameraStream(basicStream);
                }
                
            } catch (error) {
                console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜:', error);
                showStatus(`ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜: ${error.name} - ${error.message}. íŒŒì¼ ì—…ë¡œë“œë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš”.`, 'error');
            }
        });
        
        // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì„¤ì • í•¨ìˆ˜
        function setupCameraStream(stream) {
            // ë¹„ë””ì˜¤ì— ìŠ¤íŠ¸ë¦¼ ì—°ê²°
            video.srcObject = stream;
            video.style.display = 'block';
            
            // ëª…í•¨ ìŠ¤ìº” ê°€ì´ë“œ í‘œì‹œ
            document.getElementById('cardScanningGuide').style.display = 'block';
            
            // ë²„íŠ¼ í‘œì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
            captureBtn.style.display = 'inline-block';
            accessCameraBtn.style.display = 'none';
            
            // í’ˆì§ˆ ì§€í‘œ í‘œì‹œ
            document.getElementById('qualityIndicators').style.display = 'block';
            
            showStatus('ì¹´ë©”ë¼ ì ‘ê·¼ ì„±ê³µ! ëª…í•¨ì„ ê°€ì´ë“œ ì˜ì—­ì— ë§ì¶°ì£¼ì„¸ìš”.', 'success');
            
            // ì‹¤ì‹œê°„ ëª…í•¨ ê°ì§€ ì‹œì‘ (ë¹„ë””ì˜¤ê°€ ë¡œë“œëœ í›„)
            video.onloadedmetadata = () => {
                // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // ì‹¤ì‹œê°„ ëª…í•¨ ê°ì§€ ì‹œì‘ (ì„¤ì •ì— ë”°ë¼)
                if (realTimeBoundaryDetection) {
                    startRealTimeCardDetection();
                }
                

// ì²˜ë¦¬ ë‹¨ê³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜


                // ì²˜ë¦¬ ë‹¨ê³„ ì—…ë°ì´íŠ¸
                updateProcessingStep('capture');
            };
        }
        
        // íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        uploadBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
        fileInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = (event) => {
                    // ì´ë¯¸ì§€ í‘œì‹œ
                    capturedImage.src = event.target.result;
                    capturedImage.style.display = 'block';
                    
                    // ì›ë³¸ ì´ë¯¸ì§€ ì €ì¥
                    originalImageData = event.target.result;
                    
                    // UI ì—…ë°ì´íŠ¸
                    video.style.display = 'none';
                    accessCameraBtn.style.display = 'none';
                    captureBtn.style.display = 'none';
                    retakeBtn.style.display = 'inline-block';
                    analyzeBtn.style.display = 'inline-block';
                    improveImageBtn.style.display = 'inline-block';
                    rotateButtons.style.display = 'flex';
                    
                    // ëª…í•¨ ê°ì§€ ê°€ì´ë“œ ìˆ¨ê¸°ê¸°
                    document.getElementById('cardScanningGuide').style.display = 'none';
                    
                    // ê³ ê¸‰ ëª¨ë“œë©´ ê³ ê¸‰ ì˜µì…˜ ë²„íŠ¼ í‘œì‹œ
                    if (isAdvancedMode) {
                        advancedBtn.style.display = 'inline-block';
                    }
                    
                    // íšŒì „ ê°ë„ ì´ˆê¸°í™”
                    currentRotation = 0;
                    
                    // ì²˜ë¦¬ ë‹¨ê³„ í‘œì‹œ
                    stepsIndicator.style.display = 'flex';
                    updateProcessingStep('preprocess');
                    
                    showStatus('ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ë¶„ì„ì„ ì‹œì‘í•˜ë ¤ë©´ "ëª…í•¨ ë¶„ì„" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.', 'success');
                    
                    // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ì—ì„œ ëª…í•¨ ê²½ê³„ ê°ì§€ ì‹œë„
                    detectBusinessCardBoundaries(event.target.result)
                        .then(result => {
                            if (result.success) {
                                lastDetectionResult = result;
                                showStatus('ëª…í•¨ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¶„ì„ ì§„í–‰ ì‹œ ê²½ê³„ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.', 'success');
                            }
                        })
                        .catch(error => {
                            console.error('ì—…ë¡œë“œ ì´ë¯¸ì§€ ëª…í•¨ ê°ì§€ ì˜¤ë¥˜:', error);
                        });
                };
                
                reader.onerror = (error) => {
                    console.error('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
                    showStatus('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                };
                
                reader.readAsDataURL(file);
            }
        });
        
        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            
            // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±°
            statusMessage.classList.remove('info', 'success', 'error');
            
            // ìƒˆ í´ë˜ìŠ¤ ì¶”ê°€
            statusMessage.classList.add(type);
            
            // ë©”ì‹œì§€ í‘œì‹œ
            statusMessage.style.display = 'block';
            
            // ì„±ê³µ ë©”ì‹œì§€ëŠ” 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¹€
            if (type === 'success') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 3000);
            }
        }
        
        // ëª…í•¨ ë°ì´í„° ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadBusinessCards() {
            try {
                const savedCards = localStorage.getItem('businessCards');
                
                if (savedCards) {
                    businessCards = JSON.parse(savedCards);
                    renderCardList();
                }
            } catch (error) {
                console.error('ì €ì¥ëœ ëª…í•¨ ë¡œë“œ ì˜¤ë¥˜:', error);
                showStatus('ì €ì¥ëœ ëª…í•¨ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                businessCards = []; // ì˜¤ë¥˜ ì‹œ ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”
            }
        }
        
        // ëª…í•¨ ë°ì´í„° ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
        function saveBusinessCards() {
            try {
                localStorage.setItem('businessCards', JSON.stringify(businessCards));
            } catch (error) {
                console.error('ëª…í•¨ ì €ì¥ ì˜¤ë¥˜:', error);
                showStatus('ëª…í•¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        // ë°ì´í„° ë‚´ë³´ë‚´ê¸° í•¨ìˆ˜
        function exportData() {
            try {
                const dataStr = JSON.stringify(businessCards, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                const exportFileDefaultName = 'business_cards_' + new Date().toISOString().slice(0, 10) + '.json';
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showStatus('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!', 'success');
            } catch (error) {
                console.error('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                showStatus('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        // ê°€ì ¸ì˜¤ê¸° ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
        function openImportModal() {
            importData.value = '';
            importModal.style.display = 'block';
        }
        
        // JSON ë°ì´í„° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
        function importDataFromJson() {
            try {
                const jsonData = importData.value.trim();
                
                if (!jsonData) {
                    throw new Error('ê°€ì ¸ì˜¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                const parsedData = JSON.parse(jsonData);
                
                if (!Array.isArray(parsedData)) {
                    throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤. JSON ë°°ì—´ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                }
                
                if (confirm('ê¸°ì¡´ ë°ì´í„°ë¥¼ ìƒˆ ë°ì´í„°ë¡œ ëŒ€ì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? "ì·¨ì†Œ"ë¥¼ ì„ íƒí•˜ë©´ ê¸°ì¡´ ë°ì´í„°ì— ì¶”ê°€ë©ë‹ˆë‹¤.')) {
                    // ê¸°ì¡´ ë°ì´í„° ëŒ€ì²´
                    businessCards = parsedData;
                } else {
                    // ê¸°ì¡´ ë°ì´í„°ì— ì¶”ê°€
                    businessCards = businessCards.concat(parsedData);
                }
                
                // ë°ì´í„° ì €ì¥ ë° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                saveBusinessCards();
                renderCardList();
                
                // ëª¨ë‹¬ ë‹«ê¸°
                importModal.style.display = 'none';
                
                showStatus(`${parsedData.length}ê°œì˜ ëª…í•¨ ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.`, 'success');
            } catch (error) {
                console.error('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                showStatus(`ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™” í•¨ìˆ˜
        function clearAllData() {
            if (confirm('ëª¨ë“  ëª…í•¨ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                businessCards = [];
                saveBusinessCards();
                renderCardList();
                showStatus('ëª¨ë“  ëª…í•¨ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }
        
        // ëª…í•¨ ëª©ë¡ ë Œë”ë§
        function renderCardList(filterText = '') {
            let filteredCards = businessCards;
            
            // ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ í•„í„°ë§
            if (filterText) {
                const searchTerms = filterText.toLowerCase().split(' ');
                
                filteredCards = businessCards.filter(card => {
                    const cardText = (
                        (card.name || '') + ' ' + 
                        (card.company || '') + ' ' + 
                        (card.position || '') + ' ' + 
                        (card.department || '') + ' ' + 
                        (card.phone || '') + ' ' + 
                        (card.email || '') + ' ' + 
                        (card.website || '') + ' ' + 
                        (card.address || '') + ' ' + 
                        (card.notes || '')
                    ).toLowerCase();
                    
                    return searchTerms.every(term => cardText.includes(term));
                });
            }
            
            // ë¹ˆ ìƒíƒœ ì²˜ë¦¬
            if (filteredCards.length === 0) {
                cardList.innerHTML = '';
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
                
                cardList.innerHTML = filteredCards.map((card, index) => `
                    <div class="card-item" data-id="${card.id}">
                        <h3>${card.name || 'ì´ë¦„ ì—†ìŒ'}</h3>
                        <div class="card-details">
                            <p><strong>íšŒì‚¬:</strong> ${card.company || '-'}</p>
                            <p><strong>ì§ì±…:</strong> ${card.position || '-'}</p>
                            <p><strong>ë¶€ì„œ:</strong> ${card.department || '-'}</p>
                            <p><strong>ì „í™”:</strong> ${card.phone || '-'}</p>
                            <p><strong>ì´ë©”ì¼:</strong> ${card.email || '-'}</p>
                            ${card.website ? `<p><strong>ì›¹ì‚¬ì´íŠ¸:</strong> ${card.website}</p>` : ''}
                            <p><strong>ì£¼ì†Œ:</strong> ${card.address || '-'}</p>
                            <p><strong>ë“±ë¡ì¼:</strong> ${new Date(card.registeredDate).toLocaleDateString()}</p>
                            ${card.notes ? `<p><strong>ë©”ëª¨:</strong> ${card.notes}</p>` : ''}
                        </div>
                        <div class="card-actions">
                            <button class="edit-btn" data-id="${card.id}">ìˆ˜ì •</button>
                            <button class="delete-btn" data-id="${card.id}">ì‚­ì œ</button>
                        </div>
                    </div>
                `).join('');
                
                // ìˆ˜ì • ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.target.getAttribute('data-id');
                        openEditModal(id);
                    });
                });
                
                // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.target.getAttribute('data-id');
                        deleteBusinessCard(id);
                    });
                });
            }
        }
        
        // ê²€ìƒ‰ ê¸°ëŠ¥
        searchInput.addEventListener('input', (e) => {
            renderCardList(e.target.value);
        });
        
        // ëª…í•¨ ì™¸ê³½ ì¸ì‹ ë° í’ˆì§ˆ íŒë‹¨ í•¨ìˆ˜
        async function detectBusinessCardBoundaries(imageUrl) {
            return new Promise((resolve, reject) => {
                try {
                    if (!isOpencvReady) {
                        resolve({
                            success: false,
                            message: "OpenCVê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê¸°ë³¸ ëª¨ë“œë¡œ ì§„í–‰í•©ë‹ˆë‹¤.",
                            qualityIssues: []
                        });
                        return;
                    }
                    
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    img.onload = function() {
                        try {
                            // 1. ì´ë¯¸ì§€ë¥¼ Matìœ¼ë¡œ ë¡œë“œ
                            const src = cv.imread(img);
                            const width = src.cols;
                            const height = src.rows;
                            
                            // ì¤‘ê°„ ê²°ê³¼ë¬¼ ì €ì¥ìš© ìº”ë²„ìŠ¤ ìƒì„±
                            const debugCanvas = document.createElement('canvas');
                            debugCanvas.width = width;
                            debugCanvas.height = height;
                            
                            // í’ˆì§ˆ ì´ìŠˆ ëª©ë¡
                            const qualityIssues = [];
                            
                            // 2. ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ë³€í™˜
                            const gray = new cv.Mat();
                            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                            
                            // 3. ë°ê¸° ë° ëŒ€ë¹„ ë¶„ì„
                            const mean = cv.mean(gray);
                            const brightness = mean[0]; // í‰ê·  ë°ê¸°
                            
                            let brightnessProblem = false;
                            if (brightness < 50) {
                                brightnessProblem = true;
                                qualityIssues.push({
                                    type: "brightness_low",
                                    message: "ì´ë¯¸ì§€ê°€ ë„ˆë¬´ ì–´ë‘¡ìŠµë‹ˆë‹¤. ë°ì€ ê³³ì—ì„œ ì´¬ì˜í•´ì£¼ì„¸ìš”.",
                                    severity: "high"
                                });
                            } else if (brightness > 200) {
                                brightnessProblem = true;
                                qualityIssues.push({
                                    type: "brightness_high",
                                    message: "ì´ë¯¸ì§€ê°€ ë„ˆë¬´ ë°ìŠµë‹ˆë‹¤. ë…¸ì¶œì„ ì¤„ì´ê³  ë‹¤ì‹œ ì´¬ì˜í•´ì£¼ì„¸ìš”.",
                                    severity: "high"
                                });
                            }
                            
                            // ëŒ€ë¹„ ë¶„ì„ (í‘œì¤€í¸ì°¨ ê³„ì‚°)
                            let stdDev = new cv.Mat();
                            let mean_stdDev = new cv.Mat();
                            cv.meanStdDev(gray, mean_stdDev, stdDev);
                            const contrast = stdDev.data64F[0];
                            
                            if (contrast < 30) {
                                qualityIssues.push({
                                    type: "contrast_low",
                                    message: "ì´ë¯¸ì§€ ëŒ€ë¹„ê°€ ë‚®ìŠµë‹ˆë‹¤. ëª…í•¨ê³¼ ë°°ê²½ì˜ ìƒ‰ìƒ ì°¨ì´ê°€ í° í™˜ê²½ì—ì„œ ì´¬ì˜í•´ì£¼ì„¸ìš”.",
                                    severity: "medium"
                                });
                            }
                            
                            // 4. ê°€ìš°ì‹œì•ˆ ë¸”ëŸ¬ ì ìš© (ë…¸ì´ì¦ˆ ì œê±°)
                            const blurred = new cv.Mat();
                            cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0);
                            
                            // 5. ìºë‹ˆ ì—£ì§€ ê²€ì¶œ
                            const edges = new cv.Mat();
                            cv.Canny(blurred, edges, 75, 200);
                            
                            // ì—£ì§€ ë””ë²„ê·¸ìš© ì´ë¯¸ì§€
                            const edgeCanvas = document.createElement('canvas');
                            cv.imshow(edgeCanvas, edges);
                            
                            // 6. ì—£ì§€ ê°•í™” (íŒ½ì°½)
                            const dilated = new cv.Mat();
                            const M = cv.Mat.ones(3, 3, cv.CV_8U);
                            cv.dilate(edges, dilated, M);
                            
                            // 7. ì»¨íˆ¬ì–´ ì°¾ê¸°
                            const contours = new cv.MatVector();
                            const hierarchy = new cv.Mat();
                            cv.findContours(dilated, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
                            
                            // 8. ê°€ì¥ í° ì»¨íˆ¬ì–´ ì°¾ê¸° (ëª…í•¨ í›„ë³´)
                            let maxArea = 0;
                            let maxContourIndex = -1;
                            
                            for (let i = 0; i < contours.size(); ++i) {
                                const contour = contours.get(i);
                                const area = cv.contourArea(contour);
                                
                                // ë„ˆë¬´ ì‘ì€ ì»¨íˆ¬ì–´ëŠ” ë¬´ì‹œ (ë…¸ì´ì¦ˆ ì œê±°)
                                if (area > 1000) {
                                    if (area > maxArea) {
                                        maxArea = area;
                                        maxContourIndex = i;
                                    }
                                }
                            }
                            
                            // 9. ë¶„ì„ ê²°ê³¼ ì¤€ë¹„
                            let result = {
                                success: false,
                                message: "ëª…í•¨ì„ ê°ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëª…í•¨ì´ í”„ë ˆì„ ë‚´ì— ì™„ì „íˆ ë³´ì´ë„ë¡ ë‹¤ì‹œ ì´¬ì˜í•´ì£¼ì„¸ìš”.",
                                qualityIssues: qualityIssues,
                                debugImage: edgeCanvas.toDataURL('image/png', 0.7)
                            };
                            
                            // ì „ì²´ ì´ë¯¸ì§€ í¬ê¸° ëŒ€ë¹„ ì»¨íˆ¬ì–´ í¬ê¸° ë¹„ìœ¨
                            const totalImageArea = width * height;
                            
                            // 10. ëª…í•¨ ì»¨íˆ¬ì–´ê°€ ë°œê²¬ëœ ê²½ìš°
                            if (maxContourIndex >= 0) {
                                const cardContour = contours.get(maxContourIndex);
                                
// ìµœì†Œ ì‚¬ê°í˜• ì–»ê¸°
const rotatedRect = cv.minAreaRect(cardContour);
let cornerPointsData;
try {
    cornerPointsData = cv.boxPoints(rotatedRect);
} catch (e) {
    // ëŒ€ì²´ í•¨ìˆ˜ ì‚¬ìš©
    cornerPointsData = boxPoints(rotatedRect);
}

// íšŒì „ëœ ì‚¬ê°í˜•ì˜ ë„¤ ê¼­ì§€ì  ì¢Œí‘œ
const cardCorners = [];
for (let i = 0; i < 4; i++) {
    cardCorners.push({
        x: cornerPointsData.data32F[i*2],
        y: cornerPointsData.data32F[i*2+1]
    });
}
                                
                                // ëª…í•¨ í¬ê¸° ê³„ì‚°
                                const boxWidth = rotatedRect.size.width;
                                const boxHeight = rotatedRect.size.height;
                                const cardArea = boxWidth * boxHeight;
                                const cardRatio = cardArea / totalImageArea;
                                
                                // ëª…í•¨ ë¹„ìœ¨ í™•ì¸ (ëª…í•¨ì€ ë³´í†µ ê°€ë¡œì„¸ë¡œ ë¹„ìœ¨ì´ 1.5~1.8 ì •ë„)
                                const widthHeightRatio = Math.max(boxWidth, boxHeight) / Math.min(boxWidth, boxHeight);
                                
                                // ê²°ê³¼ ìº”ë²„ìŠ¤ì— ëª…í•¨ ì™¸ê³½ì„  ê·¸ë¦¬ê¸°
                                const visualizedResult = new cv.Mat.zeros(height, width, cv.CV_8UC4);
                                
                                // ì›ë³¸ ì´ë¯¸ì§€ ë³µì‚¬
                                src.copyTo(visualizedResult);
                                
                                // ì»¨íˆ¬ì–´ ê·¸ë¦¬ê¸°
                                const contourColor = new cv.Scalar(0, 255, 0, 255); // ë…¹ìƒ‰
                                const thickness = 3;
                                const fourPoints = new cv.Mat(4, 1, cv.CV_32SC2);
                                
// ë°•ìŠ¤ í¬ì¸íŠ¸ë¥¼ ì •ìˆ˜í˜•ìœ¼ë¡œ ë³€í™˜
for (let i = 0; i < 4; i++) {
    fourPoints.data32S[i*2] = Math.round(cornerPointsData.data32F[i*2]);
    fourPoints.data32S[i*2+1] = Math.round(cornerPointsData.data32F[i*2+1]);
}
                                
                                // ì‚¬ê°í˜• ê·¸ë¦¬ê¸°
                                for (let i = 0; i < 4; i++) {
                                    cv.line(
                                        visualizedResult,
                                        new cv.Point(fourPoints.data32S[i*2], fourPoints.data32S[i*2+1]),
                                        new cv.Point(fourPoints.data32S[((i+1)%4)*2], fourPoints.data32S[((i+1)%4)*2+1]),
                                        contourColor,
                                        thickness
                                    );
                                }
                                
                                // ê¼­ì§€ì ì— ì› ê·¸ë¦¬ê¸°
                                for (let i = 0; i < 4; i++) {
                                    cv.circle(
                                        visualizedResult,
                                        new cv.Point(fourPoints.data32S[i*2], fourPoints.data32S[i*2+1]),
                                        7,
                                        new cv.Scalar(255, 0, 0, 255), // ë¹¨ê°„ìƒ‰
                                        -1 // ì±„ìš°ê¸°
                                    );
                                }
                                
                                // í’ˆì§ˆ ì´ìŠˆ ì¶”ê°€
                                
                                // 1. ëª…í•¨ ë¹„ìœ¨ í™•ì¸
                                if (widthHeightRatio < 1.3 || widthHeightRatio > 1.9) {
                                    qualityIssues.push({
                                        type: "card_ratio_abnormal",
                                        message: "ëª…í•¨ì˜ í˜•íƒœê°€ ì¼ë°˜ì ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. ëª…í•¨ì´ ì¹´ë©”ë¼ì™€ í‰í–‰í•˜ê²Œ ë†“ì—¬ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.",
                                        severity: "medium"
                                    });
                                }
                                
                                // 2. ëª…í•¨ í¬ê¸° í™•ì¸ (í™”ë©´ ëŒ€ë¹„)
                                if (cardRatio < 0.2) {
                                    qualityIssues.push({
                                        type: "card_too_small",
                                        message: "ëª…í•¨ì´ ë„ˆë¬´ ì‘ê²Œ ë³´ì…ë‹ˆë‹¤. ì¹´ë©”ë¼ë¥¼ ëª…í•¨ì— ë” ê°€ê¹Œì´ ëŒ€ì£¼ì„¸ìš”.",
                                        severity: "high"
                                    });
                                } else if (cardRatio > 0.9) {
                                    qualityIssues.push({
                                        type: "card_too_large",
                                        message: "ëª…í•¨ì´ ë„ˆë¬´ í¬ê²Œ ë³´ì…ë‹ˆë‹¤. ì „ì²´ ëª…í•¨ì´ í™”ë©´ì— ë“¤ì–´ì˜¤ë„ë¡ ì¡°ì •í•´ì£¼ì„¸ìš”.",
                                        severity: "high"
                                    });
                                }
                                
                                // 3. ëª…í•¨ ìœ„ì¹˜ í™•ì¸ (ì¤‘ì•™ì— ìˆëŠ”ì§€)
                                const centerX = width / 2;
                                const centerY = height / 2;
                                
                                // ëª…í•¨ ì¤‘ì•™ì  ê³„ì‚°
                                let cardCenterX = 0;
                                let cardCenterY = 0;
                                
                                for (let i = 0; i < 4; i++) {
                                    cardCenterX += fourPoints.data32S[i*2];
                                    cardCenterY += fourPoints.data32S[i*2+1];
                                }
                                cardCenterX /= 4;
                                cardCenterY /= 4;
                                
                                // ì¤‘ì•™ì  í¸ì°¨ ê³„ì‚°
                                const distFromCenter = Math.sqrt(
                                    Math.pow(cardCenterX - centerX, 2) + 
                                    Math.pow(cardCenterY - centerY, 2)
                                );
                                
                                // ì¤‘ì•™ì—ì„œ 20% ì´ìƒ ë²—ì–´ë‚˜ë©´ ê²½ê³ 
                                if (distFromCenter > width * 0.2) {
                                    qualityIssues.push({
                                        type: "card_not_centered",
                                        message: "ëª…í•¨ì´ ì¤‘ì•™ì— ìœ„ì¹˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ëª…í•¨ì„ í™”ë©´ ì¤‘ì•™ì— ë§ì¶°ì£¼ì„¸ìš”.",
                                        severity: "medium"
                                    });
                                }
                                
                                // 4. ëª¨ì„œë¦¬ê°€ í™”ë©´ ë°”ê¹¥ìœ¼ë¡œ ë‚˜ê°”ëŠ”ì§€ í™•ì¸
                                let cornersOutside = false;
                                for (let i = 0; i < 4; i++) {
                                    const x = fourPoints.data32S[i*2];
                                    const y = fourPoints.data32S[i*2+1];
                                    
                                    if (x <= 5 || x >= width-5 || y <= 5 || y >= height-5) {
                                        cornersOutside = true;
                                        break;
                                    }
                                }
                                
                                if (cornersOutside) {
                                    qualityIssues.push({
                                        type: "card_outside_frame",
                                        message: "ëª…í•¨ì˜ ì¼ë¶€ê°€ í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°”ìŠµë‹ˆë‹¤. ì „ì²´ ëª…í•¨ì´ í™”ë©´ì— ë“¤ì–´ì˜¤ë„ë¡ ì¡°ì •í•´ì£¼ì„¸ìš”.",
                                        severity: "high"
                                    });
                                }
                                
                                // 5. ì´ˆì  íë¦¼ í™•ì¸ (ë¼í”Œë¼ì‹œì•ˆ í•„í„°ë¥¼ ì‚¬ìš©í•œ ë³€ëŸ‰ ì¸¡ì •)
                                const laplacian = new cv.Mat();
                                cv.Laplacian(gray, laplacian, cv.CV_64F);
                                let laplacianMean = new cv.Mat();
                                let laplacianStdDev = new cv.Mat();
                                cv.meanStdDev(laplacian, laplacianMean, laplacianStdDev);
                                const variance = laplacianStdDev.data64F[0] * laplacianStdDev.data64F[0];
                                
                                if (variance < 100) {
                                    qualityIssues.push({
                                        type: "image_blurry",
                                        message: "ì´ë¯¸ì§€ê°€ íë¦¿í•©ë‹ˆë‹¤. ì¹´ë©”ë¼ ì´ˆì ì„ ëª…í•¨ì— ë§ì¶”ê³  í”ë“¤ë¦¼ ì—†ì´ ì´¬ì˜í•´ì£¼ì„¸ìš”.",
                                        severity: "high"
                                    });
                                }
                                
                                // ë¹„ì£¼ì–¼ ê²°ê³¼ ì¶œë ¥
                                cv.imshow(debugCanvas, visualizedResult);
                                
                                // ê²°ê³¼ ë°˜í™˜
                                result = {
                                    success: true,
                                    message: qualityIssues.length > 0 
                                        ? "ëª…í•¨ì´ ê°ì§€ë˜ì—ˆì§€ë§Œ ëª‡ ê°€ì§€ í’ˆì§ˆ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤." 
                                        : "ëª…í•¨ì´ ì •ìƒì ìœ¼ë¡œ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.",
                                    corners: cardCorners,
                                    angle: rotatedRect.angle,
                                    width: boxWidth,
                                    height: boxHeight,
                                    area: cardArea,
                                    ratio: widthHeightRatio,
                                    qualityIssues: qualityIssues,
                                    visualizedImage: debugCanvas.toDataURL('image/png', 0.8),
                                    debugImage: edgeCanvas.toDataURL('image/png', 0.7)
                                };
                                
                                // ë©”ëª¨ë¦¬ í•´ì œ
                                fourPoints.delete();
                                laplacian.delete();
                                laplacianMean.delete();
                                laplacianStdDev.delete();
                            } else {
                                // ëª…í•¨ì´ ë°œê²¬ë˜ì§€ ì•Šì€ ê²½ìš°
                                qualityIssues.push({
                                    type: "no_card_detected",
                                    message: "ëª…í•¨ì„ ê°ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°ì€ ë°°ê²½ì— ëª…í•¨ì„ ë†“ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
                                    severity: "critical"
                                });
                            }
                            
                            // ë©”ëª¨ë¦¬ í•´ì œ
                            src.delete();
                            gray.delete();
                            blurred.delete();
                            edges.delete();
                            dilated.delete();
                            contours.delete();
                            hierarchy.delete();
                            stdDev.delete();
                            mean_stdDev.delete();
                            M.delete();
                            
                            resolve(result);
                            
                        } catch (error) {
                            console.error('ëª…í•¨ ì™¸ê³½ì„  ê°ì§€ ì¤‘ ì˜¤ë¥˜:', error);
                            reject(error);
                        }
                    };
                    
                    img.onerror = function(error) {
                        reject(new Error('ì´ë¯¸ì§€ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
                    };
                    
                    img.src = imageUrl;
                    
                } catch (error) {
                    console.error('ëª…í•¨ ê°ì§€ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                    reject(error);
                }
            });
        }
        
        // ì‹¤ì‹œê°„ ëª…í•¨ ê°ì§€ ì‹œì‘ í•¨ìˆ˜
        function startRealTimeCardDetection() {
            if (isCardDetectionActive) return;
            
            isCardDetectionActive = true;
            
            // ëª…í•¨ ê°ì§€ ê°€ì´ë“œ í‘œì‹œ
            const cardGuide = document.getElementById('cardScanningGuide');
            cardGuide.style.display = 'block';
            
            // ê°ì§€ íƒ€ì´ë¨¸ ì„¤ì • (200ms ê°„ê²©)
            cardDetectionTimer = setInterval(async () => {
                if (!video.srcObject || video.paused || video.ended) {
                    // ë¹„ë””ì˜¤ê°€ ì¬ìƒ ì¤‘ì´ ì•„ë‹ˆë©´ ê°ì§€ ì¤‘ì§€
                    stopRealTimeCardDetection();
                    return;
                }
                
                try {
                    // í˜„ì¬ í”„ë ˆì„ì„ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // ìº”ë²„ìŠ¤ ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ URLë¡œ ë³€í™˜
                    const imageData = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // ëª…í•¨ ì™¸ê³½ì„  ê°ì§€
                    const result = await detectBusinessCardBoundaries(imageData);
                    lastDetectionResult = result;
                    
                    // í’ˆì§ˆ ì§€í‘œ ì—…ë°ì´íŠ¸
                    updateQualityIndicators(result);
                    
                    // ê°ì§€ ê²°ê³¼ì— ë”°ë¼ ì•ˆë‚´ ë©”ì‹œì§€ ë° ê°€ì´ë“œ ì—…ë°ì´íŠ¸
                    updateDetectionGuide(result);
                    
                } catch (error) {
                    console.error('ì‹¤ì‹œê°„ ëª…í•¨ ê°ì§€ ì˜¤ë¥˜:', error);
                }
            }, 200); // 200ms ê°„ê²©ìœ¼ë¡œ ê°ì§€ (ì„±ëŠ¥ê³¼ ì •í™•ë„ì˜ ê· í˜•)
        }
        
        // ì‹¤ì‹œê°„ ëª…í•¨ ê°ì§€ ì¤‘ì§€ í•¨ìˆ˜
function stopRealTimeCardDetection() {
            if (!isCardDetectionActive) return;
            
            // íƒ€ì´ë¨¸ ì¤‘ì§€
            if (cardDetectionTimer) {
                clearInterval(cardDetectionTimer);
                cardDetectionTimer = null;
            }
            
            isCardDetectionActive = false;
            
            // ëª…í•¨ ê°€ì´ë“œ ìˆ¨ê¸°ê¸°
            const cardGuide = document.getElementById('cardScanningGuide');
            cardGuide.style.display = 'none';
        }
        
        // í’ˆì§ˆ ì§€í‘œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateQualityIndicators(result) {
            if (!result) return;
            
            const brightnessIndicator = document.getElementById('brightnessIndicator');
            const sharpnessIndicator = document.getElementById('sharpnessIndicator');
            const alignmentIndicator = document.getElementById('alignmentIndicator');
            
            const brightnessValue = document.getElementById('brightnessValue');
            const sharpnessValue = document.getElementById('sharpnessValue');
            const alignmentValue = document.getElementById('alignmentValue');
            
            // í’ˆì§ˆ ìƒì„¸ ì •ë³´ ì—…ë°ì´íŠ¸
            const qualityDetailsList = document.getElementById('qualityDetailsList');
            
            if (result.success) {
                // í’ˆì§ˆ ì§€í‘œ ê³„ì‚°
                let brightnessScore = 100;
                let sharpnessScore = 100;
                let alignmentScore = 100;
                
                // í’ˆì§ˆ ì´ìŠˆì— ë”°ë¥¸ ì ìˆ˜ ì¡°ì •
                result.qualityIssues.forEach(issue => {
                    if (issue.type.includes('brightness')) {
                        brightnessScore -= (issue.severity === 'critical' ? 80 : 
                                          issue.severity === 'high' ? 50 : 
                                          issue.severity === 'medium' ? 30 : 10);
                    } else if (issue.type.includes('blurry')) {
                        sharpnessScore -= (issue.severity === 'critical' ? 80 : 
                                         issue.severity === 'high' ? 50 : 
                                         issue.severity === 'medium' ? 30 : 10);
                    } else if (issue.type.includes('card_not_centered') || 
                             issue.type.includes('card_outside_frame') ||
                             issue.type.includes('card_ratio')) {
                        alignmentScore -= (issue.severity === 'critical' ? 80 : 
                                        issue.severity === 'high' ? 50 : 
                                        issue.severity === 'medium' ? 30 : 10);
                    }
                });
                
                // ì ìˆ˜ ë²”ìœ„ ì¡°ì • (0-100)
                brightnessScore = Math.max(0, Math.min(100, brightnessScore));
                sharpnessScore = Math.max(0, Math.min(100, sharpnessScore));
                alignmentScore = Math.max(0, Math.min(100, alignmentScore));
                
                // ì§€í‘œ í‘œì‹œ ì—…ë°ì´íŠ¸
                brightnessIndicator.style.width = `${brightnessScore}%`;
                sharpnessIndicator.style.width = `${sharpnessScore}%`;
                alignmentIndicator.style.width = `${alignmentScore}%`;
                
                brightnessValue.textContent = `${brightnessScore}%`;
                sharpnessValue.textContent = `${sharpnessScore}%`;
                alignmentValue.textContent = `${alignmentScore}%`;
                
                // ìƒ‰ìƒ ì—…ë°ì´íŠ¸
                brightnessIndicator.style.backgroundColor = getColorForScore(brightnessScore);
                sharpnessIndicator.style.backgroundColor = getColorForScore(sharpnessScore);
                alignmentIndicator.style.backgroundColor = getColorForScore(alignmentScore);
                
                // í’ˆì§ˆ ìƒì„¸ ì •ë³´ ì—…ë°ì´íŠ¸
                qualityDetailsList.innerHTML = '';
                if (result.qualityIssues.length > 0) {
                    result.qualityIssues.forEach(issue => {
                        const issueItem = document.createElement('div');
                        issueItem.style.marginBottom = '5px';
                        
                        // ì‹¬ê°ë„ì— ë”°ë¥¸ ìƒ‰ìƒ
                        const severityColor = 
                            issue.severity === 'critical' ? '#dc3545' :
                            issue.severity === 'high' ? '#ffc107' : 
                            issue.severity === 'medium' ? '#fd7e14' : '#28a745';
                        
                        issueItem.innerHTML = `
                            <span style="display: inline-block; width: 12px; height: 12px; background-color: ${severityColor}; border-radius: 50%; margin-right: 5px;"></span>
                            ${issue.message}
                        `;
                        qualityDetailsList.appendChild(issueItem);
                    });
                } else {
                    qualityDetailsList.innerHTML = '<div style="color: #28a745;">ëª…í•¨ í’ˆì§ˆì´ ìš°ìˆ˜í•©ë‹ˆë‹¤. ì´¬ì˜í•´ì£¼ì„¸ìš”!</div>';
                }
                
                // ì¡°ëª… ìƒíƒœ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
                updateLightingIndicator(brightnessScore);
                
            } else {
                // ê°ì§€ ì‹¤íŒ¨ ì‹œ ëª¨ë“  ì§€í‘œ ë‚®ê²Œ ì„¤ì •
                brightnessIndicator.style.width = '30%';
                sharpnessIndicator.style.width = '30%';
                alignmentIndicator.style.width = '30%';
                
                brightnessValue.textContent = '30%';
                sharpnessValue.textContent = '30%';
                alignmentValue.textContent = '30%';
                
                brightnessIndicator.style.backgroundColor = '#dc3545';
                sharpnessIndicator.style.backgroundColor = '#dc3545';
                alignmentIndicator.style.backgroundColor = '#dc3545';
                
                // í’ˆì§ˆ ìƒì„¸ ì •ë³´ ì—…ë°ì´íŠ¸
                qualityDetailsList.innerHTML = '<div style="color: #dc3545;">ëª…í•¨ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ëª…í•¨ì„ ê°€ì´ë“œ ì˜ì—­ì— ë§ì¶°ì£¼ì„¸ìš”.</div>';
                
                // ì´ìŠˆê°€ ìˆë‹¤ë©´ ì¶”ê°€
                if (result.qualityIssues && result.qualityIssues.length > 0) {
                    result.qualityIssues.forEach(issue => {
                        const issueItem = document.createElement('div');
                        issueItem.style.marginBottom = '5px';
                        issueItem.innerHTML = `
                            <span style="display: inline-block; width: 12px; height: 12px; background-color: #dc3545; border-radius: 50%; margin-right: 5px;"></span>
                            ${issue.message}
                        `;
                        qualityDetailsList.appendChild(issueItem);
                    });
                }
                
                // ì¡°ëª… ìƒíƒœ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
                updateLightingIndicator(30);
            }
        }
        
        // ì ìˆ˜ì— ë”°ë¥¸ ìƒ‰ìƒ ë°˜í™˜ í•¨ìˆ˜
        function getColorForScore(score) {
            if (score >= 80) return '#28a745'; // ë…¹ìƒ‰ (ì¢‹ìŒ)
            if (score >= 60) return '#fd7e14'; // ì£¼í™©ìƒ‰ (ë³´í†µ)
            if (score >= 40) return '#ffc107'; // ë…¸ë€ìƒ‰ (ì£¼ì˜)
            return '#dc3545'; // ë¹¨ê°„ìƒ‰ (ë‚˜ì¨)
        }
        
        // ì¡°ëª… ìƒíƒœ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateLightingIndicator(brightnessScore) {
            const lightingIndicator = document.getElementById('lightingIndicator');
            
            if (brightnessScore >= 80) {
                lightingIndicator.textContent = 'ğŸ’¡'; // ì ì • ë°ê¸°
                lightingIndicator.style.backgroundColor = 'rgba(40, 167, 69, 0.7)';
            } else if (brightnessScore >= 50) {
                lightingIndicator.textContent = 'ğŸ”†'; // ì¡°ê¸ˆ ì–´ë‘ì›€
                lightingIndicator.style.backgroundColor = 'rgba(255, 193, 7, 0.7)';
            } else if (brightnessScore >= 20) {
                lightingIndicator.textContent = 'ğŸ”…'; // ë§¤ìš° ì–´ë‘ì›€
                lightingIndicator.style.backgroundColor = 'rgba(220, 53, 69, 0.7)';
            } else {
                lightingIndicator.textContent = 'ğŸ•¯ï¸'; // ê·¹ë„ë¡œ ì–´ë‘ì›€
                lightingIndicator.style.backgroundColor = 'rgba(220, 53, 69, 0.7)';
            }
        }
        
        // ê°ì§€ ê²°ê³¼ì— ë”°ë¥¸ ê°€ì´ë“œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateDetectionGuide(result) {
            const guideText = document.getElementById('cardDetectionGuide');
            const autoCapture = document.getElementById('autoCaptureBtn');
            
            if (!result) {
                guideText.textContent = "ëª…í•¨ì„ ê°€ì´ë“œ ì˜ì—­ì— ë§ì¶°ì£¼ì„¸ìš”";
                guideText.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                autoCapture.style.display = 'none';
                return;
            }
            
            if (result.success) {
                // ëª…í•¨ì´ ê°ì§€ë¨
                if (result.qualityIssues.length > 0) {
                    // í’ˆì§ˆ ì´ìŠˆê°€ ìˆëŠ” ê²½ìš°
                    // ê°€ì¥ ì‹¬ê°í•œ ë¬¸ì œ ì°¾ê¸°
                    const criticalIssues = result.qualityIssues.filter(issue => issue.severity === 'critical');
                    const highIssues = result.qualityIssues.filter(issue => issue.severity === 'high');
                    const mediumIssues = result.qualityIssues.filter(issue => issue.severity === 'medium');
                    
                    let mainIssue = criticalIssues[0] || highIssues[0] || mediumIssues[0];
                    
                    if (mainIssue) {
                        guideText.textContent = mainIssue.message;
                        guideText.style.backgroundColor = 
                            mainIssue.severity === 'critical' ? 'rgba(220, 53, 69, 0.8)' : 
                            mainIssue.severity === 'high' ? 'rgba(255, 193, 7, 0.8)' : 
                            'rgba(40, 167, 69, 0.8)';
                        
                        // ì‹¬ê°í•œ ì´ìŠˆê°€ ìˆìœ¼ë©´ ìë™ ìº¡ì²˜ ë²„íŠ¼ ìˆ¨ê¹€
                        if (mainIssue.severity === 'critical' || mainIssue.severity === 'high') {
                            autoCapture.style.display = 'none';
                        } else {
                            autoCapture.style.display = 'block';
                        }
                    } else {
                        // ê²½ë¯¸í•œ ì´ìŠˆë§Œ ìˆëŠ” ê²½ìš°
                        guideText.textContent = "ëª…í•¨ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì´¬ì˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
                        guideText.style.backgroundColor = 'rgba(40, 167, 69, 0.8)';
                        autoCapture.style.display = 'block';
                    }
                } else {
                    // í’ˆì§ˆ ë¬¸ì œê°€ ì—†ëŠ” ê²½ìš°
                    guideText.textContent = "ì™„ë²½í•©ë‹ˆë‹¤! ì´¬ì˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
                    guideText.style.backgroundColor = 'rgba(40, 167, 69, 0.8)';
                    autoCapture.style.display = 'block';
                }
            } else {
                // ëª…í•¨ì´ ê°ì§€ë˜ì§€ ì•ŠìŒ
                guideText.textContent = result.message || "ëª…í•¨ì„ ê°ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¡°ëª…ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                guideText.style.backgroundColor = 'rgba(220, 53, 69, 0.8)';
                autoCapture.style.display = 'none';
            }
        }
        
        // ëª…í•¨ ì¹´ë“œ ê°ì§€ í•¨ìˆ˜ í† ê¸€ - ì„¤ì • í˜ì´ì§€ì— ì¶”ê°€
        function addCardDetectionToggle() {
            // ì„¤ì • í¼ì— í† ê¸€ ì¶”ê°€
            const settingsForm = document.querySelector('#settingsContent .card-form');
            
            // ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if (document.getElementById('cardDetectionToggle')) return;
            
            const detectionToggleDiv = document.createElement('div');
            detectionToggleDiv.className = 'form-group';
            detectionToggleDiv.innerHTML = `
                <label>
                    <input type="checkbox" id="cardDetectionToggle" ${realTimeBoundaryDetection ? 'checked' : ''}>
                    ì‹¤ì‹œê°„ ëª…í•¨ ê°ì§€ ì‚¬ìš© (ê³ ê¸‰ ì¸ì‹ ê¸°ëŠ¥)
                </label>
                <p style="font-size: 12px; color: #6c757d;">ëª…í•¨ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°ì§€í•˜ê³  ìµœì ì˜ ì´¬ì˜ ìƒíƒœë¥¼ ì•ˆë‚´í•©ë‹ˆë‹¤.</p>
            `;
            
            // ì²« ë²ˆì§¸ ì„¤ì • í•­ëª© ì•ì— ì‚½ì…
            settingsForm.insertBefore(detectionToggleDiv, settingsForm.firstChild);
            
            // í† ê¸€ ì´ë²¤íŠ¸ ì„¤ì •
            document.getElementById('cardDetectionToggle').addEventListener('change', function() {
                realTimeBoundaryDetection = this.checked;
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì„¤ì • ì €ì¥
                appSettings.realTimeBoundaryDetection = realTimeBoundaryDetection;
                localStorage.setItem('appSettings', JSON.stringify(appSettings));
            });
        }
        
        // ëª…í•¨ ì´ë¯¸ì§€ í¼ìŠ¤í™í‹°ë¸Œ ë³€í™˜ í•¨ìˆ˜
        async function perspectiveTransformCard(imageUrl, corners) {
            return new Promise((resolve, reject) => {
                try {
                    if (!isOpencvReady) {
                        resolve(imageUrl); // OpenCVê°€ ì—†ìœ¼ë©´ ì›ë³¸ ë°˜í™˜
                        return;
                    }
                    
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    img.onload = function() {
                        try {
                            // ì´ë¯¸ì§€ë¥¼ Matìœ¼ë¡œ ë¡œë“œ
                            const src = cv.imread(img);
                            
// ì†ŒìŠ¤ í¬ì¸íŠ¸ (ê°ì§€ëœ ëª…í•¨ ëª¨ì„œë¦¬)
// corners ë°°ì—´ì´ ìœ íš¨í•œì§€ í™•ì¸
if (!corners || corners.length !== 4) {
    resolve(imageUrl); // ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš° ì›ë³¸ ë°˜í™˜
    return;
}

try {
    const srcPoints = cv.matFromArray(4, 1, cv.CV_32FC2, [
        corners[0].x, corners[0].y,
        corners[1].x, corners[1].y,
        corners[2].x, corners[2].y,
        corners[3].x, corners[3].y
    ]);

    // ë‚˜ë¨¸ì§€ ì½”ë“œ...
} catch (e) {
    console.error('íˆ¬ì‹œ ë³€í™˜ ë§¤íŠ¸ë¦­ìŠ¤ ìƒì„± ì˜¤ë¥˜:', e);
    resolve(imageUrl); // ì˜¤ë¥˜ ì‹œ ì›ë³¸ ë°˜í™˜
}
                            
                            // ëª…í•¨ í‘œì¤€ í¬ê¸° (ëª…í•¨ ë¹„ìœ¨ ìœ ì§€)
                            // ì¼ë°˜ì ì¸ ëª…í•¨ í¬ê¸°ëŠ” 90mm x 55mm (ê°€ë¡œ x ì„¸ë¡œ)
                            const standardWidth = 900;
                            const standardHeight = 550;
                            
                            // ëŒ€ìƒ í¬ì¸íŠ¸ (ë³€í™˜ í›„ ì§ì‚¬ê°í˜•)
                            const dstPoints = cv.matFromArray(4, 1, cv.CV_32FC2, [
                                0, 0,
                                standardWidth, 0,
                                standardWidth, standardHeight,
                                0, standardHeight
                            ]);
                            
                            // íˆ¬ì‹œ ë³€í™˜ í–‰ë ¬ ê³„ì‚°
                            const M = cv.getPerspectiveTransform(srcPoints, dstPoints);
                            
                            // ê²°ê³¼ ì´ë¯¸ì§€ ìƒì„±
                            const dst = new cv.Mat();
                            cv.warpPerspective(src, dst, M, new cv.Size(standardWidth, standardHeight));
                            
                            // ê²°ê³¼ ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
                            const canvas = document.createElement('canvas');
                            canvas.width = standardWidth;
                            canvas.height = standardHeight;
                            cv.imshow(canvas, dst);
                            
                            // ë³€í™˜ëœ ì´ë¯¸ì§€ URL ìƒì„±
                            const transformedImage = canvas.toDataURL('image/jpeg', 0.9);
                            
                            // ë©”ëª¨ë¦¬ í•´ì œ
                            src.delete();
                            dst.delete();
                            srcPoints.delete();
                            dstPoints.delete();
                            M.delete();
                            
                            // ê²°ê³¼ ë°˜í™˜
                            resolve(transformedImage);
                            
                        } catch (error) {
                            console.error('íˆ¬ì‹œ ë³€í™˜ ì˜¤ë¥˜:', error);
                            resolve(imageUrl); // ì˜¤ë¥˜ ì‹œ ì›ë³¸ ë°˜í™˜
                        }
                    };
                    
                    img.onerror = function() {
                        reject(new Error('ì´ë¯¸ì§€ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
                    };
                    
                    img.src = imageUrl;
                    
                } catch (error) {
                    console.error('íˆ¬ì‹œ ë³€í™˜ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                    resolve(imageUrl); // ì˜¤ë¥˜ ì‹œ ì›ë³¸ ë°˜í™˜
                }
            });
        }
        
        // í–¥ìƒëœ ì´ë¯¸ì§€ ì „ì²˜ë¦¬ í•¨ìˆ˜ (ì€í–‰ OCR í’ˆì§ˆ)
        async function enhanceBusinessCardImageBankLevel(imageUrl, options = {}) {
            return new Promise((resolve, reject) => {
                try {
                    if (!isOpencvReady) {
                        // OpenCVê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ìº”ë²„ìŠ¤ ì²˜ë¦¬ ì‹œë„
                        return enhanceWithCanvas(imageUrl)
                            .then(enhanced => resolve(enhanced))
                            .catch(err => {
                                console.warn('ìº”ë²„ìŠ¤ ì²˜ë¦¬ ì‹¤íŒ¨, ì›ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©:', err);
                                resolve(imageUrl);
                            });
                    }
                    
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    img.onload = function() {
                        try {
                            // 1. ì´ë¯¸ì§€ë¥¼ Matìœ¼ë¡œ ë¡œë“œ
                            const src = cv.imread(img);
                            
                            // 2. ëª…í•¨ ì™¸ê³½ì„  ê°ì§€
                            detectBusinessCardBoundaries(imageUrl)
                                .then(async detectionResult => {
                                    try {
                                        let enhanced;
                                        
                                        if (detectionResult.success && detectionResult.corners) {
                                            // ëª…í•¨ì´ ê°ì§€ë˜ë©´ íˆ¬ì‹œ ë³€í™˜ ì ìš©
                                            enhanced = await perspectiveTransformCard(imageUrl, detectionResult.corners);
                                            
                                            // ë³€í™˜ëœ ì´ë¯¸ì§€ë¥¼ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ì¶”ê°€ ì²˜ë¦¬
                                            const transformedImg = new Image();
                                            transformedImg.onload = function() {
                                                try {
                                                    // ë³€í™˜ëœ ì´ë¯¸ì§€ ì²˜ë¦¬
                                                    const transformedSrc = cv.imread(transformedImg);
                                                    
                                                    // ì¶”ê°€ ì²˜ë¦¬ (ê·¸ë ˆì´ìŠ¤ì¼€ì¼, í•„í„° ë“±)
                                                    applyOcrOptimization(transformedSrc, options)
                                                        .then(optimizedImage => {
                                                            // ë¯¸ë¦¬ë³´ê¸° ì¶”ê°€
                                                            addPreview('ì€í–‰ ìˆ˜ì¤€ ì²˜ë¦¬', optimizedImage);
                                                            resolve(optimizedImage);
                                                        })
                                                        .catch(error => {
                                                            console.error('ì´ë¯¸ì§€ ìµœì í™” ì˜¤ë¥˜:', error);
                                                            resolve(enhanced); // ì˜¤ë¥˜ ì‹œ íˆ¬ì‹œ ë³€í™˜ ì´ë¯¸ì§€ë§Œ ë°˜í™˜
                                                        })
                                                        .finally(() => {
                                                            // ë©”ëª¨ë¦¬ í•´ì œ
                                                            transformedSrc.delete();
                                                        });
                                                } catch (error) {
                                                    console.error('ë³€í™˜ ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                                                    resolve(enhanced);
                                                }
                                            };
                                            
                                            transformedImg.onerror = function() {
                                                console.error('ë³€í™˜ ì´ë¯¸ì§€ ë¡œë“œ ì˜¤ë¥˜');
                                                resolve(enhanced);
                                            };
                                            
                                            transformedImg.src = enhanced;
                                            
                                        } else {
                                            // ëª…í•¨ ê°ì§€ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì²˜ë¦¬ ì ìš©
                                            applyOcrOptimization(src, options)
                                                .then(optimizedImage => {
                                                    // ë¯¸ë¦¬ë³´ê¸° ì¶”ê°€
                                                    addPreview('í‘œì¤€ OCR ìµœì í™”', optimizedImage);
                                                    resolve(optimizedImage);
                                                })
                                                .catch(error => {
                                                    console.error('ì´ë¯¸ì§€ ìµœì í™” ì˜¤ë¥˜:', error);
                                                    resolve(imageUrl);
                                                });
                                        }
                                    } catch (error) {
                                        console.error('ê°ì§€ í›„ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                                        
                                        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ì²˜ë¦¬ ì‹œë„
                                        applyOcrOptimization(src, options)
                                            .then(optimizedImage => resolve(optimizedImage))
                                            .catch(() => resolve(imageUrl))
                                            .finally(() => {
                                                // ë©”ëª¨ë¦¬ í•´ì œ
                                                src.delete();
                                            });
                                    }
                                })
                                .catch(error => {
                                    console.error('ëª…í•¨ ê°ì§€ ì˜¤ë¥˜:', error);
                                    
                                    // ê°ì§€ ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ì²˜ë¦¬ ì ìš©
                                    applyOcrOptimization(src, options)
                                        .then(optimizedImage => resolve(optimizedImage))
                                        .catch(() => resolve(imageUrl))
                                        .finally(() => {
                                            // ë©”ëª¨ë¦¬ í•´ì œ
                                            src.delete();
                                        });
                                });
                        } catch (error) {
                            console.error('ì´ë¯¸ì§€ ì²˜ë¦¬ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                            resolve(imageUrl); // ì˜¤ë¥˜ ì‹œ ì›ë³¸ ë°˜í™˜
                        }
                    };
                    
                    img.onerror = function() {
                        reject(new Error('ì´ë¯¸ì§€ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
                    };
                    
                    img.src = imageUrl;
                    
                } catch (error) {
                    console.error('ì´ë¯¸ì§€ ì²˜ë¦¬ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                    reject(error);
                }
            });
        }
        
        // OCR ìµœì í™” ì´ë¯¸ì§€ ì²˜ë¦¬ í•¨ìˆ˜
        async function applyOcrOptimization(src, options = {}) {
            return new Promise((resolve, reject) => {
                try {
                    // ë©”ëª¨ë¦¬ ê´€ë¦¬ë¥¼ ìœ„í•œ Mat ê°ì²´ ë°°ì—´
                    const mats = [];
                    
                    // ì‘ì—…ìš© Mat ìƒì„±
                    const gray = new cv.Mat();
                    mats.push(gray);
                    
                    // 1. ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ë³€í™˜
                    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                    
                    // 2. ì´ë¯¸ì§€ ì •ê·œí™” (ëª…í•¨ ì´ë¯¸ì§€ì˜ ë°ê¸° ë° ëŒ€ë¹„ í–¥ìƒ)
                    const normalized = new cv.Mat();
                    mats.push(normalized);
                    cv.normalize(gray, normalized, 0, 255, cv.NORM_MINMAX);
                    
                    // 3. ì¡ìŒ ì œê±°
                    const denoised = new cv.Mat();
                    mats.push(denoised);
                    cv.fastNlMeansDenoising(normalized, denoised, 10, 7, 21);
                    
                    // 4. ì–¸ìƒ¤í”„ ë§ˆìŠ¤í‚¹ (ì„ ëª…ë„ í–¥ìƒ)
                    const blurred = new cv.Mat();
                    mats.push(blurred);
                    cv.GaussianBlur(denoised, blurred, new cv.Size(0, 0), 3);
                    
                    const sharpened = new cv.Mat();
                    mats.push(sharpened);
                    const alpha = 1.5;
                    const beta = 1.0 - alpha;
                    cv.addWeighted(denoised, alpha, blurred, beta, 0, sharpened);
                    
                    // 5. CLAHE (Contrast Limited Adaptive Histogram Equalization)
                    const enhanced = new cv.Mat();
                    mats.push(enhanced);
                    
                    const clahe = new cv.CLAHE(2.0, new cv.Size(8, 8));
                    clahe.apply(sharpened, enhanced);
                    
                    // 6. Otsu ë˜ëŠ” ì ì‘í˜• ì´ì§„í™” (ì˜µì…˜ì— ë”°ë¼)
                    let processedImage;
                    
                    if (options.binarize) {
                        const binary = new cv.Mat();
                        mats.push(binary);
                        
                        if (options.adaptiveThreshold) {
                            // ì ì‘í˜• ì´ì§„í™”
                            cv.adaptiveThreshold(
                                enhanced,
                                binary,
                                255,
                                cv.ADAPTIVE_THRESH_GAUSSIAN_C,
                                cv.THRESH_BINARY,
                                11,
                                2
                            );
                        } else {
                            // Otsu ì´ì§„í™”
                            cv.threshold(enhanced, binary, 0, 255, cv.THRESH_BINARY | cv.THRESH_OTSU);
                        }
                        processedImage = binary;
                    } else {
                        processedImage = enhanced;
                    }
                    
                    // 7. ê²°ê³¼ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
                    const canvas = document.createElement('canvas');
                    canvas.width = processedImage.cols;
                    canvas.height = processedImage.rows;
                    cv.imshow(canvas, processedImage);
                    
                    // 8. ì´ë¯¸ì§€ URL ìƒì„±
                    const finalImageUrl = canvas.toDataURL('image/jpeg', 0.9);
                    
                    // 9. ë©”ëª¨ë¦¬ í•´ì œ
                    mats.forEach(mat => mat.delete());
                    
                    // 10. ê²°ê³¼ ë°˜í™˜
                    resolve(finalImageUrl);
                    
                } catch (error) {
                    console.error('OCR ìµœì í™” ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    reject(error);
                }
            });
        }
        
        // ê¸°ë³¸ ìº”ë²„ìŠ¤ APIë¡œ ê°„ë‹¨í•œ ì´ë¯¸ì§€ ê°œì„ 
        async function enhanceWithCanvas(imageUrl) {
            return new Promise((resolve, reject) => {
                try {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    img.onload = function() {
                        try {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            
                            // ì›ë³¸ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
                            ctx.drawImage(img, 0, 0);
                            
                            // ì´ë¯¸ì§€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const data = imageData.data;
                            
                            // ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ë° ëŒ€ë¹„ í–¥ìƒ
                            for (let i = 0; i < data.length; i += 4) {
                                // ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ë³€í™˜
                                const gray = (data[i] * 0.3 + data[i + 1] * 0.59 + data[i + 2] * 0.11);
                                
                                // ëŒ€ë¹„ í–¥ìƒ (ê°„ë‹¨í•œ ë°©ì‹)
                                const contrast = 1.5;
                                const brightness = 10;
                                const enhanced = Math.min(255, Math.max(0, (gray - 128) * contrast + 128 + brightness));
                                
                                data[i] = data[i + 1] = data[i + 2] = enhanced;
                            }
                            
                            // ë³€ê²½ëœ ì´ë¯¸ì§€ ë°ì´í„° ì ìš©
                            ctx.putImageData(imageData, 0, 0);
                            
                            // ê²°ê³¼ URL ìƒì„±
                            const resultUrl = canvas.toDataURL('image/png', parseFloat(appSettings.imageQuality || 0.8));
                            
                            // ë¯¸ë¦¬ë³´ê¸° ì¶”ê°€
                            addPreview('ê¸°ë³¸ ê°œì„ ', resultUrl);
                            
                            resolve(resultUrl);
                        } catch (e) {
                            console.error('ìº”ë²„ìŠ¤ ì²˜ë¦¬ ì˜¤ë¥˜:', e);
                            resolve(imageUrl); // ì˜¤ë¥˜ ì‹œ ì›ë³¸ ë°˜í™˜
                        }
                    };
                    
                    img.onerror = function() {
                        reject(new Error('ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨'));
                    };
                    
                    img.src = imageUrl;
                    
                } catch (error) {
                    console.error('ìº”ë²„ìŠ¤ ì²˜ë¦¬ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                    reject(error);
                }
            });
        }
        
        // ì „ì²˜ë¦¬ ì˜µì…˜ ê°€ì ¸ì˜¤ê¸°
        function getPreprocessingOptions() {
            return {
                grayscale: document.getElementById('optGrayscale').checked,
                adaptiveThreshold: document.getElementById('optAdaptiveThreshold').checked,
                contrast: document.getElementById('optContrast').checked,
                sharpen: document.getElementById('optSharpen').checked,
                denoise: document.getElementById('optDenoise').checked,
                threshold: document.getElementById('optThreshold').checked,
                edgeEnhance: document.getElementById('optEdgeEnhance').checked,
                deskew: document.getElementById('optDeskew').checked
            };
        }
        
        // ì´ë¯¸ì§€ ì „ì²˜ë¦¬ ì ìš©
        function applyPreprocessing() {
            if (!originalImageData) {
                showStatus('ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ëª…í•¨ì„ ì´¬ì˜í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            showStatus('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘...', 'info');
            
            const options = getPreprocessingOptions();
            
            // ì´ë¯¸ì§€ ì „ì²˜ë¦¬ ì‹¤í–‰
            enhanceBusinessCardImage(originalImageData, options)
                .then(enhancedImage => {
                    capturedImage.src = enhancedImage;
                    showStatus('ì´ë¯¸ì§€ ì²˜ë¦¬ ì™„ë£Œ!', 'success');
                    
                    // ë¯¸ë¦¬ë³´ê¸° ì¶”ê°€
                    addPreview('ê³ ê¸‰ ì²˜ë¦¬', enhancedImage);
                })
                .catch(error => {
                    console.error('ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    showStatus('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                });
        }
        
        // OpenCVë¥¼ ì‚¬ìš©í•œ ëª…í•¨ ì´ë¯¸ì§€ ì „ì²˜ë¦¬ í•¨ìˆ˜
        async function enhanceBusinessCardImage(imageUrl, options = {}) {
            return new Promise((resolve, reject) => {
                try {
                    if (!isOpencvReady) {
                        reject(new Error('OpenCV.jsê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'));
                        return;
                    }
                    
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    img.onload = function() {
                        try {
                            // 1. ì´ë¯¸ì§€ë¥¼ Matìœ¼ë¡œ ë¡œë“œ
                            const src = cv.imread(img);
                            
                            // 2. ì‘ì—…ìš© Mat ìƒì„±
                            let dst = new cv.Mat();
                            let gray = new cv.Mat();
                            let blur = new cv.Mat();
                            let edges = new cv.Mat();
                            let processed = new cv.Mat();
                            
                            try {
                                // 3. ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ë³€í™˜ (í•„ìˆ˜ ë‹¨ê³„)
                                if (options.grayscale) {
                                    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
                                } else {
                                    src.copyTo(gray);
                                }
                                
                                // 4. ë…¸ì´ì¦ˆ ì œê±° (ì˜µì…˜)
                                if (options.denoise) {
                                    // ë¹„ë¡œì»¬ í‰ê·  í•„í„°
// ë¹„ë¡œì»¬ í‰ê·  í•„í„°
safeNlMeansDenoising(gray, blur, 10, 7, 21);
                                } else {
                                    gray.copyTo(blur);
                                }
                                
                                // 5. ëª…ì•” ëŒ€ë¹„ í–¥ìƒ (ì˜µì…˜)
                                if (options.contrast) {
                                    // CLAHE(Contrast Limited Adaptive Histogram Equalization) ì ìš©
                                    let clahe = new cv.CLAHE(4.0, new cv.Size(8, 8));
                                    clahe.apply(blur, processed);
                                    clahe.delete();
                                } else {
                                    blur.copyTo(processed);
                                }
                                
                                // 6. ì„ ëª…ë„ í–¥ìƒ (ì˜µì…˜)
                                if (options.sharpen) {
                                    // ì–¸ìƒ¤í”„ ë§ˆìŠ¤í¬ ì²˜ë¦¬
                                    let blurred = new cv.Mat();
                                    let kernel = cv.Mat.ones(3, 3, cv.CV_8U);
                                    let temp = new cv.Mat();
                                    
                                    // ë¸”ëŸ¬ ì²˜ë¦¬ëœ ì´ë¯¸ì§€
                                    cv.GaussianBlur(processed, blurred, new cv.Size(0, 0), 3);
                                    
                                    // ì›ë³¸ - ë¸”ëŸ¬ = ì—£ì§€
                                    cv.subtract(processed, blurred, temp);
                                    
                                    // ì›ë³¸ + ì—£ì§€ = ì„ ëª…í•œ ì´ë¯¸ì§€
                                    cv.add(processed, temp, processed);
                                    
                                    // ì„ì‹œ Mat ì •ë¦¬
                                    blurred.delete();
                                    kernel.delete();
                                    temp.delete();
                                }
                                
                                // 7. ì ì‘í˜• ì´ì§„í™” (ì˜µì…˜)
                                if (options.adaptiveThreshold) {
                                    let binary = new cv.Mat();
                                    cv.adaptiveThreshold(processed, binary, 255,
                                        cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY_INV, 11, 2);
                                    
                                    // ì—­ìƒ ë³€í™˜ (í…ìŠ¤íŠ¸ë¥¼ ê²€ì€ìƒ‰ìœ¼ë¡œ)
                                    cv.bitwise_not(binary, binary);
                                    binary.copyTo(processed);
                                    binary.delete();
                                }
                                
                                // 8. ì¼ë°˜ ì´ì§„í™” (ì˜µì…˜)
                                if (options.threshold) {
                                    let thresh = new cv.Mat();
                                    cv.threshold(processed, thresh, 0, 255, cv.THRESH_BINARY | cv.THRESH_OTSU);
                                    thresh.copyTo(processed);
                                    thresh.delete();
                                }
                                
                                // 9. ì—£ì§€ ê°•í™” (ì˜µì…˜)
                                if (options.edgeEnhance) {
                                    let edges = new cv.Mat();
                                    // Canny ì—£ì§€ ê²€ì¶œ
                                    cv.Canny(processed, edges, 50, 150);
                                    
                                    // ì—£ì§€ ë‘ê»ê²Œ
                                    let kernel = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(2, 2));
                                    cv.dilate(edges, edges, kernel);
                                    
                                    // í•©ì„± (ì›ë³¸ + ì—£ì§€)
                                    if (options.adaptiveThreshold || options.threshold) {
                                        // ì´ì§„í™”ëœ ì´ë¯¸ì§€ë©´ OR ì—°ì‚°
                                        cv.bitwise_or(processed, edges, processed);
                                    } else {
                                        // ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ì´ë¯¸ì§€ë©´ ì—£ì§€ë¥¼ ê·¸ëƒ¥ ì¶”ê°€
                                        cv.add(processed, edges, processed);
                                    }
                                    
                                    edges.delete();
                                    kernel.delete();
                                }
                                
                                // 10. ê¸°ìš¸ê¸° ë³´ì • (ì˜µì…˜)
                                if (options.deskew) {
                                    try {
                                        // ì—£ì§€ ê²€ì¶œ
                                        cv.Canny(processed, edges, 50, 150);
                                        
                                        // í—ˆí”„ ë³€í™˜ìœ¼ë¡œ ì„  ê²€ì¶œ
                                        let lines = new cv.Mat();
                                        cv.HoughLinesP(edges, lines, 1, Math.PI / 180, 50, 50, 10);
                                        
                                        if (lines.rows > 0) {
                                            // ê°ë„ ê³„ì‚°
                                            let angles = [];
                                            
                                            for (let i = 0; i < lines.rows; i++) {
                                                let line = lines.data32S.slice(i * 4, (i + 1) * 4);
                                                let [x1, y1, x2, y2] = line;
                                                
                                                // ë„ˆë¬´ ì§§ì€ ì„ ì€ ê±´ë„ˆë›°ê¸°
                                                let length = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
                                                if (length < 30) continue;
                                                
                                                // ê°ë„ ê³„ì‚° (ë¼ë””ì•ˆ -> ë„)
                                                let angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
                                                
                                                // ìˆ˜í‰ì„ ì— ê°€ê¹Œìš´ ì„ ë§Œ ì‚¬ìš© (-20Â° ~ 20Â° ë˜ëŠ” 160Â° ~ 200Â°)
                                                if ((Math.abs(angle) < 20 || Math.abs(angle - 180) < 20)) {
                                                    angles.push(angle);
                                                }
                                            }
                                            
                                            // í‰ê·  ê°ë„ ê³„ì‚°
                                            if (angles.length > 0) {
                                                let sumAngle = angles.reduce((sum, a) => sum + a, 0);
                                                let avgAngle = sumAngle / angles.length;
                                                
                                                // ê°ë„ ë³´ì • (180ë„ ì´ìƒì´ë©´ ìŒìˆ˜ë¡œ ë³€í™˜)
                                                if (avgAngle > 90) avgAngle -= 180;
                                                else if (avgAngle < -90) avgAngle += 180;
                                                
                                                // íšŒì „ í–‰ë ¬ ê³„ì‚°
                                                let center = new cv.Point(processed.cols / 2, processed.rows / 2);
                                                let rotMat = cv.getRotationMatrix2D(center, avgAngle, 1);
                                                
                                                // ì´ë¯¸ì§€ íšŒì „
                                                cv.warpAffine(processed, dst, rotMat, new cv.Size(processed.cols, processed.rows));
                                                dst.copyTo(processed);
                                                
                                                rotMat.delete();
                                            }
                                        }
                                        
                                        lines.delete();
                                    } catch (e) {
                                        console.error('ê¸°ìš¸ê¸° ë³´ì • ì¤‘ ì˜¤ë¥˜:', e);
                                        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ì¡´ ì´ë¯¸ì§€ ìœ ì§€
                                    }
                                }
                                
                                // 11. ê²°ê³¼ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
                                cv.imshow(canvas, processed);
                                
                                // 12. ì´ë¯¸ì§€ URL ìƒì„±
                                const finalImageUrl = canvas.toDataURL('image/png', parseFloat(appSettings.imageQuality || 0.8));
                                
                                // 13. ë©”ëª¨ë¦¬ ì •ë¦¬ ë° ê²°ê³¼ ë°˜í™˜
                                resolve(finalImageUrl);
                                
                            } finally {
                                // 14. ë©”ëª¨ë¦¬ ì •ë¦¬
                                src.delete();
                                dst.delete();
                                gray.delete();
                                blur.delete();
                                edges.delete();
                                processed.delete();
                            }
                            
                        } catch (error) {
                            console.error('OpenCV ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì›ë³¸ ì´ë¯¸ì§€ ë°˜í™˜
                            resolve(imageUrl);
                        }
                    };
                    
                    img.onerror = function(error) {
                        console.error('ì´ë¯¸ì§€ ë¡œë”© ì˜¤ë¥˜:', error);
                        reject(new Error('ì´ë¯¸ì§€ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
                    };
                    
                    img.src = imageUrl;
                    
                } catch (error) {
                    console.error('ì´ë¯¸ì§€ ì²˜ë¦¬ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                    reject(error);
                }
            });
        }
        
        // ì´ë¯¸ì§€ ì „ì²˜ë¦¬ ì´ˆê¸°í™”
        function resetPreprocessing() {
            if (originalImageData) {
                capturedImage.src = originalImageData;
                showStatus('ì›ë³¸ ì´ë¯¸ì§€ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }
        
        // ë¯¸ë¦¬ë³´ê¸° ì¶”ê°€ í•¨ìˆ˜
        function addPreview(label, imageUrl) {
            // ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆê°€ ë¹„ì–´ìˆìœ¼ë©´ ì›ë³¸ ì´ë¯¸ì§€ ì¶”ê°€
            if (previewContainer.children.length === 0 && originalImageData) {
                const originalPreview = document.createElement('div');
                originalPreview.className = 'preview-item';
                originalPreview.innerHTML = `
                    <img src="${originalImageData}" alt="ì›ë³¸ ì´ë¯¸ì§€">
                    <p>ì›ë³¸</p>
                `;
                previewContainer.appendChild(originalPreview);
                
                // ì›ë³¸ ì´ë¯¸ì§€ í´ë¦­ ì´ë²¤íŠ¸
                originalPreview.addEventListener('click', () => {
                    capturedImage.src = originalImageData;
                });
            }
            
            // ìƒˆ ë¯¸ë¦¬ë³´ê¸° ì¶”ê°€
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            previewItem.innerHTML = `
                <img src="${imageUrl}" alt="${label} ì´ë¯¸ì§€">
                <p>${label}</p>
            `;
            
            // ë¯¸ë¦¬ë³´ê¸° í´ë¦­ ì´ë²¤íŠ¸
            previewItem.addEventListener('click', () => {
                capturedImage.src = imageUrl;
            });
            
            // ì»¨í…Œì´ë„ˆì— ì¶”ê°€
            previewContainer.appendChild(previewItem);
            previewContainer.style.display = 'flex';
        }
        
        // ëª…í•¨ ì´¬ì˜ ê¸°ëŠ¥ ìˆ˜ì • (í”Œë˜ì‹œ íš¨ê³¼ ì¶”ê°€)
        captureBtn.addEventListener('click', async () => {
            try {
                // í”Œë˜ì‹œ íš¨ê³¼ í‘œì‹œ
                const flashEffect = document.getElementById('flashEffect');
                flashEffect.style.opacity = '1';
                
                setTimeout(() => {
                    flashEffect.style.opacity = '0';
                }, 200);
                
                // ìº”ë²„ìŠ¤ ì„¤ì •
                canvas.width = video.videoWidth || 640;
                canvas.height = video.videoHeight || 480;
                
                // ë¹„ë””ì˜¤ í”„ë ˆì„ ìº¡ì²˜
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // ëª…í•¨ ê°ì§€ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš° í™œìš©
                if (lastDetectionResult && lastDetectionResult.success && lastDetectionResult.corners) {
                    // ê°ì§€ëœ ëª…í•¨ ê¸°ë°˜ìœ¼ë¡œ ê³ í’ˆì§ˆ ì²˜ë¦¬
                    try {
                        // íˆ¬ì‹œ ë³€í™˜ ì ìš©
                        const transformedImage = await perspectiveTransformCard(
                            canvas.toDataURL('image/png', 1.0), // ì›ë³¸ í’ˆì§ˆë¡œ ë³€í™˜
                            lastDetectionResult.corners
                        );
                        
                        // ë³€í™˜ëœ ì´ë¯¸ì§€ í‘œì‹œ
                        capturedImage.src = transformedImage;
                        capturedImage.style.display = 'block';
                        
                        // ì›ë³¸ ì´ë¯¸ì§€ ì €ì¥
                        originalImageData = transformedImage;
                        
                        // ë¯¸ë¦¬ë³´ê¸° ì¶”ê°€
                        addPreview('ìë™ êµì •', transformedImage);
                        
                    } catch (transformError) {
                        console.error('ëª…í•¨ ë³€í™˜ ì˜¤ë¥˜:', transformError);
                        
                        // ë³€í™˜ ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ìº¡ì²˜ ì‚¬ìš©
                        capturedImage.src = canvas.toDataURL('image/png', parseFloat(appSettings.imageQuality || 0.95));
                        capturedImage.style.display = 'block';
                        
                        // ì›ë³¸ ì´ë¯¸ì§€ ì €ì¥
                        originalImageData = capturedImage.src;
                    }
                } else {
                    // ê¸°ë³¸ ìº¡ì²˜
                    capturedImage.src = canvas.toDataURL('image/png', parseFloat(appSettings.imageQuality || 0.95));
                    capturedImage.style.display = 'block';
                    
                    // ì›ë³¸ ì´ë¯¸ì§€ ì €ì¥
                    originalImageData = capturedImage.src;
                }
                
                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                captureBtn.style.display = 'none';
                retakeBtn.style.display = 'inline-block';
                analyzeBtn.style.display = 'inline-block';
                improveImageBtn.style.display = 'inline-block';
                video.style.display = 'none';
                rotateButtons.style.display = 'flex';
                
                // ê³ ê¸‰ ëª¨ë“œë©´ ê³ ê¸‰ ì˜µì…˜ ë²„íŠ¼ í‘œì‹œ
                if (isAdvancedMode) {
                    advancedBtn.style.display = 'inline-block';
                }
                
                // ì‹¤ì‹œê°„ ëª…í•¨ ê°ì§€ ì¤‘ì§€
                stopRealTimeCardDetection();
                
                // íšŒì „ ê°ë„ ì´ˆê¸°í™”
                currentRotation = 0;
                
                showStatus('ëª…í•¨ ì´¬ì˜ ì™„ë£Œ! ì´ë¯¸ì§€ë¥¼ ê°œì„ í•˜ê±°ë‚˜ ë°”ë¡œ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'success');
                
                // ì²˜ë¦¬ ë‹¨ê³„ í‘œì‹œ
                stepsIndicator.style.display = 'flex';
                updateProcessingStep('preprocess');
                
                // ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
                previewContainer.innerHTML = '';
                previewContainer.style.display = 'none';
                
                // ìë™ ì´ë¯¸ì§€ ê°œì„  ì ìš© (ì„¤ì •ì— ë”°ë¼)
                if (appSettings.autoPreprocess) {
                    setTimeout(() => {
                        if (improveImageBtn.disabled === false) {
                            improveImageBtn.click();
                        }
                    }, 300);
                }
                
            } catch (error) {
                console.error('ì´¬ì˜ ì˜¤ë¥˜:', error);
                showStatus('ì´¬ì˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
            }
        });
        
        // ì´ë¯¸ì§€ íšŒì „ í•¨ìˆ˜
        function rotateImage(degrees) {
            try {
                // í˜„ì¬ íšŒì „ ê°ë„ ì—…ë°ì´íŠ¸
                currentRotation = (currentRotation + degrees) % 360;
                if (currentRotation < 0) currentRotation += 360;
                
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // íšŒì „ì— ë”°ë¼ ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì •
                    if (currentRotation === 90 || currentRotation === 270) {
                        canvas.width = img.height;
                        canvas.height = img.width;
                    } else {
                        canvas.width = img.width;
                        canvas.height = img.height;
                    }
                    
                    // ìº”ë²„ìŠ¤ ì¤‘ì•™ìœ¼ë¡œ ì´ë™í•˜ê³  íšŒì „
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate(currentRotation * Math.PI / 180);
                    
                    // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° (ì¤‘ì•™ ê¸°ì¤€ìœ¼ë¡œ)
                    ctx.drawImage(img, -img.width / 2, -img.height / 2);
                    
                    // íšŒì „ëœ ì´ë¯¸ì§€ í‘œì‹œ
                    capturedImage.src = canvas.toDataURL('image/png', parseFloat(appSettings.imageQuality || 0.8));
                };
                img.src = originalImageData || capturedImage.src;
                
            } catch (error) {
                console.error('ì´ë¯¸ì§€ íšŒì „ ì˜¤ë¥˜:', error);
                showStatus('ì´ë¯¸ì§€ íšŒì „ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        // ì´ë¯¸ì§€ íšŒì „ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        rotateLeftBtn.addEventListener('click', () => {
            rotateImage(-90);
        });
        
        rotateRightBtn.addEventListener('click', () => {
            rotateImage(90);
        });
        
        // ì´ë¯¸ì§€ ê°œì„  ë²„íŠ¼ ì´ë²¤íŠ¸
        improveImageBtn.addEventListener('click', async () => {
            try {
                improveImageBtn.disabled = true;
                improveImageBtn.textContent = 'ì´ë¯¸ì§€ ê°œì„  ì¤‘...';
                
                // ì›ë³¸ ì´ë¯¸ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
                if (!capturedImage.src || !capturedImage.complete || capturedImage.naturalWidth === 0) {
                    throw new Error('ìœ íš¨í•œ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // ì›ë³¸ ì´ë¯¸ì§€ ë°±ì—…
                const originalSrc = capturedImage.src;
                
                showStatus('ì€í–‰ê¸‰ OCRì„ ìœ„í•œ ì´ë¯¸ì§€ ìµœì í™” ì¤‘...', 'info');
                
                // ì€í–‰ê¸‰ OCR ìµœì í™” ì´ë¯¸ì§€ ì²˜ë¦¬
                const enhancedImage = await enhanceBusinessCardImageBankLevel(originalSrc, {
                    binarize: false,          // ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ì§„í™” ë¹„í™œì„±í™” (í…ìŠ¤íŠ¸ ì¸ì‹ ì •í™•ë„ í–¥ìƒ)
                    adaptiveThreshold: false, // ê¸°ë³¸ê°’ìœ¼ë¡œ ì ì‘í˜• ì´ì§„í™” ë¹„í™œì„±í™”
                    clahe: true,              // ëŒ€ë¹„ ì œí•œ ì ì‘í˜• íˆìŠ¤í† ê·¸ë¨ í‰í™œí™” í™œì„±í™”
                    sharpen: true,            // ì„ ëª…ë„ í–¥ìƒ í™œì„±í™”
                    denoise: true             // ë…¸ì´ì¦ˆ ì œê±° í™œì„±í™”
                });
                
                if (enhancedImage !== originalSrc) {
                    capturedImage.src = enhancedImage;
                    capturedImage.style.display = 'block';
                }
                
                improveImageBtn.textContent = 'ì´ë¯¸ì§€ ê°œì„  ì™„ë£Œ';
                showStatus('ì€í–‰ê¸‰ OCR ìµœì í™” ì™„ë£Œ!', 'success');
                
                setTimeout(() => {
                    improveImageBtn.textContent = 'ë‹¤ì‹œ ê°œì„ ';
                    improveImageBtn.disabled = false;
                }, 1500);
                
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ê°œì„  ì˜¤ë¥˜:', error);
                improveImageBtn.textContent = 'ì´ë¯¸ì§€ ê°œì„ ';
                improveImageBtn.disabled = false;
                showStatus(`ì´ë¯¸ì§€ ê°œì„  ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        });
        
        // ê³ ê¸‰ ì˜µì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸
        advancedBtn.addEventListener('click', () => {
            preprocessingOptions.style.display = preprocessingOptions.style.display === 'none' ? 'block' : 'none';
            advancedBtn.textContent = preprocessingOptions.style.display === 'none' ? 'ê³ ê¸‰ ì˜µì…˜' : 'ì˜µì…˜ ë‹«ê¸°';
        });
        
        // ì „ì²˜ë¦¬ ì ìš© ë²„íŠ¼ ì´ë²¤íŠ¸
        applyPreprocessingBtn.addEventListener('click', () => {
            applyPreprocessing();
        });
        
        // ì „ì²˜ë¦¬ ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸
        resetPreprocessingBtn.addEventListener('click', () => {
            resetPreprocessing();
        });
        
        // í’ˆì§ˆ ìƒì„¸ ì •ë³´ í† ê¸€ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        document.getElementById('detailsToggle').addEventListener('click', () => {
            const qualityDetails = document.getElementById('qualityDetails');
            qualityDetails.classList.toggle('active');
            
            const detailsToggle = document.getElementById('detailsToggle');
            detailsToggle.textContent = qualityDetails.classList.contains('active') ? 'x' : 'i';
        });
        
        // ìë™ ìº¡ì²˜ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        document.getElementById('autoCaptureBtn').addEventListener('click', () => {
            captureBtn.click();
        });
        
        // OCR ì‹¤í–‰ í•¨ìˆ˜ ìˆ˜ì • (ê³ ê¸‰ ì „ì²˜ë¦¬ ì ìš©)
        async function performOCR(imageUrl, lang) {
            try {
                // ì§„í–‰ ìƒíƒœ í‘œì‹œ
                showStatus('OCR ì¸ì‹ ì¤‘...', 'info');
                progressBar.style.display = 'block';
                progressBarFill.style.width = '0%';
                
                // Tesseract ì›Œì»¤ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
                if (!tesseractWorker) {
                    await initTesseract();
                }
                
                // ì–¸ì–´ ë³€ê²½ì´ í•„ìš”í•œ ê²½ìš°
                try {
                    await tesseractWorker.loadLanguage(lang);
                    await tesseractWorker.initialize(lang);
                } catch (error) {
                    console.error('ì–¸ì–´ ë³€ê²½ ì¤‘ ì˜¤ë¥˜:', error);
                    // ì‹¤íŒ¨ ì‹œ ì›Œì»¤ ì¬ìƒì„± ì‹œë„
                    await tesseractWorker.terminate();
                    tesseractWorker = await Tesseract.createWorker();
                    await tesseractWorker.loadLanguage(lang);
                    await tesseractWorker.initialize(lang);
                }
                
                // ê³ ê¸‰ OCR ì„¤ì •
                const psm = appSettings.psm || '4';
                const oem = '1'; // LSTM only
                
                // ìµœê³  í’ˆì§ˆ ì„¤ì •ìœ¼ë¡œ OCR ì‹¤í–‰
                const result = await tesseractWorker.recognize(imageUrl, {
                    tessedit_pageseg_mode: psm,
                    tessedit_ocr_engine_mode: oem,
                    tessjs_create_hocr: true,   // HOCR ì¶œë ¥ í™œì„±í™”
                    tessjs_create_tsv: true,    // TSV ì¶œë ¥ í™œì„±í™”
                    tessjs_create_box: true,    // Box ì¶œë ¥ í™œì„±í™”
                    tessedit_do_invert: false,  // ë°˜ì „ ë¹„í™œì„±í™” (ì´ë¯¸ ìµœì í™”ëœ ì´ë¯¸ì§€ ê°€ì •)
                    preserve_interword_spaces: '1',
                    textord_tabfind_force_vertical_text: '0',
                    textord_tablefind_recognize_tables: '0'
                });
                
                // ê²°ê³¼ ì‹ ë¢°ë„ ê³„ì‚°
                let confidence = 0;
                if (result.confidence) {
                    confidence = result.confidence;
                } else if (result.data && result.data.confidence) {
                    confidence = result.data.confidence;
                }
                
                // ì›ì‹œ OCR ê²°ê³¼ í‘œì‹œ (ê³ ê¸‰ ëª¨ë“œ ë˜ëŠ” ì„¤ì •ì— ë”°ë¼)
                if (isAdvancedMode || appSettings.showRawOcr) {
                    rawOcrResult.textContent = result.data.text;
                    rawOcrResult.style.display = 'block';
                }
                
                // ì‹ ë¢°ë„ í‘œì‹œ
                showConfidence(confidence);
                
                // ê²°ê³¼ ë°˜í™˜
                return {
                    text: result.data.text,
                    confidence: confidence,
                    words: result.data.words || [],
                    hocr: result.data.hocr || '',
                    blocks: result.data.blocks || []
                };
                
            } catch (error) {
                console.error('OCR ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                throw error;
            } finally {
                // ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸
                progressBarFill.style.width = '100%';
            }
        }
        
        // ì‹ ë¢°ë„ í‘œì‹œ í•¨ìˆ˜
        function showConfidence(confidence) {
            confidenceIndicator.style.display = 'flex';
            confidenceFill.style.width = `${confidence}%`;
            confidenceText.textContent = `${Math.round(confidence)}%`;
            
            // ì‹ ë¢°ë„ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
            if (confidence >= 80) {
                confidenceFill.style.backgroundColor = '#28a745'; // ë†’ìŒ (ë…¹ìƒ‰)
            } else if (confidence >= 60) {
                confidenceFill.style.backgroundColor = '#ffc107'; // ì¤‘ê°„ (ë…¸ë€ìƒ‰)
            } else {
                confidenceFill.style.backgroundColor = '#dc3545'; // ë‚®ìŒ (ë¹¨ê°„ìƒ‰)
            }
        }
        
        // ë¶„ì„ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (Tesseract OCR ì²˜ë¦¬)
        analyzeBtn.addEventListener('click', async () => {
            // ì§„í–‰ ìƒíƒœ í‘œì‹œ
            showStatus('ëª…í•¨ ë¶„ì„ ì¤€ë¹„ ì¤‘...', 'info');
            progressBar.style.display = 'block';
            progressBarFill.style.width = '0%';
            analyzeBtn.disabled = true;
            
            try {
                // ì´ë¯¸ì§€ ê²€ì¦
                if (!capturedImage.src || !capturedImage.complete || capturedImage.naturalWidth === 0) {
                    throw new Error('ìœ íš¨í•œ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì´¬ì˜í•´ì£¼ì„¸ìš”.');
                }
                
                // ì–¸ì–´ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
                const langConfig = languageMap[selectedLanguage];
                if (!langConfig) {
                    throw new Error('ì§€ì›ë˜ì§€ ì•ŠëŠ” ì–¸ì–´ì…ë‹ˆë‹¤.');
                }
                
                // ì²˜ë¦¬ ë‹¨ê³„ ì—…ë°ì´íŠ¸
                updateProcessingStep('ocr');
                
                // OCR ìˆ˜í–‰
                const ocrResult = await performOCR(capturedImage.src, langConfig.lang);
                
                // ì¸ì‹ ê²°ê³¼ ê²€ì¦
                if (!ocrResult.text || ocrResult.text.trim().length === 0) {
                    throw new Error('í…ìŠ¤íŠ¸ë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë” ì„ ëª…í•œ ì´ë¯¸ì§€ë¡œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
                
                // ì‹ ë¢°ë„ í‘œì‹œ
                showConfidence(ocrResult.confidence);
                
                // OCR ê²°ê³¼ ì €ì¥
                lastOcrResult = ocrResult;
                
                // ì²˜ë¦¬ ë‹¨ê³„ ì—…ë°ì´íŠ¸
                updateProcessingStep('extract');
                
                // AI ë¶„ì„ ìˆ˜í–‰ (ì„¤ì •ì— ë”°ë¼)
                let aiResults = null;
                if (appSettings.useAI) {
                    try {
                        aiResults = await analyzeWithAI(ocrResult.text);
                    } catch (aiError) {
                        console.error('AI ë¶„ì„ ì˜¤ë¥˜:', aiError);
                        // AI ë¶„ì„ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
                    }
                }
                
                // ëª…í•¨ ì •ë³´ ì¶”ì¶œ
                showStatus('ëª…í•¨ ì •ë³´ ë¶„ì„ ì¤‘...', 'info');
                
                const extractedInfo = await enhancedBusinessCardExtraction(
                    ocrResult, 
                    langConfig.keywords,
                    langConfig.lang,
                    aiResults
                );
                
                // ì²˜ë¦¬ ë‹¨ê³„ ì—…ë°ì´íŠ¸
                updateProcessingStep('review');
                
                // ì¶”ì¶œëœ ì •ë³´ë¥¼ í¼ì— ì±„ìš°ê¸°
                document.getElementById('name').value = extractedInfo.name || '';
                document.getElementById('position').value = extractedInfo.position || '';
                document.getElementById('company').value = extractedInfo.company || '';
                document.getElementById('department').value = extractedInfo.department || '';
document.getElementById('phone').value = extractedInfo.phone || extractedInfo.mobile || extractedInfo.tel || '';
                document.getElementById('email').value = extractedInfo.email || '';
                document.getElementById('website').value = extractedInfo.website || '';
                document.getElementById('address').value = extractedInfo.address || '';
                
                // ì¶”ê°€ ì •ë³´ê°€ ìˆìœ¼ë©´ ë©”ëª¨ í•„ë“œì— ì¶”ê°€
                const additionalInfo = [];
                if (extractedInfo.fax) additionalInfo.push(`íŒ©ìŠ¤: ${extractedInfo.fax}`);
                if (extractedInfo.tel && extractedInfo.tel !== extractedInfo.phone) {
                    additionalInfo.push(`ì „í™”: ${extractedInfo.tel}`);
                }
                if (extractedInfo.mobile && extractedInfo.mobile !== extractedInfo.phone) {
                    additionalInfo.push(`ëª¨ë°”ì¼: ${extractedInfo.mobile}`);
                }
                
                if (additionalInfo.length > 0) {
                    document.getElementById('notes').value = additionalInfo.join('\n');
                }
                
                // í¼ í‘œì‹œ
                cardForm.style.display = 'block';
                
                // ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸
                let analysisType = appSettings.useAI ? "AI ê¸°ë°˜" : "í…ìŠ¤íŠ¸ ê¸°ë°˜";
                showStatus(`ëª…í•¨ ë¶„ì„ ì™„ë£Œ! (${analysisType} ë¶„ì„, ì‹ ë¢°ë„: ${Math.round(ocrResult.confidence || 0)}%)`, 'success');
                progressBarFill.style.width = '100%';
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    analyzeBtn.disabled = false;
                }, 1500);
                
            } catch (error) {
                console.error('ëª…í•¨ ë¶„ì„ ì˜¤ë¥˜:', error);
                
                // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                showStatus(`ì˜¤ë¥˜: ${error.message || 'ëª…í•¨ ë¶„ì„ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}`, 'error');
                
                // ì œí•œëœ ì •ë³´ë¡œë¼ë„ í¼ í‘œì‹œ
                try {
                    // ë©”íƒ€ ì •ë³´ ì¶”ì¶œ ì‹œë„ (ì´ë©”ì¼, ì „í™”ë²ˆí˜¸ë§Œ)
                    const metaInfo = {
                        name: '',
                        position: '',
                        company: '',
                        department: '',
                        phone: '',
                        email: '',
                        website: '',
                        address: ''
                    };
                    
                    if (lastOcrResult && lastOcrResult.text) {
                        // ì´ë©”ì¼ ì¶”ì¶œ
                        const emailMatches = lastOcrResult.text.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g);
                        if (emailMatches && emailMatches.length > 0) {
                            metaInfo.email = emailMatches[0];
                        }
                        
                        // ì „í™”ë²ˆí˜¸ ì¶”ì¶œ
                        const phoneMatches = lastOcrResult.text.match(/(?:\+?\d{1,4}[\s-]?)?(?:\(?\d{2,4}\)?[\s-]?)?\d{3,4}[\s-]?\d{3,4}/g);
                        if (phoneMatches && phoneMatches.length > 0) {
                            metaInfo.phone = phoneMatches[0];
                        }
                        
                        // ì‹œê°„ íŒ¨í„´ ê´€ë ¨ ë¡œì§ (ì˜ˆì‹œ ëª…í•¨ì—ì„œ ì¤‘ìš”í•œ íŒ¨í„´)
                        const lines = lastOcrResult.text.split('\n')
                            .map(line => line.trim())
                            .filter(line => line && line.length > 1);
                        
                        const timePattern = /[-=]{2}\s*[Ilm][mMnN]\s*\d{2}\s*\d{2}\s*[-=]{2}/;
                        
                        for (let i = 0; i < lines.length - 1; i++) {
                            if (timePattern.test(lines[i]) && i + 1 < lines.length) {
                                metaInfo.name = lines[i + 1]; // ì‹œê°„ íŒ¨í„´ ë‹¤ìŒ ì¤„ì´ ì´ë¦„
                                if (i + 2 < lines.length) {
                                    // ê·¸ ë‹¤ìŒ ì¤„ì€ ë³´í†µ ì§ì±…
                                    metaInfo.position = lines[i + 2];
                                }
                                if (i + 3 < lines.length) {
                                    // ê·¸ ë‹¤ìŒ ì¤„ì€ ë³´í†µ íšŒì‚¬
                                    metaInfo.company = lines[i + 3];
                                }
                                break;
                            }
                        }
                        
                        // ì´ë¦„ì„ ëª» ì°¾ì•˜ë‹¤ë©´ ì²« ë²ˆì§¸ ì¤„ í™•ì¸
                        if (!metaInfo.name && lines.length > 0) {
                            // ì²« ì¤„ì´ ì „ì²´ ëŒ€ë¬¸ìë©´ íšŒì‚¬ëª…ìœ¼ë¡œ ê°€ì •
                            if (/^[A-Z\s]+$/.test(lines[0])) {
                                metaInfo.company = lines[0];
                                if (lines.length > 1) {
                                    metaInfo.name = lines[1];
                                }
                            } else {
                                metaInfo.name = lines[0];
                            }
                        }
                    }
                    
                    // í¼ì— ê¸°ë³¸ ì •ë³´ ì±„ìš°ê¸°
                    document.getElementById('name').value = metaInfo.name;
                    document.getElementById('position').value = metaInfo.position;
                    document.getElementById('company').value = metaInfo.company;
                    document.getElementById('department').value = metaInfo.department;
                    document.getElementById('phone').value = metaInfo.phone;
                    document.getElementById('email').value = metaInfo.email;
                    document.getElementById('website').value = metaInfo.website;
                    document.getElementById('address').value = metaInfo.address;
                    
                    // í¼ í‘œì‹œ
                    cardForm.style.display = 'block';
                    
                } catch (fallbackError) {
                    console.error('ê¸°ë³¸ ì •ë³´ ì¶”ì¶œ ì‹¤íŒ¨:', fallbackError);
                    // ë¹ˆ í¼ í‘œì‹œ
                    cardForm.style.display = 'block';
                }
                
                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    analyzeBtn.disabled = false;
                }, 3000);
            }
        });
        
        // AI ê¸°ë°˜ ëª…í•¨ ì •ë³´ ë¶„ì„ í•¨ìˆ˜
        async function analyzeWithAI(text) {
            if (!appSettings.useAI) return null;
            
            try {
                // AI ëª¨ë¸ í™•ì¸
                const model = await loadUSEModel();
                if (!model) return null;
                
                showStatus('AI ë¶„ì„ ì§„í–‰ ì¤‘...', 'info');
                
                // ì¹´í…Œê³ ë¦¬ ì˜ˆì œ ì •ì˜
                const categoryExamples = {
                    "ì´ë¦„": "í™ê¸¸ë™ John Smith ê¹€ì² ìˆ˜ Zhang Wei Tanaka Yuki Roy Young",
                    "íšŒì‚¬": "ì£¼ì‹íšŒì‚¬ (ì£¼) ê¸°ì—… ê·¸ë£¹ ì—°êµ¬ì†Œ í•™êµ ëŒ€í•™êµ Corporation Company Ltd Inc Technology Co",
                    "ì§ì±…": "ëŒ€í‘œ ì‚¬ì¥ ì´ì‚¬ ë¶€ì¥ ê³¼ì¥ ëŒ€ë¦¬ ì—°êµ¬ì› Manager Director CEO CTO CFO President Executive",
                    "ì´ë©”ì¼": "example@example.com contact@company.com info@business.co.kr",
                    "ì „í™”ë²ˆí˜¸": "010-1234-5678 02-123-4567 +82-10-1234-5678 (02)123-4567",
                    "ì›¹ì‚¬ì´íŠ¸": "www.example.com https://company.co.kr http://business.net",
                    "ì£¼ì†Œ": "ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123 New York, NY 10001 ê²½ê¸°ë„ ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬"
                };
                
                // ê²°ê³¼ ì €ì¥ ê°ì²´
                const aiResults = [];
                
                // í…ìŠ¤íŠ¸ ì¤„ ë¶„ì„
                const lines = text.split('\n').filter(line => line.trim().length > 0);
                
                // íŠ¹ë³„í•œ íŒ¨í„´ ê²€ìƒ‰ (ì‹œê°„/ë‚ ì§œ íŒ¨í„´ ë° íŠ¹ìˆ˜ íŒ¨í„´)
                const timePattern = /[-=]{2}\s*[Ilm][mMnN]\s*\d{2}\s*\d{2}\s*[-=]{2}/;
                let timePatternFound = false;
                let nameAfterTimePattern = null;
                
                for (let i = 0; i < lines.length - 1; i++) {
                    if (timePattern.test(lines[i])) {
                        timePatternFound = true;
                        nameAfterTimePattern = lines[i + 1];
                        // ì´ë¯¸ ì´ íŒ¨í„´ì€ "ì´ë¦„" ì¹´í…Œê³ ë¦¬ë¡œ ê´€ë ¨ì„±ì´ ë§¤ìš° ë†’ìŒ
                        aiResults.push({
                            text: nameAfterTimePattern,
                            category: "ì´ë¦„",
                            similarity: 0.95
                        });
                        break;
                    }
                }
                
                // A HOLTOR ê°™ì€ ìƒë‹¨ì— ìˆëŠ” íšŒì‚¬ëª… íŒ¨í„´ ì¸ì‹
                if (lines.length > 0 && /^[A-Z\s]+$/.test(lines[0])) {
                    aiResults.push({
                        text: lines[0],
                        category: "íšŒì‚¬",
                        similarity: 0.9
                    });
                }
                
                // ê° ì¤„ì— ëŒ€í•´ AI ë¶„ì„ (ì‹œê°„ íŒ¨í„´ì—ì„œ ì°¾ì€ ê²ƒì€ ì œì™¸)
                const linesToAnalyze = timePatternFound 
                    ? lines.filter(line => line !== nameAfterTimePattern)
                    : lines;
                
                // ë¶„ì„í•  ì¤„ ì œí•œ (ì„±ëŠ¥ ìµœì í™”)
                const maxLinesToAnalyze = Math.min(10, linesToAnalyze.length);
                
                for (let i = 0; i < maxLinesToAnalyze; i++) {
                    const line = linesToAnalyze[i];
                    
                    // ë¶„ì„ì— ì í•©í•œ ì¤„ì¸ì§€ í™•ì¸
                    if (line.length < 2 || line.length > 50) continue;
                    if (aiResults.some(r => r.text === line)) continue; // ì´ë¯¸ ë¶„ì„í•œ ì¤„ì€ ê±´ë„ˆë›°ê¸°
                    
                    try {
                        // ê° í…ìŠ¤íŠ¸ ì¤„ì„ ì¹´í…Œê³ ë¦¬ì™€ ë¹„êµ
                        const result = await findMostSimilarCategory(line, categoryExamples);
                        
                        if (result && result.category && result.similarity > 0.35) {
                            aiResults.push({
                                text: line,
                                category: result.category,
                                similarity: result.similarity
                            });
                        }
                    } catch (e) {
                        console.warn('ì¤„ ë¶„ì„ ì˜¤ë¥˜:', line, e);
                    }
                }
                
                // ì´ë©”ì¼ê³¼ URL ì¶”ì¶œ (ì •ê·œì‹ íŒ¨í„´ - ë†’ì€ ì •í™•ë„)
                const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
                const emailMatches = text.match(emailRegex);
                
                if (emailMatches && emailMatches.length > 0) {
                    // ì•„ì§ ê²°ê³¼ì— ì—†ìœ¼ë©´ ì¶”ê°€
                    if (!aiResults.some(r => r.text.includes(emailMatches[0]))) {
                        aiResults.push({
                            text: emailMatches[0],
                            category: "ì´ë©”ì¼",
                            similarity: 0.98
                        });
                    }
                }
                
                const urlRegex = /(?:https?:\/\/)?(?:www\.)?[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+(?:\.[a-zA-Z]{2,})/g;
                const urlMatches = text.match(urlRegex);
                
                if (urlMatches && urlMatches.length > 0) {
                    // ì´ë©”ì¼ì´ ì•„ë‹ˆê³  ì•„ì§ ê²°ê³¼ì— ì—†ëŠ” URLë§Œ ì¶”ê°€
                    const validUrls = urlMatches.filter(url => 
                        !url.includes('@') && 
                        !aiResults.some(r => r.text.includes(url))
                    );
                    
                    if (validUrls.length > 0) {
                        aiResults.push({
                            text: validUrls[0],
                            category: "ì›¹ì‚¬ì´íŠ¸",
                            similarity: 0.95
                        });
                    }
                }
                
                // ì „í™”ë²ˆí˜¸ ì¶”ì¶œ (ì •ê·œì‹ íŒ¨í„´)
                const phoneRegex = /(?:(?:\+|00)?82|0)?[ -]?(?:(?:(?:1[0-9]|[2-6][1-3]|70)[ -]?[0-9]{3,4})|(?:50[1-9])[ -]?[0-9]{2,3})[ -]?[0-9]{4}$|(?:\+?1[-\s\.]?)?\(?([0-9]{3})\)?[-\s\.]?([0-9]{3})[-\s\.]?([0-9]{4})|(?:(?:\+?81)|0)[-\s]?(?:[1-9]0(?:[1-9]|0)|\d{2}|\d{1})[-\s]?\d{4}[-\s]?\d{4}|(?:\+?86)?[-\s]?(?:(?:1[3-9][0-9]))[-\s]?[0-9]{4}[-\s]?[0-9]{4}|(?:\d{3,4})[-\s]?(?:\d{7,8})/g;
                const phoneMatches = text.match(phoneRegex);
                
                if (phoneMatches && phoneMatches.length > 0) {
                    // ì•„ì§ ê²°ê³¼ì— ì—†ëŠ” ì „í™”ë²ˆí˜¸ë§Œ ì¶”ê°€
                    if (!aiResults.some(r => r.text.includes(phoneMatches[0]))) {
                        aiResults.push({
                            text: phoneMatches[0],
                            category: "ì „í™”ë²ˆí˜¸",
                            similarity: 0.9
                        });
                    }
                }
                
                // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì •ë ¬í•˜ê³  ê° ì¹´í…Œê³ ë¦¬ì—ì„œ ê°€ì¥ ë†’ì€ ì‹ ë¢°ë„ë¥¼ ê°€ì§„ ê²ƒë§Œ ì„ íƒ
                const categorizedResults = {};
                
                for (const result of aiResults) {
                    if (!categorizedResults[result.category] || 
                        categorizedResults[result.category].similarity < result.similarity) {
                        categorizedResults[result.category] = result;
                    }
                }
                
                // ê²°ê³¼ë¥¼ ë°°ì—´ë¡œ ë³€í™˜
                const finalResults = Object.values(categorizedResults);
                
                // ë§Œì•½ ê³ ê¸‰ ëª¨ë“œì´ë©´ UIì— ê²°ê³¼ í‘œì‹œ
                if (isAdvancedMode) {
                    displayAIResults(finalResults);
                }
                
                return finalResults;
            } catch (error) {
                console.error('AI ë¶„ì„ ì˜¤ë¥˜:', error);
                return null;
            }
        }
        
        // AI ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
        function displayAIResults(results) {
            if (!results || results.length === 0) {
                aiResults.style.display = 'none';
                return;
            }
            
            // ê²°ê³¼ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
            aiResultsList.innerHTML = '';
            
            // ê²°ê³¼ í‘œì‹œ
            for (const result of results) {
                const confidence = Math.round(result.similarity * 100);
                const item = document.createElement('div');
                item.className = 'ai-item';
                item.innerHTML = `
                    <div class="ai-category">${result.category}:</div>
                    <div class="ai-text">${result.text}</div>
                    <div class="ai-confidence">${confidence}%</div>
                `;
                aiResultsList.appendChild(item);
            }
            
            // ê²°ê³¼ ì»¨í…Œì´ë„ˆ í‘œì‹œ
            aiResults.style.display = 'block';
        }
        
        // ê³ ê¸‰ ëª…í•¨ ì •ë³´ ì¶”ì¶œ í•¨ìˆ˜ (AI ë¶„ì„ ê²°ê³¼ í™œìš©)
        async function enhancedBusinessCardExtraction(ocrResult, keywords, langCode, aiAnalysisResults = null) {
            try {
                // OCR ê²°ê³¼ í…ìŠ¤íŠ¸
                const text = ocrResult.text;
                const words = ocrResult.words || [];
                
                // ê¸°ë³¸ ì •ë³´ ê°ì²´
                const info = {
                    name: '',
                    position: '',
                    company: '',
                    department: '',
                    phone: '',
                    mobile: '',
                    tel: '',
                    fax: '',
                    email: '',
                    website: '',
                    address: ''
                };
                
                // AI ë¶„ì„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë¨¼ì € í™œìš©
                if (aiAnalysisResults && aiAnalysisResults.length > 0) {
                    for (const result of aiAnalysisResults) {
                        if (result.category === "ì´ë¦„" && result.similarity > 0.4) {
                            info.name = result.text;
                        } else if (result.category === "íšŒì‚¬" && result.similarity > 0.4) {
                            info.company = result.text;
                        } else if (result.category === "ì§ì±…" && result.similarity > 0.4) {
                            info.position = result.text;
                        } else if (result.category === "ì „í™”ë²ˆí˜¸" && result.similarity > 0.4) {
                            info.phone = result.text;
                        } else if (result.category === "ì´ë©”ì¼" && result.similarity > 0.4) {
                            info.email = result.text;
                        } else if (result.category === "ì›¹ì‚¬ì´íŠ¸" && result.similarity > 0.4) {
                            info.website = result.text;
                        } else if (result.category === "ì£¼ì†Œ" && result.similarity > 0.4) {
                            info.address = result.text;
                        }
                    }
                }
                
                // ì¸ì‹ëœ í…ìŠ¤íŠ¸ë¥¼ ì¤„ë³„ë¡œ ë¶„í•  ë° ì •ì œ
                const rawLines = text.split('\n');
                
                // ì¤„ ì •ì œ: ë¹ˆ ì¤„ ì œê±°, ê³µë°± ì œê±°, íŠ¹ìˆ˜ë¬¸ì ì²˜ë¦¬
                let lines = rawLines
                    .map(line => line.trim())
                    .filter(line => line && line.length > 1);
                
                // 1. ì´ë©”ì¼ ì¶”ì¶œ (ì •ê·œì‹ íŒ¨í„´ - ê°€ì¥ ì‹ ë¢°ì„± ë†’ìŒ)
                if (!info.email) {
                    let emailMatches = text.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g);
                    if (emailMatches && emailMatches.length > 0) {
                        info.email = emailMatches[0];
                    }
                }
                
                // 2. ì›¹ì‚¬ì´íŠ¸ URL ì¶”ì¶œ (ì •ê·œì‹ íŒ¨í„´)
                if (!info.website) {
                    let urlMatches = text.match(/(?:https?:\/\/)?(?:www\.)?[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+(?:\.[a-zA-Z]{2,})(?:\/\S*)?/g);
                    if (urlMatches && urlMatches.length > 0) {
                        // ì´ë©”ì¼ì´ ì•„ë‹Œ URLë§Œ í•„í„°ë§
                        const validUrls = urlMatches.filter(url => !url.includes('@'));
                        if (validUrls.length > 0) {
                            info.website = validUrls[0];
                        }
                    }
                }
                
                // 3. ì „í™”ë²ˆí˜¸ ì¶”ì¶œ (ì–¸ì–´ë³„ íŒ¨í„´)
                if (!info.phone) {
                    const phonePatterns = [
                        // ëª¨ë°”ì¼ íŒ¨í„´
                        {
                            regex: new RegExp(`(?:(?:íœ´ëŒ€(?:í°|ì „í™”)|í•¸ë“œí°|Mobile|ëª¨ë°”ì¼|æºå¸¯|æ‰‹æœº)[\\s:).-]*)?(?:\\+?\\d{1,4}[\\s-]?)?(?:\\(?\\d{2,4}\\)?[\\s-]?)?\\d{3,4}[\\s-]?\\d{3,4}`, 'gi'),
                            type: 'mobile'
                        },
                        // ì¼ë°˜ ì „í™” íŒ¨í„´
                        {
                            regex: new RegExp(`(?:(?:ì „í™”|ì‚¬ë¬´ì‹¤|Tel|TEL|ç”µè¯|é›»è©±|T|P|Ph)[\\s:).-]*)?(?:\\+?\\d{1,4}[\\s-]?)?(?:\\(?\\d{2,4}\\)?[\\s-]?)?\\d{3,4}[\\s-]?\\d{3,4}`, 'gi'),
                            type: 'tel'
                        },
                        // íŒ©ìŠ¤ íŒ¨í„´
                        {
                            regex: new RegExp(`(?:(?:íŒ©ìŠ¤|Fax|FAX|ä¼ çœŸ|F)[\\s:).-]*)?(?:\\+?\\d{1,4}[\\s-]?)?(?:\\(?\\d{2,4}\\)?[\\s-]?)?\\d{3,4}[\\s-]?\\d{3,4}`, 'gi'),
                            type: 'fax'
                        },
                        // ì¼ë°˜ ìˆ«ì íŒ¨í„´
                        {
                            regex: /(?:\+?\d{1,4}[\s-]?)?(?:\(?\d{2,4}\)?[\s-]?)?\d{3,4}[\s-]?\d{3,4}(?:[\s-]?\d{3,4})?/g,
                            type: 'phone'
                        }
                    ];
                    
                    // ë§¤ì¹­ëœ ì „í™”ë²ˆí˜¸ ì €ì¥
                    const matchedNumbers = new Set();
                    
                    // ê° íŒ¨í„´ë³„ë¡œ ê²€ìƒ‰
                    for (const pattern of phonePatterns) {
                        const matches = text.match(pattern.regex);
                        if (matches && matches.length > 0) {
                            for (const match of matches) {
                                // ìˆ«ìë§Œ ì¶”ì¶œí•´ì„œ ì¤‘ë³µ ì²´í¬ (ë‹¤ì–‘í•œ í¬ë§·ìœ¼ë¡œ ë™ì¼ ë²ˆí˜¸ê°€ ì¶”ì¶œë  ìˆ˜ ìˆìŒ)
                                const digitsOnly = match.replace(/\D/g, '');
                                
                                // ë„ˆë¬´ ì§§ê±°ë‚˜ ê¸´ ë²ˆí˜¸ëŠ” ê±´ë„ˆë›°ê¸°
                                if (digitsOnly.length < 7 || digitsOnly.length > 15) continue;
                                
                                // ì´ë¯¸ ì¶”ì¶œí•œ ë²ˆí˜¸ë©´ ê±´ë„ˆë›°ê¸°
                                if (matchedNumbers.has(digitsOnly)) continue;
                                
                                // ì „í™”ë²ˆí˜¸ í˜•ì‹í™”
                                let formattedNumber = match.trim();
                                
                                // ì „í™”ë²ˆí˜¸ ìœ í˜• ì €ì¥
                                if (pattern.type === 'mobile' && !info.mobile) {
                                    info.mobile = formattedNumber;
                                } else if (pattern.type === 'tel' && !info.tel) {
                                    info.tel = formattedNumber;
                                } else if (pattern.type === 'fax' && !info.fax) {
                                    info.fax = formattedNumber;
                                } else if (pattern.type === 'phone' && !info.phone) {
                                    info.phone = formattedNumber;
                                }
                                
                                // ë§¤ì¹­ëœ ë²ˆí˜¸ ì €ì¥
                                matchedNumbers.add(digitsOnly);
                            }
                        }
                    }
                    
                    // ëŒ€í‘œ ì „í™”ë²ˆí˜¸ ì„¤ì • (ëª¨ë°”ì¼ > ì¼ë°˜ì „í™” > íŒ©ìŠ¤ ìˆœ)
                    if (!info.phone) {
                        info.phone = info.mobile || info.tel || '';
                    }
                }
                
                // 4. ì´ë¦„ ì¶”ì¶œ (AI ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš°)
                if (!info.name) {
                    // íŠ¹ë³„í•œ ì‹œê°„/ë‚ ì§œ í˜•ì‹ íŒ¨í„´ í™•ì¸ (ì˜ˆ: "-- lm 00 00 ==")
                    const timePattern = /[-=]{2}\s*[Ilm][mMnN]\s*\d{2}\s*\d{2}\s*[-=]{2}/;
                    let nameAfterTimePattern = null;
                    
                    // ì‹œê°„ íŒ¨í„´ ë‹¤ìŒ ì¤„ì„ ì´ë¦„ìœ¼ë¡œ ê°„ì£¼ (ë§ì€ ëª…í•¨ì´ ì´ëŸ° í˜•ì‹ ì‚¬ìš©)
                    for (let i = 0; i < lines.length - 1; i++) {
                        if (timePattern.test(lines[i]) && i + 1 < lines.length) {
                            nameAfterTimePattern = lines[i + 1];
                            break;
                        }
                    }
                    
                    if (nameAfterTimePattern) {
                        info.name = nameAfterTimePattern;
                    } else {
                        // ì¼ë°˜ì ì¸ ì´ë¦„ ì¶”ì¶œ
                        // ì§§ê³  íŠ¹ìˆ˜ ë¬¸ìê°€ ì—†ëŠ” ì²« ë²ˆì§¸/ë‘ ë²ˆì§¸ ì¤„ì„ ì´ë¦„ìœ¼ë¡œ ì¶”ì •
                        const nameLines = lines.filter(line => 
                            line.length < 25 && 
                            line.length > 1 &&
                            !line.includes('@') && 
                            !line.includes('http') &&
                            !/\d{4,}/.test(line) && // ê¸´ ìˆ«ìê°€ ì—†ëŠ” ì¤„
                            !/^[\d\s\-+.()]+$/.test(line) // ì „í™”ë²ˆí˜¸ë§Œ ìˆëŠ” ì¤„ì´ ì•„ë‹Œ ê²ƒ
                        );
                        
                        if (nameLines.length > 0) {
                            // ì–¸ì–´ë³„ íŠ¹ì„±ì— ë§ëŠ” ì²˜ë¦¬
                            let nameFirst = true;
                            if (langCode.includes('kor') || langCode.includes('jpn') || langCode.includes('chi_sim')) {
                                nameFirst = true; // ë™ì•„ì‹œì•„ ì–¸ì–´ëŠ” ì´ë¦„ì´ ë¨¼ì € ë‚˜ì˜´
                            } else {
                                nameFirst = false; // ì„œì–‘ ì–¸ì–´ëŠ” íšŒì‚¬/ì§ì±…ì´ ë¨¼ì € ë‚˜ì˜¤ëŠ” ê²½ìš°ê°€ ë§ìŒ
                            }
                            
                            // ìœ„ì¹˜ ê¸°ë°˜ ì´ë¦„ ì¶”ì¶œ
                            if (nameFirst && nameLines.length > 0) {
                                // ë™ì•„ì‹œì•„ ì–¸ì–´: ì²« ë²ˆì§¸ ì§§ì€ ì¤„ì„ ì´ë¦„ìœ¼ë¡œ
                                info.name = nameLines[0];
                            } else if (nameLines.length > 1) {
                                // ì„œì–‘ ì–¸ì–´: ë‘ ë²ˆì§¸ ë˜ëŠ” ì„¸ ë²ˆì§¸ ì§§ì€ ì¤„ì„ ì´ë¦„ìœ¼ë¡œ
                                info.name = nameLines[1] || nameLines[0];
                            } else {
                                info.name = nameLines[0];
                            }
                        }
                    }
                    
                    // ì´ë¦„ ì •ì œ
                    if (info.name) {
                        info.name = info.name.replace(/^\s*[.â€¢*-]\s*/, ''); // ì¤„ ì•ì˜ ê¸°í˜¸ ì œê±°
                    }
                }
                
                // 5. íšŒì‚¬ëª… ì¶”ì¶œ (AI ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš°)
                if (!info.company) {
                    // ì²« ì¤„ì´ ëŒ€ë¬¸ìë¡œë§Œ ëœ ê²½ìš° íšŒì‚¬ë¡œ ê°„ì£¼ (ì˜ˆ: "A HOLTOR")
                    if (lines.length > 0 && /^[A-Z\s]+$/.test(lines[0])) {
                        info.company = lines[0];
                    } else {
                        // í‚¤ì›Œë“œ ê¸°ë°˜ íšŒì‚¬ëª… íƒìƒ‰
                        for (const line of lines) {
                            if (keywords.company.some(keyword => line.includes(keyword))) {
                                info.company = line;
                                break;
                            }
                        }
                        
                        // íšŒì‚¬ëª…ì´ ì—†ìœ¼ë©´ ìœ„ì¹˜ ê¸°ë°˜ìœ¼ë¡œ ì¶”ì •
                        if (!info.company && lines.length > 1) {
                            const nameIndex = info.name ? lines.indexOf(info.name) : -1;
                            
                            if (nameIndex === 0 && lines.length > 1) {
                                // ì´ë¦„ì´ ì²« ì¤„ì´ë©´ ë‘ ë²ˆì§¸ ì¤„ì´ íšŒì‚¬ì¼ ê°€ëŠ¥ì„± ë†’ìŒ
                                info.company = lines[1];
                            } else if (nameIndex === -1 && lines.length > 0) {
                                // ì´ë¦„ì„ ì°¾ì§€ ëª»í–ˆìœ¼ë©´ ì²« ì¤„ì´ íšŒì‚¬ì¼ ê°€ëŠ¥ì„±
                                info.company = lines[0];
                            }
                        }
                    }
                }
                
                // 6. ì§ì±… ì¶”ì¶œ (AI ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš°)
                if (!info.position) {
                    // í‚¤ì›Œë“œ ê¸°ë°˜ ì§ì±… íƒìƒ‰
                    for (const line of lines) {
                        if (keywords.position.some(keyword => line.includes(keyword))) {
                            info.position = line;
                            break;
                        }
                    }
                    
                    // ì§ì±…ì´ ì—†ìœ¼ë©´ ìœ„ì¹˜ ê¸°ë°˜ìœ¼ë¡œ ì¶”ì •
                    if (!info.position && info.name && info.company) {
                        const nameIndex = lines.indexOf(info.name);
                        const companyIndex = lines.indexOf(info.company);
                        
                        if (nameIndex !== -1 && companyIndex !== -1) {
                            // ì´ë¦„ê³¼ íšŒì‚¬ ì‚¬ì´ì— ìˆëŠ” ì¤„ì„ ì§ì±…ìœ¼ë¡œ ê°„ì£¼
                            const indices = [nameIndex, companyIndex].sort((a, b) => a - b);
                            if (indices[1] - indices[0] === 2) {
                                const middleIndex = indices[0] + 1;
                                info.position = lines[middleIndex];
                            }
                        }
                    }
                }
                
                // 7. ë¶€ì„œ ì¶”ì¶œ
                if (!info.department) {
                    // í‚¤ì›Œë“œ ê¸°ë°˜ ë¶€ì„œ íƒìƒ‰
                    for (const line of lines) {
                        if (keywords.department.some(keyword => line.includes(keyword))) {
                            info.department = line;
                            break;
                        }
                    }
                }
                
                // 8. ì£¼ì†Œ ì¶”ì¶œ
                if (!info.address) {
                    // ê°€ì¥ ê¸´ ì¤„ì„ ì£¼ì†Œë¡œ ê°„ì£¼ (ì „í™”ë²ˆí˜¸, ì´ë©”ì¼, URL ì•„ë‹Œ ê²ƒë“¤ ì¤‘ì—ì„œ)
                    const addressCandidates = lines.filter(line => 
                        line.length > 20 && 
                        !line.includes('@') && 
                        !line.includes('www.') && 
                        !line.includes('http') &&
                        !/^[\d\s\-+.()]+$/.test(line) // ì „í™”ë²ˆí˜¸ë§Œ ìˆëŠ” ì¤„ì´ ì•„ë‹Œ ê²ƒ
                    );
                    
                    if (addressCandidates.length > 0) {
                        // ê°€ì¥ ê¸´ ì¤„ì„ ì£¼ì†Œë¡œ ì„¤ì •
                        info.address = addressCandidates.reduce((a, b) => a.length >= b.length ? a : b);
                    }
                }
                
                // 9. ì •ë³´ ì •ì œ
                if (info.name) info.name = info.name.trim();
                if (info.company) info.company = info.company.trim();
                if (info.position) info.position = info.position.trim();
                if (info.department) info.department = info.department.trim();
                if (info.phone) info.phone = info.phone.trim();
                if (info.email) info.email = info.email.trim();
                if (info.website) info.website = info.website.trim();
                if (info.address) info.address = info.address.trim();
                
                return info;
                
            } catch (error) {
                console.error('ëª…í•¨ ì •ë³´ ì¶”ì¶œ ì˜¤ë¥˜:', error);
                
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ì •ë³´ ì¶”ì¶œ ì‹œë„
                const basicInfo = {
                    name: '',
                    position: '',
                    company: '',
                    department: '',
                    phone: '',
                    email: '',
                    website: '',
                    address: ''
                };
                
                try {
                    // ì´ë©”ì¼ ì¶”ì¶œ ì‹œë„
                    const emailMatches = ocrResult.text.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g);
                    if (emailMatches && emailMatches.length > 0) {
                        basicInfo.email = emailMatches[0];
                    }
                    
                    // ì „í™”ë²ˆí˜¸ ì¶”ì¶œ ì‹œë„
                    const phoneMatches = ocrResult.text.match(/(?:\+?\d{1,4}[\s-]?)?(?:\(?\d{2,4}\)?[\s-]?)?\d{3,4}[\s-]?\d{3,4}/g);
                    if (phoneMatches && phoneMatches.length > 0) {
                        basicInfo.phone = phoneMatches[0];
                    }
                    
                    // ì¤„ ë¶„í• 
                    const lines = ocrResult.text.split('\n')
                        .map(line => line.trim())
                        .filter(line => line && line.length > 1);
                    
                    // ì‹œê°„ íŒ¨í„´ ê²€ìƒ‰ (-- lm 00 00 == ë‹¤ìŒì— ì˜¤ëŠ” ì¤„ì´ ì´ë¦„ì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŒ)
                    const timePattern = /[-=]{2}\s*[Ilm][mMnN]\s*\d{2}\s*\d{2}\s*[-=]{2}/;
                    let nameFound = false;
                    
                    for (let i = 0; i < lines.length - 1; i++) {
                        if (timePattern.test(lines[i])) {
                            basicInfo.name = lines[i + 1];
                            nameFound = true;
                            break;
                        }
                    }
                    
                    // ì‹œê°„ íŒ¨í„´ì—ì„œ ì´ë¦„ì„ ì°¾ì§€ ëª»í–ˆìœ¼ë©´ ì²« ë²ˆì§¸ ì¤„ì„ ì´ë¦„ìœ¼ë¡œ
                    if (!nameFound && lines.length > 0) {
                        // ì²« ì¤„ì´ ëŒ€ë¬¸ìë¡œë§Œ ëœ ê²½ìš°ëŠ” íšŒì‚¬ë¡œ ê°„ì£¼
                        if (/^[A-Z\s]+$/.test(lines[0])) {
                            basicInfo.company = lines[0];
                            if (lines.length > 1) {
                                basicInfo.name = lines[1];
                            }
                        } else {
                            basicInfo.name = lines[0];
                        }
                    }
                    
                    // íšŒì‚¬ëª… ì¶”ì¶œ ì‹œë„
                    if (!basicInfo.company && lines.length > 1) {
                        for (let i = 0; i < Math.min(3, lines.length); i++) {
                            const line = lines[i];
                            if (line !== basicInfo.name && 
                                (line.includes('ì£¼ì‹íšŒì‚¬') || line.includes('(ì£¼)') || 
                                 line.includes('Co.') || line.includes('Ltd') || 
                                 line.includes('Inc') || line.includes('Corp'))) {
                                basicInfo.company = line;
                                break;
                            }
                        }
                        
                        // í‚¤ì›Œë“œê°€ ì—†ìœ¼ë©´ ë‘ ë²ˆì§¸ë‚˜ ì„¸ ë²ˆì§¸ ì¤„ì„ íšŒì‚¬ë¡œ ì¶”ì •
                        if (!basicInfo.company && lines.length > 1) {
                            const nameIndex = lines.indexOf(basicInfo.name);
                            if (nameIndex === 0 && lines.length > 1) {
                                basicInfo.company = lines[1];
                            } else if (nameIndex === 1 && lines.length > 2) {
                                basicInfo.company = lines[0] || lines[2];
                            }
                        }
                    }
                    
                } catch (e) {
                    console.error('ê¸°ë³¸ ì •ë³´ ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜:', e);
                }
                
                return basicInfo;
            }
        }
        
        // ëª…í•¨ ì €ì¥
        saveBtn.addEventListener('click', () => {
            try {
                const newCard = {
                    id: Date.now().toString(), // ê³ ìœ  ID ìƒì„±
                    name: document.getElementById('name').value,
                    position: document.getElementById('position').value,
                    company: document.getElementById('company').value,
                    department: document.getElementById('department').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    website: document.getElementById('website').value,
                    address: document.getElementById('address').value,
                    notes: document.getElementById('notes').value,
                    registeredDate: new Date().toISOString()
                };
                
                // í•„ìˆ˜ í•„ë“œ ê²€ì¦
                if (!newCard.name.trim()) {
                    showStatus('ì´ë¦„ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.', 'error');
                    return;
                }
                
                // ëª…í•¨ ë°ì´í„° ë°°ì—´ì— ì¶”ê°€
                businessCards.push(newCard);
                
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                saveBusinessCards();
                
                // í¼ ì´ˆê¸°í™”
                resetForm();
                
                // ëŒ€ì‹œë³´ë“œ íƒ­ìœ¼ë¡œ ì „í™˜
                tabs[1].click();
                
                showStatus('ëª…í•¨ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                console.error('ëª…í•¨ ì €ì¥ ì˜¤ë¥˜:', error);
                showStatus('ëª…í•¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        });
        
        // í¼ ì´ˆê¸°í™”
        function resetForm() {
            document.getElementById('name').value = '';
            document.getElementById('position').value = '';
            document.getElementById('company').value = '';
            document.getElementById('department').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('email').value = '';
            document.getElementById('website').value = '';
            document.getElementById('address').value = '';
            document.getElementById('notes').value = '';
            
            capturedImage.style.display = 'none';
            captureBtn.style.display = 'inline-block';
            retakeBtn.style.display = 'none';
            analyzeBtn.style.display = 'none';
            advancedBtn.style.display = 'none';
            improveImageBtn.style.display = 'none';
            cardForm.style.display = 'none';
            video.style.display = 'block';
            rotateButtons.style.display = 'none';
            confidenceIndicator.style.display = 'none';
            stepsIndicator.style.display = 'none';
            preprocessingOptions.style.display = 'none';
            previewContainer.style.display = 'none';
            rawOcrResult.style.display = 'none';
            aiResults.style.display = 'none';
            
            // ëª…í•¨ ì¸ì‹ ê°€ì´ë“œ ë‹¤ì‹œ í‘œì‹œ
            document.getElementById('cardScanningGuide').style.display = 'block';
            
            // ì‹¤ì‹œê°„ ëª…í•¨ ê°ì§€ ì¬ì‹œì‘
            if (realTimeBoundaryDetection) {
                startRealTimeCardDetection();
            }
            
            analyzeBtn.disabled = false;
            improveImageBtn.disabled = false;
            improveImageBtn.textContent = 'ì´ë¯¸ì§€ ê°œì„ ';
            statusMessage.style.display = 'none';
            
            // ì›ë³¸ ì´ë¯¸ì§€ ë°ì´í„° ì´ˆê¸°í™”
            originalImageData = null;
            
            // íšŒì „ ê°ë„ ì´ˆê¸°í™”
            currentRotation = 0;
            
            // ì²˜ë¦¬ ë‹¨ê³„ ì´ˆê¸°í™”
            updateProcessingStep('capture');
        }
        
        // ëª…í•¨ ì‚­ì œ
        function deleteBusinessCard(id) {
            if (confirm('ì´ ëª…í•¨ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                businessCards = businessCards.filter(card => card.id !== id);
                saveBusinessCards();
                renderCardList(searchInput.value);
                showStatus('ëª…í•¨ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }
        
        // ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        function openEditModal(id) {
            const card = businessCards.find(card => card.id === id);
            
            if (card) {
                currentEditId = id;
                
                document.getElementById('editName').value = card.name || '';
                document.getElementById('editPosition').value = card.position || '';
                document.getElementById('editCompany').value = card.company || '';
                document.getElementById('editDepartment').value = card.department || '';
                document.getElementById('editPhone').value = card.phone || '';
                document.getElementById('editEmail').value = card.email || '';
                document.getElementById('editWebsite').value = card.website || '';
                document.getElementById('editAddress').value = card.address || '';
                document.getElementById('editNotes').value = card.notes || '';
                
                editModal.style.display = 'block';
            }
        }
        
        // ëª…í•¨ ì •ë³´ ì—…ë°ì´íŠ¸
        updateBtn.addEventListener('click', () => {
            if (currentEditId) {
                // í•„ìˆ˜ í•„ë“œ ê²€ì¦
                const name = document.getElementById('editName').value.trim();
                if (!name) {
                    showStatus('ì´ë¦„ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.', 'error');
                    return;
                }
                
                const index = businessCards.findIndex(card => card.id === currentEditId);
                
                if (index !== -1) {
                    businessCards[index] = {
                        ...businessCards[index],
                        name: name,
                        position: document.getElementById('editPosition').value,
                        company: document.getElementById('editCompany').value,
                        department: document.getElementById('editDepartment').value,
                        phone: document.getElementById('editPhone').value,
                        email: document.getElementById('editEmail').value,
                        website: document.getElementById('editWebsite').value,
                        address: document.getElementById('editAddress').value,
                        notes: document.getElementById('editNotes').value
                    };
                    
                    saveBusinessCards();
                    renderCardList(searchInput.value);
                    
                    editModal.style.display = 'none';
                    showStatus('ëª…í•¨ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                }
            }
        });
        
        // ì˜¤ë¥˜ ì €í•­ì„± ë†’ì€ ì•± ì„¤ì •
        function setupErrorResistantApp() {
            // ë©”ëª¨ë¦¬ ë° ì„±ëŠ¥ ìµœì í™”
            setupPerformanceOptimization();
            
            // ì˜¤ë¥˜ ì²˜ë¦¬ë¥¼ ìœ„í•œ ì „ì—­ í•¸ë“¤ëŸ¬ ì¶”ê°€
            window.addEventListener('error', function(event) {
                console.error('ì „ì—­ ì˜¤ë¥˜ ë°œìƒ:', event.error);
                // ì¹˜ëª…ì  ì˜¤ë¥˜ ë°œìƒ ì‹œ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
                showStatus(`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${event.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}. í•„ìš”í•œ ê²½ìš° í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.`, 'error');
            });
            
            // ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§
            window.addEventListener('online', function() {
                showStatus('ì¸í„°ë„· ì—°ê²°ì´ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            });
            
            window.addEventListener('offline', function() {
                showStatus('ì¸í„°ë„· ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤. ì¼ë¶€ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
            });
            
            // ì–¸ë¡œë“œ í•¸ë“¤ëŸ¬
            window.addEventListener('beforeunload', function() {
                // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
                if (video.srcObject) {
                    const tracks = video.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                }
                
                // Tesseract ì›Œì»¤ ì¢…ë£Œ
                if (tesseractWorker) {
                    tesseractWorker.terminate();
                }
            });
        }
        
        // ì„±ëŠ¥ ìµœì í™” ì„¤ì •
        function setupPerformanceOptimization() {
            // 1. ë¹„í™œì„± íƒ­ì—ì„œ ì¹´ë©”ë¼ ì¤‘ì§€
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && video.srcObject) {
                    // í˜ì´ì§€ê°€ ìˆ¨ê²¨ì§€ë©´ ì¹´ë©”ë¼ ì¤‘ì§€
                    const tracks = video.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                    
                    // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
                    showStatus('í˜ì´ì§€ê°€ ë°±ê·¸ë¼ìš´ë“œë¡œ ì´ë™í•˜ì—¬ ì¹´ë©”ë¼ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì ‘ê·¼í•˜ë ¤ë©´ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.', 'info');
                    accessCameraBtn.style.display = 'block';
                    accessCameraBtn.textContent = 'ì¹´ë©”ë¼ ë‹¤ì‹œ ì ‘ê·¼';
                    video.style.display = 'none';
                }
            });
            
            // 2. ë””ë°”ìš´ìŠ¤ êµ¬í˜„ (ê²€ìƒ‰ í•„ë“œ)
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    renderCardList(e.target.value);
                }, 300); // 300ms ì§€ì—°
            });
            
            // 3. ì´ë¯¸ì§€ ìµœì í™”
            const quality = parseFloat(appSettings.imageQuality || 0.8);
            const maxWidth = 1280; // ìµœëŒ€ ì´ë¯¸ì§€ ë„ˆë¹„ ì œí•œ
            
            // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì „ ìµœì í™” ì´ë²¤íŠ¸ ì¶”ê°€
            fileInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    
                    // ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì²˜ë¦¬
                    if (!file.type.startsWith('image/')) {
                        showStatus('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
                        fileInput.value = '';
                        return;
                    }
                    
                    // íŒŒì¼ í¬ê¸° í™•ì¸ (5MB ì´ˆê³¼ ì‹œ ìµœì í™”)
                    if (file.size > 5 * 1024 * 1024) {
                        showStatus('í° ì´ë¯¸ì§€ íŒŒì¼ì…ë‹ˆë‹¤. ìµœì í™”ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤...', 'info');
                        
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const img = new Image();
                            img.onload = () => {
                                // ì´ë¯¸ì§€ í¬ê¸° ì œí•œ ë° í’ˆì§ˆ ì¡°ì •
                                const canvas = document.createElement('canvas');
                                let width = img.width;
                                let height = img.height;
                                
                                // ë„ˆë¹„ ì œí•œ
                                if (width > maxWidth) {
                                    height = (maxWidth / width) * height;
                                    width = maxWidth;
                                }
                                
                                canvas.width = width;
                                canvas.height = height;
                                
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);
                                
                                // ìµœì í™”ëœ ì´ë¯¸ì§€ í‘œì‹œ
                                capturedImage.src = canvas.toDataURL('image/jpeg', quality);
                                capturedImage.style.display = 'block';
                                
                                // ì›ë³¸ ì´ë¯¸ì§€ ì €ì¥
                                originalImageData = capturedImage.src;
                                
                                // UI ì—…ë°ì´íŠ¸
                                video.style.display = 'none';
                                accessCameraBtn.style.display = 'none';
                                captureBtn.style.display = 'none';
                                retakeBtn.style.display = 'inline-block';
                                analyzeBtn.style.display = 'inline-block';
                                improveImageBtn.style.display = 'inline-block';
                                rotateButtons.style.display = 'flex';
                                
                                // ê³ ê¸‰ ëª¨ë“œë©´ ê³ ê¸‰ ì˜µì…˜ ë²„íŠ¼ í‘œì‹œ
                                if (isAdvancedMode) {
                                    advancedBtn.style.display = 'inline-block';
                                }
                                
                                // íšŒì „ ê°ë„ ì´ˆê¸°í™”
                                currentRotation = 0;
                                
                                // ì²˜ë¦¬ ë‹¨ê³„ í‘œì‹œ
                                stepsIndicator.style.display = 'flex';
                                updateProcessingStep('preprocess');
                                
                                showStatus('ì´ë¯¸ì§€ê°€ ìµœì í™”ë˜ì–´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                            };
                            img.src = event.target.result;
                        };
                        reader.readAsDataURL(file);
                        
                        // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™” (ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€)
                        fileInput.value = '';
                    }
                    // ì´ë¯¸ ì ì • í¬ê¸°ë©´ ê·¸ëŒ€ë¡œ ì²˜ë¦¬
                }
            });
        }
        
        // í™˜ì˜ ê°€ì´ë“œ í‘œì‹œ í•¨ìˆ˜
        function showWelcomeGuide() {
            // ì²« ë°©ë¬¸ì¸ì§€ í™•ì¸
            const hasVisitedBefore = localStorage.getItem('hasVisitedBefore');
            
            if (!hasVisitedBefore) {
                // ê°€ì´ë“œ ì»¨í…Œì´ë„ˆ ìƒì„±
                const guideContainer = document.createElement('div');
                guideContainer.className = 'camera-guide';
                guideContainer.innerHTML = `
                    <h3>ê³ ê¸‰ ëª…í•¨ ì¸ì‹ ì‹œìŠ¤í…œ ì‚¬ìš© ê°€ì´ë“œ</h3>
                    <p>ì€í–‰ ìˆ˜ì¤€ì˜ OCR ê¸°ìˆ ë¡œ ë” ì •í™•í•œ ëª…í•¨ ì¸ì‹ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                    <ul>
                        <li>ë°ì€ í™˜ê²½ì—ì„œ ëª…í•¨ì„ í™”ë©´ ì¤‘ì•™ì— ìœ„ì¹˜ì‹œí‚¤ì„¸ìš”.</li>
                        <li>í™”ë©´ì— í‘œì‹œëœ ê°€ì´ë“œ í”„ë ˆì„ì— ëª…í•¨ì„ ë§ì¶°ì£¼ì„¸ìš”.</li>
                        <li>í”ë“¤ë¦¼ ì—†ì´ ì´¬ì˜í•˜ê³ , í’ˆì§ˆ ì§€í‘œê°€ ë…¹ìƒ‰ì¼ ë•Œ ì´¬ì˜í•˜ì„¸ìš”.</li>
                        <li>ìµœì  ìƒíƒœê°€ ê°ì§€ë˜ë©´ ìë™ ì´¬ì˜ ë²„íŠ¼ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</li>
                    </ul>
                    <button id="closeGuideBtn" style="background-color: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 4px; margin-top: 10px;">í™•ì¸</button>
                `;
                
                // ì¹´ë©”ë¼ ì»¨í…ì¸  ìƒë‹¨ì— ì¶”ê°€
                const cameraContent = document.getElementById('cameraContent');
                cameraContent.insertBefore(guideContainer, cameraContent.firstChild);
                
                // ê°€ì´ë“œ ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
                document.getElementById('closeGuideBtn').addEventListener('click', () => {
                    guideContainer.style.display = 'none';
                    localStorage.setItem('hasVisitedBefore', 'true');
                });
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¤ì • ë° ì €ì¥ëœ ëª…í•¨ ë¶ˆëŸ¬ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', () => {
            // ì„¤ì • ë¡œë“œ
            loadSettings();
            
            // ì¹´ë©”ë¼ ì ‘ê·¼ ë²„íŠ¼ ì´ˆê¸° í‘œì‹œ
            accessCameraBtn.style.display = 'block';
            video.style.display = 'none';
            captureBtn.style.display = 'none';
            
            // ì €ì¥ëœ ëª…í•¨ ë¶ˆëŸ¬ì˜¤ê¸°
            loadBusinessCards();
            
            // MediaDevices API ì§€ì› í™•ì¸
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showStatus('ì´ ë¸Œë¼ìš°ì €ëŠ” ì¹´ë©”ë¼ ì ‘ê·¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. íŒŒì¼ ì—…ë¡œë“œë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.', 'error');
                accessCameraBtn.disabled = true;
                accessCameraBtn.textContent = 'ì¹´ë©”ë¼ ì§€ì›ë˜ì§€ ì•ŠìŒ';
            }
            
            // OpenCV ìƒíƒœ ì²´í¬
            if (typeof cv !== 'undefined') {
                onOpenCvReady();
            } else {
                opencvStatus.innerHTML = '<div class="spinner"></div> OpenCV.js ë¡œë”© ì¤‘... ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
            }
            
            // Tesseract ì´ˆê¸°í™”
            initTesseract();
            
            // AI ëª¨ë¸ ì‚¬ì „ ë¡œë”© (ì„¤ì •ì— ë”°ë¼)
            if (appSettings.useAI) {
                setTimeout(() => {
                    loadUSEModel().catch(err => console.warn('AI ëª¨ë¸ ì‚¬ì „ ë¡œë”© ì‹¤íŒ¨:', err));
                }, 3000); // 3ì´ˆ í›„ ëª¨ë¸ ë¡œë”© ì‹œì‘
            }
            
            // í’ˆì§ˆ ìƒì„¸ ì •ë³´ í† ê¸€ ì´ë²¤íŠ¸ ì„¤ì •
            document.getElementById('detailsToggle').addEventListener('click', () => {
                const qualityDetails = document.getElementById('qualityDetails');
                qualityDetails.classList.toggle('active');
            });
            
            // ëª…í•¨ ê°ì§€ í† ê¸€ ì¶”ê°€
            addCardDetectionToggle();
            
            // í™˜ì˜ ê°€ì´ë“œ í‘œì‹œ
            showWelcomeGuide();
            
            // ì˜¤ë¥˜ ì €í•­ì„± ì„¤ì •
            setupErrorResistantApp();
        });
        
        // ëª¨ë‹¬ ë‹«ê¸°
        closeModal.addEventListener('click', () => {
            editModal.style.display = 'none';
        });
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.addEventListener('click', (e) => {
            if (e.target === editModal) {
                editModal.style.display = 'none';
            } else if (e.target === importModal) {
                importModal.style.display = 'none';
            }
        });
    </script>
</body>
</html>
