<!DOCTYPE html> 
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BWMS Annual Service Management</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <!-- Excel Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f1c40f;
            --danger-color: #e74c3c;
            --background-color: #ecf0f1;
            --text-color: #2c3e50;
            --border-color: #bdc3c7;
            --table-header-bg: #2c3e50;
            --table-border: #ddd;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 250px;
            background-color: var(--secondary-color);
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .menu-buttons {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .bottom-content {
            margin-top: auto;
            padding-top: 20px;
        }

        .brand-logo {
            margin: 20px auto;
            width: 100%;
            padding: 10px;
        }

        .brand-image {
            width: 100%;
            height: auto;
            display: block;
        }

        .add-owner-btn, .del-owner-btn {
            color: white;
            border: none;
            padding: 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
            width: 100%;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .add-owner-btn {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
        }

        .add-owner-btn:hover {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            transform: translateY(-2px);
        }

        .del-owner-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .del-owner-btn:hover {
            background: linear-gradient(45deg, #c0392b, #e74c3c);
            transform: translateY(-2px);
        }

        .sidebar button {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .sidebar button:hover {
            background-color: #2980b9;
            transform: translateX(5px);
        }

        .sidebar button.active {
            background-color: #2980b9;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .owner-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }

        .owner-select-btn {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .owner-select-btn:hover {
            background: #f5f5f5;
        }

        .owner-select-btn.selected {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 20px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-container input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }

        .statistics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .table-container {
            flex-grow: 1;
            overflow: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px;
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            min-width: 1800px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--table-border);
            border-right: 1px solid var(--table-border);
            font-size: 13px;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        th {
            background-color: var(--table-header-bg);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: 600;
            text-align: left;
            padding-left: 12px;
        }

        .remarks-cell {
            width: 200px;
            height: 80px;
            max-height: 80px;
            overflow-y: auto;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            display: block;
            padding: 5px;
            border-radius: 4px;
            background-color: #fff;
        }

        table td {
            vertical-align: top;
            height: 100px;
        }

        td:nth-child(10),
        td:nth-child(11) {
            width: 200px;
            min-width: 200px;
            max-width: 200px;
            padding: 5px;
            vertical-align: top;
        }

        .status-normal {
            color: var(--success-color);
            font-weight: bold;
        }

        .status-partial {
            color: var(--warning-color);
            font-weight: bold;
        }

        .status-not {
            color: var(--danger-color);
            font-weight: bold;
        }

        .pdf-link {
            color: #3498db;
            text-decoration: underline;
            cursor: pointer;
            margin-right: 10px;
        }

        .pdf-container {
            min-width: 150px;
        }

        .pdf-list {
            margin-bottom: 8px;
            max-height: 60px;
            overflow-y: auto;
        }

        .pdf-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .delete-pdf-btn {
            padding: 0 6px;
            margin-left: 5px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-pdf-btn:hover {
            background-color: #c0392b;
        }

        .upload-btn {
            padding: 4px 8px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .upload-btn:hover {
            background-color: #2980b9;
        }

        .contract-completed,
        .contract-service,
        .contract-terminated {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .contract-completed {
            background-color: #d4edda;
            color: var(--success-color);
        }

        .contract-service {
            background-color: #fff3cd;
            color: var(--warning-color);
        }

        .contract-terminated {
            background-color: #f8d7da;
            color: var(--danger-color);
        }

        .service-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .service-count {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            padding: 2px 0;
            cursor: pointer;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 80%;
            max-width: 1000px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            max-height: 100px;
            overflow-y: auto;
            resize: vertical;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .error-message {
            color: var(--danger-color);
            background-color: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }

        #connectionStatus {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .highlight-overdue {
            background-color: yellow;
        }

        /* 날짜 보기 모달 스타일 */
        #dateViewModal .modal-content {
            max-width: 600px;
        }

        .date-list {
            margin: 10px 0;
            padding: 0;
            list-style: none;
        }

        .date-list li {
            margin: 5px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="connectionStatus">Checking Firebase Connection...</div>
    <div class="sidebar">
        <div class="brand-logo">
            <img src="https://pds.saramin.co.kr/company/logo/202002/24/q676t0_a5ak-ya4cjo_logo.jpg" alt="Brand Logo" class="brand-image">
        </div>
        <div class="menu-buttons">
            <button onclick="changeCompany('PAN OCEAN')" class="active">PAN OCEAN</button>
            <button onclick="changeCompany('NAVIGARE CAPITAL')">NAVIGARE CAPITAL</button>
            <button onclick="changeCompany('K-LINE')">K-LINE</button>
            <div id="customCompanyButtons"></div>
        </div>
        <div class="bottom-content">
            <button onclick="showAddOwnerModal()" class="add-owner-btn">ADD OWNER</button>
            <button onclick="showDelOwnerModal()" class="del-owner-btn">DEL OWNER</button>
            <a href="https://snsys-qa.neoali.com" target="_blank" style="text-decoration:none;">
                <div style="background: linear-gradient(45deg, #2b3a67, #1a2b4b); padding:12px; border-radius:4px; color:white; text-align:center; margin-bottom:20px;">
                    S&SYS AI CUSTOMER SERVICE
                </div>
            </a>
        </div>
        <div id="delOwnerModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <span class="close" onclick="closeModal('delOwnerModal')">&times;</span>
                <h2>Delete Owner</h2>
                <div class="form-group">
                    <label>Select Owner to Delete:</label>
                    <div id="ownerButtonsContainer" class="owner-buttons-container">
                        <!-- 버튼들이 여기에 동적으로 추가됩니다 -->
                    </div>
                </div>
                <div id="deleteConfirmSection" style="display: none;">
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="deletePassword">
                    </div>
                    <div class="button-group">
                        <button onclick="confirmOwnerDeletion()" class="btn btn-danger">Delete</button>
                        <button onclick="cancelDeletion()" class="btn btn-secondary">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <h1 id="categoryTitle">BWMS Annual Service Management - PAN OCEAN </h1>
            
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Search by IMO No, Ship Name...">
                <button onclick="searchTable()" class="btn btn-primary">Search</button>
            </div>

            <div class="statistics">
                <div class="stat-card">
                    <h3>Total Ships</h3>
                    <div class="stat-value" id="totalShips">0</div>
                </div>
                <div class="stat-card">
                    <h3>Normal Operation</h3>
                    <div class="stat-value" id="normalOps">0</div>
                </div>
                <div class="stat-card">
                    <h3>Services Needed</h3>
                    <div class="stat-value" id="servicesNeeded">0</div>
                </div>
                <div class="stat-card">
                    <h3>Active Contracts</h3>
                    <div class="stat-value" id="activeContracts">0</div>
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <table id="serviceTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" onclick="toggleAllCheckboxes()"></th>
                        <th>IMO No.</th>
                        <th>Ship Name</th>
                        <th>Delivery Date</th>
                        <th>ASP Start Date</th>
                        <th>ASP Finish Date</th>
                        <th style="min-width: 150px;">Onboarding Service</th>
                        <th style="min-width: 150px;">RMS Service</th>
                        <th>Current Status</th>
                        <th>Service Remarks</th>
                        <th>Next Plan</th>
                        <th>Contract Status</th>
                        <th>Service Report</th>
                        <th>Edit</th>
                    </tr>
                </thead>
                <tbody id="serviceBody"></tbody>
            </table>
        </div>

        <div class="button-group">
            <button onclick="showAddModal()" class="btn btn-primary">Add New Entry</button>
            <button onclick="deleteSelectedRows()" class="btn btn-danger">Delete Selected</button>
            <button onclick="saveToFirebase()" class="btn btn-primary">Save Changes</button>
            <button onclick="showHistory()" class="btn btn-secondary">View History</button>
            <button onclick="downloadExcel()" class="btn btn-primary">Download Excel</button>
            <input type="file" id="uploadExcel" accept=".xlsx, .xls" style="display:none;" onchange="uploadExcel(event)">
            <button onclick="document.getElementById('uploadExcel').click()" class="btn btn-secondary">Upload Excel</button>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="serviceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('serviceModal')">&times;</span>
            <h2 id="modalTitle">Add New Service Entry</h2>
            <form id="serviceForm">
                <div class="form-group">
                    <label>IMO No.</label>
                    <input type="text" id="imoNo" pattern="[0-9]{7}" title="Please enter a valid 7-digit IMO number">
                </div>
                <div class="form-group">
                    <label>Ship Name</label>
                    <input type="text" id="shipName">
                </div>
                <div class="form-group">
                    <label>Delivery Date</label>
                    <input type="date" id="deliveryDate">
                </div>
                <div class="form-group">
                    <label>ASP Start Date</label>
                    <input type="date" id="contractDate">
                </div>
                <div class="form-group">
                    <label>ASP Finish Date</label>
                    <input type="date" id="finishedDate">
                </div>
                <div class="form-group">
                    <label>Onboarding Service Contract</label>
                    <input type="number" id="onboardingContract" min="0">
                </div>
                <div class="form-group">
                    <label>Onboarding Service Completed</label>
                    <input type="number" id="onboardingCompleted" min="0">
                </div>
                <div class="form-group" id="onboardingDatesContainer"></div>

                <div class="form-group">
                    <label>RMS Service Contract</label>
                    <input type="number" id="rmsContract" min="0">
                </div>
                <div class="form-group">
                    <label>RMS Service Completed</label>
                    <input type="number" id="rmsCompleted" min="0">
                </div>
                <div class="form-group" id="rmsDatesContainer"></div>

                <div class="form-group">
                    <label>Current Status</label>
                    <select id="currentStatus">
                        <option value="Normal Operation">Normal Operation</option>
                        <option value="Partial Operation">Partial Operation</option>
                        <option value="Not Operation">Not Operation</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Service Remarks</label>
                    <textarea id="serviceRemarks" rows="5" style="height: 100px;"></textarea>
                </div>
                <div class="form-group">
                    <label>Next Plan</label>
                    <textarea id="nextPlan" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Contract Status</label>
                    <select id="contractStatus">
                        <option value="Contract Completed">Contract Completed</option>
                        <option value="In Service">In Service</option>
                        <option value="Contract Terminated">Contract Terminated</option>
                    </select>
                </div>
                <div class="button-group">
                    <button type="button" onclick="saveServiceEntry()" class="btn btn-primary">Save</button>
                    <button type="button" onclick="closeModal('serviceModal')" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('historyModal')">&times;</span>
            <h2>Change History</h2>
            <div id="historyContent"></div>
        </div>
    </div>

    <!-- Add Owner Modal -->
    <div id="addOwnerModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close" onclick="closeModal('addOwnerModal')">&times;</span>
            <h2>Add New Owner</h2>
            <div class="form-group">
                <label>Owner Name:</label>
                <input type="text" id="newOwnerName">
            </div>
            <div class="button-group">
                <button onclick="addNewOwner()" class="btn btn-primary">Add</button>
                <button onclick="closeModal('addOwnerModal')" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- PDF Upload Modal -->
    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('pdfModal')">&times;</span>
            <h2>Upload Service Report</h2>
            <form id="pdfUploadForm">
                <div class="form-group">
                    <label>Select PDF File</label>
                    <input type="file" id="pdfFile" accept=".pdf">
                </div>
                <div class="button-group">
                    <button type="button" onclick="uploadPDF()" class="btn btn-primary">Upload</button>
                    <button type="button" onclick="closeModal('pdfModal')" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Date View Modal -->
    <div id="dateViewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('dateViewModal')">&times;</span>
            <h2 id="dateViewTitle"></h2>
            <ul class="date-list" id="dateList"></ul>
        </div>
    </div>

    <div id="errorLog" class="error-message"></div>

<script>
// Firebase 초기화 (자신의 Firebase 설정값으로 변경 필요)
const firebaseConfig = {
    apiKey: "AIzaSyCoOg2HPjk-oEhtVrLv3hH-3VLCwa2MAfE",
    authDomain: "sanghoon-d8f1c.firebaseapp.com",
    databaseURL: "https://sanghoon-d8f1c-default-rtdb.firebaseio.com",
    projectId: "sanghoon-d8f1c",
    storageBucket: "sanghoon-d8f1c.appspot.com",
    messagingSenderId: "495391900753",
    appId: "1:495391900753:web:b0d708eeca64fafe562470",
    measurementId: "G-J2E22BW61H"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const storage = firebase.storage().ref();

let currentCompany = 'PAN OCEAN';
let currentType = 'VESSEL';
let previousData = [];
let currentImoNo = '';
let selectedOwner = null;

// Firebase 연결 테스트
function testConnection() {
    const testRef = database.ref('test');
    testRef.set({
        timestamp: Date.now(),
        test: true
    })
    .then(() => {
        document.getElementById('connectionStatus').innerHTML = 
            '<span style="color: green;">Connected to Firebase ✓</span>';
    })
    .catch((error) => {
        console.error("Firebase 연결 실패:", error);
        document.getElementById('connectionStatus').innerHTML = 
            '<span style="color: red;">Firebase Connection Failed ✗</span>';
    });
}

window.onload = function() {
    testConnection();
    loadFromFirebase();
    loadCustomCompanies();
    addServiceFormListeners();
};

function addServiceFormListeners() {
    const onboardingContractInput = document.getElementById('onboardingContract');
    const onboardingCompletedInput = document.getElementById('onboardingCompleted');
    const rmsContractInput = document.getElementById('rmsContract');
    const rmsCompletedInput = document.getElementById('rmsCompleted');

    onboardingContractInput.addEventListener('input', generateDateFields);
    onboardingCompletedInput.addEventListener('input', generateDateFields);
    rmsContractInput.addEventListener('input', generateDateFields);
    rmsCompletedInput.addEventListener('input', generateDateFields);
}

function generateDateFields() {
    // 기존 필드 값 저장
    const oldOnboardingPredicted = Array.from(document.querySelectorAll('.onboardingPredictedDates')).map(i => i.value);
    const oldOnboardingCompleted = Array.from(document.querySelectorAll('.onboardingCompletedDates')).map(i => i.value);
    const oldRmsPredicted = Array.from(document.querySelectorAll('.rmsPredictedDates')).map(i => i.value);
    const oldRmsCompleted = Array.from(document.querySelectorAll('.rmsCompletedDates')).map(i => i.value);

    const onboardingContract = parseInt(document.getElementById('onboardingContract').value) || 0;
    const onboardingCompleted = parseInt(document.getElementById('onboardingCompleted').value) || 0;
    const rmsContract = parseInt(document.getElementById('rmsContract').value) || 0;
    const rmsCompleted = parseInt(document.getElementById('rmsCompleted').value) || 0;

    const onboardingDatesContainer = document.getElementById('onboardingDatesContainer');
    const rmsDatesContainer = document.getElementById('rmsDatesContainer');
    onboardingDatesContainer.innerHTML = '';
    rmsDatesContainer.innerHTML = '';

    // Onboarding Dates
    if (onboardingContract > 0) {
        let html = '<label>Onboarding Predicted Dates (total '+ onboardingContract +'):</label>';
        for (let i = 0; i < onboardingContract; i++) {
            html += `<input type="date" class="onboardingPredictedDates">`;
        }
        html += `<label>Onboarding Completed Dates (total ${onboardingCompleted}):</label>`;
        for (let i = 0; i < onboardingCompleted; i++) {
            html += `<input type="date" class="onboardingCompletedDates">`;
        }
        onboardingDatesContainer.innerHTML = html;
    }

    // RMS Dates
    if (rmsContract > 0) {
        let html = '<label>RMS Predicted Dates (total '+ rmsContract +'):</label>';
        for (let i = 0; i < rmsContract; i++) {
            html += `<input type="date" class="rmsPredictedDates">`;
        }
        html += `<label>RMS Completed Dates (total ${rmsCompleted}):</label>`;
        for (let i = 0; i < rmsCompleted; i++) {
            html += `<input type="date" class="rmsCompletedDates">`;
        }
        rmsDatesContainer.innerHTML = html;
    }

    // 새 필드에 이전 값 복원
    const newOnboardingPredicted = document.querySelectorAll('.onboardingPredictedDates');
    const newOnboardingCompleted = document.querySelectorAll('.onboardingCompletedDates');
    const newRmsPredicted = document.querySelectorAll('.rmsPredictedDates');
    const newRmsCompleted = document.querySelectorAll('.rmsCompletedDates');

    oldOnboardingPredicted.forEach((val, i) => {
        if (newOnboardingPredicted[i]) newOnboardingPredicted[i].value = val;
    });
    oldOnboardingCompleted.forEach((val, i) => {
        if (newOnboardingCompleted[i]) newOnboardingCompleted[i].value = val;
    });
    oldRmsPredicted.forEach((val, i) => {
        if (newRmsPredicted[i]) newRmsPredicted[i].value = val;
    });
    oldRmsCompleted.forEach((val, i) => {
        if (newRmsCompleted[i]) newRmsCompleted[i].value = val;
    });
}

// 회사 변경
function changeCompany(company) {
    currentCompany = company;
    document.querySelectorAll('.sidebar button').forEach(btn => {
        if (btn.textContent.trim() === company) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    document.getElementById('categoryTitle').textContent = 
        `BWMS Annual Service Management - ${company}`;
    
    loadFromFirebase();
}

function loadCustomCompanies() {
    const customCompaniesRef = database.ref('custom-companies');
    customCompaniesRef.once('value')
        .then(snapshot => {
            const container = document.getElementById('customCompanyButtons');
            container.innerHTML = '';
            
            snapshot.forEach(child => {
                const companyName = child.val();
                const button = document.createElement('button');
                button.textContent = companyName;
                button.onclick = () => changeCompany(companyName);
                container.appendChild(button);
            });
        })
        .catch(error => {
            console.error('Error loading custom companies:', error);
        });
}

function loadFromFirebase() {
    database.ref(`bwms-service/${currentCompany}/VESSEL`).once('value')
        .then((snapshot) => {
            let data = snapshot.val() || {};
            const dataArray = Array.isArray(data) ? data : Object.values(data);

            const sortedData = dataArray.sort((a, b) => {
                const priority = {
                    'In Service': 1,
                    'Contract Completed': 2,
                    'Contract Terminated': 3
                };
                return priority[a.contractStatus] - priority[b.contractStatus];
            });
            
            displayData(sortedData);
            previousData = [...sortedData];
            updateStatistics();
        })
        .catch((error) => {
            showError('Error loading data: ' + error.message);
        });
}

function isOverdue(row) {
    const today = new Date().setHours(0,0,0,0);

    // Onboarding check
    for (let i = 0; i < (row.onboardingContract || 0); i++) {
        const predDate = row.onboardingPredictedDates && row.onboardingPredictedDates[i] ? new Date(row.onboardingPredictedDates[i]).setHours(0,0,0,0) : null;
        if (predDate && predDate < today) {
            if (!row.onboardingCompletedDates || !row.onboardingCompletedDates[i]) {
                return true;
            }
        }
    }

    // RMS check
    for (let i = 0; i < (row.rmsContract || 0); i++) {
        const predDate = row.rmsPredictedDates && row.rmsPredictedDates[i] ? new Date(row.rmsPredictedDates[i]).setHours(0,0,0,0) : null;
        if (predDate && predDate < today) {
            if (!row.rmsCompletedDates || !row.rmsCompletedDates[i]) {
                return true;
            }
        }
    }

    return false;
}

function displayData(data) {
    const tbody = document.getElementById('serviceBody');
    tbody.innerHTML = '';

    data.forEach((row) => {
        const remainingOnboarding = row.onboardingContract - row.onboardingCompleted;
        const remainingRms = row.rmsContract - row.rmsCompleted;

        const overdue = isOverdue(row);
        
        const onboardingRemainingClass = overdue && remainingOnboarding > 0 ? 'highlight-overdue' : '';
        const rmsRemainingClass = overdue && remainingRms > 0 ? 'highlight-overdue' : '';

        const tr = document.createElement('tr');
        
        tr.innerHTML = `
            <td><input type="checkbox" class="row-checkbox"></td>
            <td>${row.imoNo}</td>
            <td>${row.shipName}</td>
            <td>${row.deliveryDate || ''}</td>
            <td>${row.contractDate || ''}</td>
            <td>${row.finishedDate || ''}</td>
            <td>
                <div class="service-details">
                    <div class="service-count" onclick="showDatesModal('onboarding','predicted','${row.imoNo}')">
                        Contracted: <span>${row.onboardingContract}</span>
                    </div>
                    <div class="service-count" onclick="showDatesModal('onboarding','completed','${row.imoNo}')">
                        Completed: <span>${row.onboardingCompleted}</span>
                    </div>
                    <div class="service-count ${onboardingRemainingClass}" onclick="showDatesModal('onboarding','remaining','${row.imoNo}')">
                        Remaining: <span>${remainingOnboarding}</span>
                    </div>
                </div>
            </td>
            <td>
                <div class="service-details">
                    <div class="service-count" onclick="showDatesModal('rms','predicted','${row.imoNo}')">
                        Contracted: <span>${row.rmsContract}</span>
                    </div>
                    <div class="service-count" onclick="showDatesModal('rms','completed','${row.imoNo}')">
                        Completed: <span>${row.rmsCompleted}</span>
                    </div>
                    <div class="service-count ${rmsRemainingClass}" onclick="showDatesModal('rms','remaining','${row.imoNo}')">
                        Remaining: <span>${remainingRms}</span>
                    </div>
                </div>
            </td>
            <td>
                <span class="status-${row.currentStatus.toLowerCase().split(' ')[0]}">
                    ${row.currentStatus}
                </span>
            </td>
            <td><div class="remarks-cell">${row.serviceRemarks || ''}</div></td>
            <td><div class="remarks-cell">${row.nextPlan || ''}</div></td>
            <td>
                <span class="contract-${row.contractStatus.toLowerCase().replace(' ', '-')}">
                    ${row.contractStatus}
                </span>
            </td>
            <td>
                <div class="pdf-container">  
                    <div class="pdf-list">
                        ${row.pdfs ? Object.entries(row.pdfs).map(([key, pdfUrl]) => `
                            <div class="pdf-item">
                                <a href="${pdfUrl}" target="_blank" class="pdf-link">PDF_${key.slice(-8)}</a>
                                <button class="delete-pdf-btn" onclick="deletePDF('${row.imoNo}', '${key}')">×</button>
                            </div>
                        `).join('') : ''}
                    </div>
                    <button class="upload-btn" onclick="showPdfModal('${row.imoNo}')">Upload PDF</button>
                </div>
            </td>
            <td>
                <button class="edit-btn" onclick="showEditModal('${row.imoNo}')">Edit</button>
            </td>
        `;
        
        tbody.appendChild(tr);
    });
}

function showDatesModal(serviceType, dateType, imoNo) {
    const row = previousData.find(r => r.imoNo === imoNo);
    if (!row) return;

    let title = '';
    let dateArray = [];

    if (serviceType === 'onboarding') {
        if (dateType === 'predicted') {
            title = 'Onboarding Predicted Dates';
            dateArray = row.onboardingPredictedDates || [];
        } else if (dateType === 'completed') {
            title = 'Onboarding Completed Dates';
            dateArray = row.onboardingCompletedDates || [];
        } else {
            // remaining
            title = 'Onboarding Remaining Dates (Uncompleted Predicted)';
            const predicted = row.onboardingPredictedDates || [];
            const completed = row.onboardingCompletedDates || [];
            dateArray = predicted.map((p,i) => (!completed[i] ? p : null)).filter(d=>d);
        }
    } else {
        if (dateType === 'predicted') {
            title = 'RMS Predicted Dates';
            dateArray = row.rmsPredictedDates || [];
        } else if (dateType === 'completed') {
            title = 'RMS Completed Dates';
            dateArray = row.rmsCompletedDates || [];
        } else {
            // remaining
            title = 'RMS Remaining Dates (Uncompleted Predicted)';
            const predicted = row.rmsPredictedDates || [];
            const completed = row.rmsCompletedDates || [];
            dateArray = predicted.map((p,i) => (!completed[i] ? p : null)).filter(d=>d);
        }
    }

    document.getElementById('dateViewTitle').textContent = title;
    const dateList = document.getElementById('dateList');
    dateList.innerHTML = '';
    if (dateArray.length === 0) {
        const li = document.createElement('li');
        li.textContent = 'No dates available';
        dateList.appendChild(li);
    } else {
        dateArray.forEach(d => {
            const li = document.createElement('li');
            li.textContent = d;
            dateList.appendChild(li);
        });
    }

    document.getElementById('dateViewModal').style.display = 'block';
}

function updateStatistics() {
    const data = previousData;
    
    document.getElementById('totalShips').textContent = data.length;
    
    const normalOps = data.filter(row => row.currentStatus === 'Normal Operation').length;
    document.getElementById('normalOps').textContent = normalOps;
    
    const servicesNeeded = data.filter(row => 
        row.currentStatus === 'Partial Operation' || 
        row.currentStatus === 'Not Operation'
    ).length;
    document.getElementById('servicesNeeded').textContent = servicesNeeded;
    
    const activeContracts = data.filter(row => row.contractStatus === 'In Service').length;
    document.getElementById('activeContracts').textContent = activeContracts;
}

function showError(message) {
    const errorLog = document.getElementById('errorLog');
    errorLog.textContent = message;
    errorLog.style.display = 'block';
    setTimeout(() => {
        errorLog.style.display = 'none';
    }, 5000);
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function showAddOwnerModal() {
    document.getElementById('addOwnerModal').style.display = 'block';
    document.getElementById('newOwnerName').value = '';
}

function addNewOwner() {
    const ownerName = document.getElementById('newOwnerName').value.trim();
    
    if (!ownerName) {
        showError('Please enter an owner name');
        return;
    }

    const customCompaniesRef = database.ref('custom-companies');
    customCompaniesRef.push(ownerName)
        .then(() => {
            closeModal('addOwnerModal');
            loadCustomCompanies();
        })
        .catch(error => {
            showError('Error adding owner: ' + error.message);
        });
}

function showDelOwnerModal() {
    document.getElementById('delOwnerModal').style.display = 'block';
    loadOwnerButtons();
    resetDeleteModal();
}

function resetDeleteModal() {
    selectedOwner = null;
    document.getElementById('deleteConfirmSection').style.display = 'none';
    document.getElementById('deletePassword').value = '';
}

function loadOwnerButtons() {
    const container = document.getElementById('ownerButtonsContainer');
    container.innerHTML = '';
    
    const defaultOwners = ['PAN OCEAN', 'NAVIGARE CAPITAL', 'K-LINE'];
    defaultOwners.forEach(owner => {
        addOwnerButton(owner, container);
    });
    
    const customCompaniesRef = database.ref('custom-companies');
    customCompaniesRef.once('value')
        .then(snapshot => {
            snapshot.forEach(child => {
                addOwnerButton(child.val(), container);
            });
        });
}

function addOwnerButton(ownerName, container) {
    const button = document.createElement('button');
    button.className = 'owner-select-btn';
    button.textContent = ownerName;
    button.onclick = () => selectOwnerForDeletion(ownerName, button);
    container.appendChild(button);
}

function selectOwnerForDeletion(ownerName, button) {
    document.querySelectorAll('.owner-select-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    button.classList.add('selected');
    selectedOwner = ownerName;
    document.getElementById('deleteConfirmSection').style.display = 'block';
}

function cancelDeletion() {
    resetDeleteModal();
}

async function confirmOwnerDeletion() {
    if (!selectedOwner) {
        showError('Please select an owner to delete');
        return;
    }

    const password = document.getElementById('deletePassword').value;
    if (password.toUpperCase() !== "SNSYS") {
        showError("Incorrect password. Delete cancelled.");
        return;
    }

    try {
        const snapshot = await database.ref('custom-companies').once('value');
        let ownerKey = null;
        snapshot.forEach(child => {
            if (child.val() === selectedOwner) {
                ownerKey = child.key;
            }
        });

        if (ownerKey) {
            await database.ref(`custom-companies/${ownerKey}`).remove();
        }
        
        await database.ref(`bwms-service/${selectedOwner}`).remove();
        await database.ref(`history/${selectedOwner}`).remove();
        
        const historyEntry = {
            name: prompt("Enter your name for the record:") || 'Unknown',
            timestamp: new Date().toISOString(),
            action: "Owner Deleted",
            changes: [`Deleted owner: ${selectedOwner}`]
        };
        
        await database.ref('history/system').push(historyEntry);
        
        if (currentCompany === selectedOwner) {
            changeCompany('PAN OCEAN');
        }
        
        closeModal('delOwnerModal');
        loadCustomCompanies();
        alert('Owner deleted successfully');
    } catch (error) {
        showError('Error deleting owner: ' + error.message);
    }
}

function validateForm() {
    return validateServiceNumbers() && validateDates();
}

function validateServiceNumbers() {
    const onboardingContract = parseInt(document.getElementById('onboardingContract').value) || 0;
    const onboardingCompleted = parseInt(document.getElementById('onboardingCompleted').value) || 0;
    const rmsContract = parseInt(document.getElementById('rmsContract').value) || 0;
    const rmsCompleted = parseInt(document.getElementById('rmsCompleted').value) || 0;

    if (onboardingCompleted > onboardingContract) {
        showError('Completed Onboarding services cannot exceed contracted services');
        return false;
    }

    if (rmsCompleted > rmsContract) {
        showError('Completed RMS services cannot exceed contracted services');
        return false;
    }

    return true;
}

function validateDates() {
    const deliveryDateVal = document.getElementById('deliveryDate').value;
    const contractDateVal = document.getElementById('contractDate').value;
    const finishedDateVal = document.getElementById('finishedDate').value;

    // 날짜가 비어있으면 검증을 하지 않고 통과
    if (deliveryDateVal && contractDateVal) {
        const deliveryDate = new Date(deliveryDateVal);
        const contractDate = new Date(contractDateVal);
        if (contractDate < deliveryDate) {
            showError('ASP Start Date cannot be earlier than delivery date');
            return false;
        }
    }

    if (contractDateVal && finishedDateVal) {
        const contractDate = new Date(contractDateVal);
        const finishedDate = new Date(finishedDateVal);
        if (finishedDate < contractDate) {
            showError('ASP Finish Date cannot be earlier than ASP Start Date');
            return false;
        }
    }

    return true;
}

document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchTable();
    }
});

window.onclick = function(event) {
    if (event.target.className === 'modal') {
        event.target.style.display = 'none';
    }
};

document.getElementById('imoNo').addEventListener('input', function(e) {
    let value = e.target.value;
    value = value.replace(/[^0-9]/g, '');
    if (value.length > 7) {
        value = value.slice(0, 7);
    }
    e.target.value = value;
});

function showAddModal() {
    document.getElementById('modalTitle').textContent = 'Add New Service Entry';
    document.getElementById('serviceForm').reset();
    document.getElementById('imoNo').readOnly = false;
    document.getElementById('onboardingDatesContainer').innerHTML = '';
    document.getElementById('rmsDatesContainer').innerHTML = '';
    document.getElementById('serviceModal').style.display = 'block';
}

function showEditModal(imoNo) {
    document.getElementById('modalTitle').textContent = 'Edit Service Entry';
    
    const rowData = previousData.find(row => row.imoNo === imoNo);
    if (!rowData) return;
    
    document.getElementById('imoNo').value = rowData.imoNo;
    document.getElementById('shipName').value = rowData.shipName;
    document.getElementById('deliveryDate').value = rowData.deliveryDate || '';
    document.getElementById('contractDate').value = rowData.contractDate || '';
    document.getElementById('finishedDate').value = rowData.finishedDate || '';
    document.getElementById('onboardingContract').value = rowData.onboardingContract;
    document.getElementById('onboardingCompleted').value = rowData.onboardingCompleted;
    document.getElementById('rmsContract').value = rowData.rmsContract;
    document.getElementById('rmsCompleted').value = rowData.rmsCompleted;
    document.getElementById('currentStatus').value = rowData.currentStatus;
    document.getElementById('serviceRemarks').value = rowData.serviceRemarks || '';
    document.getElementById('nextPlan').value = rowData.nextPlan || '';
    document.getElementById('contractStatus').value = rowData.contractStatus;
    document.getElementById('imoNo').readOnly = true;

    generateDateFields();

    // 기존 predictedDates, completedDates 반영
    const onboardingPredictedInputs = document.querySelectorAll('.onboardingPredictedDates');
    const onboardingCompletedInputs = document.querySelectorAll('.onboardingCompletedDates');
    const rmsPredictedInputs = document.querySelectorAll('.rmsPredictedDates');
    const rmsCompletedInputs = document.querySelectorAll('.rmsCompletedDates');

    if (rowData.onboardingPredictedDates) {
        rowData.onboardingPredictedDates.forEach((d,i) => {
            if (onboardingPredictedInputs[i]) onboardingPredictedInputs[i].value = d;
        });
    }

    if (rowData.onboardingCompletedDates) {
        rowData.onboardingCompletedDates.forEach((d,i) => {
            if (onboardingCompletedInputs[i]) onboardingCompletedInputs[i].value = d;
        });
    }

    if (rowData.rmsPredictedDates) {
        rowData.rmsPredictedDates.forEach((d,i) => {
            if (rmsPredictedInputs[i]) rmsPredictedInputs[i].value = d;
        });
    }

    if (rowData.rmsCompletedDates) {
        rowData.rmsCompletedDates.forEach((d,i) => {
            if (rmsCompletedInputs[i]) rmsCompletedInputs[i].value = d;
        });
    }

    document.getElementById('serviceModal').style.display = 'block';
}

function saveServiceEntry() {
    const form = document.getElementById('serviceForm');
    if (!validateForm()) {
        return;
    }

    const onboardingPredictedInputs = document.querySelectorAll('.onboardingPredictedDates');
    const onboardingCompletedInputs = document.querySelectorAll('.onboardingCompletedDates');
    const rmsPredictedInputs = document.querySelectorAll('.rmsPredictedDates');
    const rmsCompletedInputs = document.querySelectorAll('.rmsCompletedDates');

    const formData = {
        imoNo: document.getElementById('imoNo').value,
        shipName: document.getElementById('shipName').value,
        deliveryDate: document.getElementById('deliveryDate').value || '',
        contractDate: document.getElementById('contractDate').value || '',
        finishedDate: document.getElementById('finishedDate').value || '',
        onboardingContract: parseInt(document.getElementById('onboardingContract').value) || 0,
        onboardingCompleted: parseInt(document.getElementById('onboardingCompleted').value) || 0,
        rmsContract: parseInt(document.getElementById('rmsContract').value) || 0,
        rmsCompleted: parseInt(document.getElementById('rmsCompleted').value) || 0,
        currentStatus: document.getElementById('currentStatus').value,
        serviceRemarks: document.getElementById('serviceRemarks').value,
        nextPlan: document.getElementById('nextPlan').value,
        contractStatus: document.getElementById('contractStatus').value
    };

    formData.onboardingPredictedDates = Array.from(onboardingPredictedInputs).map(i => i.value);
    formData.onboardingCompletedDates = Array.from(onboardingCompletedInputs).map(i => i.value);
    formData.rmsPredictedDates = Array.from(rmsPredictedInputs).map(i => i.value);
    formData.rmsCompletedDates = Array.from(rmsCompletedInputs).map(i => i.value);

    const data = [...previousData];
    const index = data.findIndex(row => row.imoNo === formData.imoNo);
    
    if (index !== -1) {
        if (data[index].pdfs) {
            formData.pdfs = data[index].pdfs;
        }
        data[index] = formData;
    } else {
        data.push(formData);
    }

    saveToFirebase(data);
    closeModal('serviceModal');
}

function showPdfModal(imoNo) {
    currentImoNo = imoNo;
    document.getElementById('pdfModal').style.display = 'block';
    document.getElementById('pdfFile').value = '';
}

async function uploadPDF() {
    const fileInput = document.getElementById('pdfFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showError('Please select a PDF file');
        return;
    }

    try {
        const timestamp = Date.now();
        const filePath = `service-reports/${currentCompany}/VESSEL/${currentImoNo}_${timestamp}.pdf`;
        const fileRef = storage.child(filePath);

        await fileRef.put(file);
        const downloadURL = await fileRef.getDownloadURL();

        const data = [...previousData];
        const index = data.findIndex(row => row.imoNo === currentImoNo);

        if (index !== -1) {
            if (!data[index].pdfs) {
                data[index].pdfs = {};
            }
            data[index].pdfs[`pdf_${timestamp}`] = downloadURL;

            await database.ref(`bwms-service/${currentCompany}/VESSEL`).set(data);

            const historyEntry = {
                name: prompt("Enter your name for the record:") || 'Unknown',
                timestamp: new Date().toISOString(),
                action: "PDF Upload",
                changes: [`Uploaded service report PDF for IMO: ${currentImoNo}`]
            };

            await database.ref(`history/${currentCompany}/VESSEL`).push(historyEntry);

            closeModal('pdfModal');
            loadFromFirebase();
            alert('PDF uploaded successfully');
        }
    } catch (error) {
        console.error('Error during PDF upload:', error);
        showError(`Error uploading PDF: ${error.message}`);
    }
}

/** 추가 기능 구현 **/
function toggleAllCheckboxes() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.row-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
}

function searchTable() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    const filtered = previousData.filter(row => {
        return row.imoNo.toString().includes(query) ||
               (row.shipName && row.shipName.toLowerCase().includes(query));
    });
    displayData(filtered);
}

function deleteSelectedRows() {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    const rowsToDelete = [];
    checkboxes.forEach((cb) => {
        if (cb.checked) {
            const imoNo = cb.closest('tr').children[1].textContent;
            rowsToDelete.push(imoNo);
        }
    });

    if (rowsToDelete.length === 0) {
        alert('No rows selected to delete.');
        return;
    }

    const newData = previousData.filter(row => !rowsToDelete.includes(row.imoNo));
    saveToFirebase(newData);
}

async function saveToFirebase(data) {
    if (!data) data = previousData;
    try {
        await database.ref(`bwms-service/${currentCompany}/VESSEL`).set(data);

        const historyEntry = {
            name: prompt("Enter your name for the record:") || 'Unknown',
            timestamp: new Date().toISOString(),
            action: "Data Saved",
            changes: ["Data saved to Firebase"]
        };
        await database.ref(`history/${currentCompany}/VESSEL`).push(historyEntry);

        previousData = data;
        loadFromFirebase();
        alert('Changes saved successfully.');
    } catch (err) {
        showError('Failed to save: ' + err.message);
    }
}

async function showHistory() {
    const historyRef = database.ref(`history/${currentCompany}/VESSEL`);
    const snapshot = await historyRef.once('value');
    const data = snapshot.val() || {};
    const entries = Object.values(data);

    const historyContent = document.getElementById('historyContent');
    historyContent.innerHTML = '';

    entries.forEach(entry => {
        const div = document.createElement('div');
        div.innerHTML = `<strong>${entry.timestamp}</strong> - ${entry.name} - ${entry.action}<br>${entry.changes.join(', ')}`;
        historyContent.appendChild(div);
        historyContent.appendChild(document.createElement('hr'));
    });

    document.getElementById('historyModal').style.display = 'block';
}

function downloadExcel() {
    const ws = XLSX.utils.json_to_sheet(previousData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Data");
    XLSX.writeFile(wb, "BWMS_Data.xlsx");
}

function uploadExcel(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, {raw: false});
        
        saveToFirebase(jsonData);
    };
    reader.readAsArrayBuffer(file);
}

async function deletePDF(imoNo, key) {
    const index = previousData.findIndex(row => row.imoNo === imoNo);
    if (index === -1) return;
    if (!previousData[index].pdfs || !previousData[index].pdfs[key]) return;

    delete previousData[index].pdfs[key];
    await database.ref(`bwms-service/${currentCompany}/VESSEL`).set(previousData);

    const historyEntry = {
        name: prompt("Enter your name for the record:") || 'Unknown',
        timestamp: new Date().toISOString(),
        action: "PDF Deleted",
        changes: [`Deleted PDF: ${key} from IMO: ${imoNo}`]
    };
    await database.ref(`history/${currentCompany}/VESSEL`).push(historyEntry);

    loadFromFirebase();
    alert('PDF deleted successfully');
}
</script>
</body>
</html>
