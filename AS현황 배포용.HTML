<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>AS í˜„í™© ê´€ë¦¬ (í†µí•© + AI ìš”ì•½)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- XLSX (SheetJS) for Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>

  <style>
    :root {
      --font-size-base: 14px;
      --sidebar-bg: #1e3d59;
      --sidebar-bg2: #183046;
      --sidebar-btn: #315b8a;
      --primary-color: #315b8a;
      --secondary-color: #1e3d59;
      --background-color: #f5f7fa;
      --border-color: #d1d5db;
      --highlight-color: #e0eaf3;
      --text-color: #2d3e50;
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: sans-serif;
      font-size: var(--font-size-base);
      display: flex; height: 100vh; overflow: hidden;
      background: var(--background-color); color: var(--text-color);
    }
    .hidden { display: none; }

    /* ë¡œê·¸ì¸ ëª¨ë‹¬ */
    #loginModal {
      display:block; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%;
      background:rgba(0,0,0,0.3);
    }
    #loginModal .modal-content {
      background:#fff; margin:10% auto; width:300px; border-radius:6px;
      padding:10px; position:relative;
    }
    #loginModal h2 { margin:0 0 10px; }
    #loginModal .form-group { margin-bottom:8px; }
    #loginModal .form-group label { font-weight:600; margin-bottom:2px; display:block; }
    #loginModal .form-group input {
      width:100%; padding:6px; border:1px solid #ccc; border-radius:4px;
    }
    #loginModal .btn-row {
      display:flex; justify-content:flex-end; gap:8px; margin-top:10px;
    }
    #loginModal button {
      background:var(--primary-color); color:#fff; border:none; border-radius:4px;
      cursor:pointer; font-size:0.85em; padding:6px 10px;
    }

    /* ì‚¬ì´ë“œë°” */
    .sidebar {
      width: 240px; background: linear-gradient(180deg, var(--sidebar-bg) 0%, var(--sidebar-bg2) 100%);
      padding: 10px; overflow-y: auto;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    .sidebar .mode-buttons {
      display: flex; gap: 5px; margin-bottom: 10px;
    }
    .sidebar button {
      display: block; width: 100%; padding: 8px; margin-bottom: 5px;
      background: var(--sidebar-btn); color: #fff;
      border: none; border-radius: 4px; cursor: pointer; font-size: 0.95em;
      transition: 0.2s all; text-align: left;
    }
    .sidebar button:hover {
      background: #2b4f7a; transform: translateY(-2px);
    }
    .sidebar h3 {
      color:#fff; margin-bottom:8px; border-bottom:1px solid rgba(255,255,255,0.3);
      font-size:1em; font-weight:600; padding-bottom:4px;
    }
    .sidebar .item-list { display: flex; flex-direction: column; gap:4px; }
    .sidebar .bottom-area { margin-top: 20px; }
    .user-manage-btn {
      background:#6c757d;
    }
    .user-manage-btn:hover {
      background:#5a6268;
    }

    /* ë©”ì¸ */
    .container {
      flex:1; display:flex; flex-direction:column; overflow:hidden;
    }
    .header {
      background:#fff; padding:10px; box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
    .header h1 { font-size:1.2em; color:var(--primary-color); }
    #connectionStatus { font-weight:bold; margin-top:5px; }

    /* ìƒíƒœ ì§‘ê³„ */
    .status-summary {
      display:flex; gap: 10px; padding: 5px;
      background: #fff; border-bottom:1px solid var(--border-color);
    }
    .status-card {
      background:#fafafa; border:1px solid var(--border-color); border-radius:4px;
      padding:4px 6px; flex:1; text-align:center;
    }
    .status-card h3 { font-size:0.9em; margin-bottom:3px; }
    .status-card .count { font-weight:bold; font-size:1em; }

    /* í•„í„° */
    .filters {
      display:flex; flex-wrap:wrap; gap:10px; padding:5px;
      background:#fafafa; border-bottom:1px solid var(--border-color);
    }
    .filters .filter-group {
      display:flex; flex-direction:column; font-size:0.9em;
    }
    .filters label { font-weight:600; margin-bottom:2px; }
    .filters input, .filters select {
      padding:4px; border:1px solid var(--border-color); border-radius:4px;
      font-size:0.9em; width:120px;
    }

    /* í…Œì´ë¸” ì˜ì—­ */
    .table-container {
      flex:1; overflow:auto; background:#fff; margin:0; padding:0;
      border-top:1px solid var(--border-color); position:relative;
    }
    table {
      border-collapse: separate; border-spacing: 0; width:100%;
      min-width: 2000px; font-size:var(--font-size-base);
    }
    th, td {
      border:1px solid var(--border-color);
      padding:6px; text-align:left; position:relative;
      transition: background 0.2s;
      vertical-align: top;
      white-space: nowrap;
    }
    th {
      background:var(--primary-color); color:#fff; font-weight:500;
      position:sticky; top:0; z-index:10; user-select:none; cursor:default;
    }
    tr:hover td { background:var(--highlight-color); }

    /* í–‰ ë†’ì´ ì¡°ì ˆ */
    .row-resizer {
      position: absolute; left:0; bottom:0; width:100%; height:5px;
      background:rgba(0,0,0,0.1); cursor:row-resize;
      opacity:0; transition:0.2s;
    }
    tr:hover .row-resizer { opacity:1; }

    /* ì—´ í­ ì¡°ì ˆ */
    .col-resizer {
      position:absolute; right:0; top:0; width:5px; height:100%;
      cursor:col-resize; user-select:none;
    }
    .col-resizer:hover { background:rgba(255,255,255,0.3); }

    /* í•˜ë‹¨ ë²„íŠ¼ */
    .bottom-controls {
      display:flex; flex-wrap:wrap; gap:8px; padding:8px;
      background:#fff; border-top:1px solid var(--border-color);
    }
    .bottom-controls button {
      background:var(--primary-color); color:#fff; border:none;
      border-radius:4px; cursor:pointer; font-size:0.9em;
      padding:6px 10px; transition:0.2s all;
    }
    .bottom-controls button:hover {
      background:#2b4f7a; transform: translateY(-2px);
    }

    /* íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ */
    #historyModal {
      display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%;
      background:rgba(0,0,0,0.3);
    }
    #historyModal .modal-content {
      background:#fff; margin:5% auto; width:80%; max-width:1000px; border-radius:8px;
      max-height:80%; overflow-y:auto; position:relative; padding:10px;
    }
    #historyModal .close {
      position:absolute; right:15px; top:10px; font-size:18px; cursor:pointer;
    }
    #historyModal h2 { margin-top:0; margin-bottom:5px; font-size:1em; }
    #historyModal .history-list { list-style:disc; margin-left:25px; }

    /* ì‚¬ìš©ì ê´€ë¦¬ ëª¨ë‹¬ */
    #userModal {
      display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%;
      background:rgba(0,0,0,0.3);
    }
    #userModal .modal-content {
      background:#fff; margin:5% auto; width:400px; border-radius:6px;
      padding:10px; position:relative;
    }
    #userModal .close { position:absolute; right:10px; top:10px; cursor:pointer; font-size:18px; }
    #userModal h2 { margin:0 0 10px; font-size:1em; }
    #userModal .form-group { margin-bottom:8px; }
    #userModal .form-group label { display:block; font-weight:600; margin-bottom:2px; }
    #userModal input[type="text"], #userModal input[type="password"] {
      width:100%; padding:6px; border:1px solid #ccc; border-radius:4px;
    }
    #userModal .btn-row {
      display:flex; gap:8px; justify-content:flex-end; margin-top:10px;
    }
    #userModal .btn-row button {
      background:var(--primary-color); color:#fff; border:none; border-radius:4px;
      cursor:pointer; font-size:0.85em; padding:6px 10px;
    }

    /* ì—‘ì…€ ì—…ë¡œë“œ ëª¨ë‹¬ */
    #excelModal {
      display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%;
      background:rgba(0,0,0,0.3);
    }
    #excelModal .modal-content {
      background:#fff; margin:10% auto; width:300px; border-radius:6px; padding:10px; position:relative;
      text-align:center;
    }
    #excelModal .btn-row {
      display:flex; gap:8px; justify-content:center; margin-top:10px;
    }
    #excelModal button {
      background:var(--primary-color); color:#fff; border:none; border-radius:4px;
      cursor:pointer; font-size:0.85em; padding:6px 10px;
    }

    /* ì„¸ë¶€ ì—´ ìµœì†Œí­ */
    th[data-field="ê³µë²ˆ"], td[data-field="ê³µë²ˆ"] { min-width: 100px; }
    th[data-field="ê³µì‚¬"], td[data-field="ê³µì‚¬"] { min-width: 50px; }
    th[data-field="imo"], td[data-field="imo"] { min-width: 90px; }
    th[data-field="hull"], td[data-field="hull"] { min-width: 80px; }
    th[data-field="shipName"], td[data-field="shipName"] { min-width: 150px; }
    th[data-field="repMail"], td[data-field="repMail"] { min-width: 150px; }
    th[data-field="shipType"], td[data-field="shipType"] { min-width: 60px; }
    th[data-field="scale"], td[data-field="scale"] { min-width: 80px; }
    th[data-field="êµ¬ë¶„"], td[data-field="êµ¬ë¶„"] { min-width: 20px; }
    th[data-field="shipowner"], td[data-field="shipowner"] { min-width: 180px; }
    th[data-field="major"], td[data-field="major"] { min-width: 100px; }
    th[data-field="group"], td[data-field="group"] { min-width: 30px; }
    th[data-field="shipyard"], td[data-field="shipyard"] { min-width: 80px; }
    th[data-field="contract"], td[data-field="contract"] { min-width: 80px; }
    th[data-field="asType"], td[data-field="asType"] { min-width: 80px; }
    th[data-field="delivery"], td[data-field="delivery"] { min-width: 110px; }
    th[data-field="warranty"], td[data-field="warranty"] { min-width: 110px; }
    th[data-field="prevManager"], td[data-field="prevManager"] { min-width: 70px; }
    th[data-field="manager"], td[data-field="manager"] { min-width: 70px; }
    th[data-field="í˜„í™©"], td[data-field="í˜„í™©"] { min-width: 400px; }
    th[data-field="ë™ì‘ì—¬ë¶€"], td[data-field="ë™ì‘ì—¬ë¶€"] { min-width: 70px; }
    th[data-field="ì¡°ì¹˜ê³„íš"], td[data-field="ì¡°ì¹˜ê³„íš"] { min-width: 150px; }
    th[data-field="ì ‘ìˆ˜ë‚´ìš©"], td[data-field="ì ‘ìˆ˜ë‚´ìš©"] { min-width: 150px; }
    th[data-field="ì¡°ì¹˜ê²°ê³¼"], td[data-field="ì¡°ì¹˜ê²°ê³¼"] { min-width: 150px; }
    th[data-field="ASì ‘ìˆ˜ì¼ì"], td[data-field="ASì ‘ìˆ˜ì¼ì"] { min-width: 110px; }
    th[data-field="ê¸°ìˆ ì ì¢…ë£Œì¼"], td[data-field="ê¸°ìˆ ì ì¢…ë£Œì¼"] { min-width: 110px; }
    th[data-field="ì§€ì—° ì‚¬ìœ "], td[data-field="ì§€ì—° ì‚¬ìœ "] { min-width: 300px; }

    /* ë‚´ìš© ëª¨ë‹¬ */
    #contentModal {
      display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%;
      background:rgba(0,0,0,0.3);
    }
    #contentModal .modal-content {
      background:#fff; margin:5% auto; width:600px; border-radius:6px;
      padding:10px; position:relative;
    }
    #contentModal .close {
      position:absolute; right:15px; top:10px; font-size:18px; cursor:pointer;
    }
    #contentModal h2 {
      margin-top:0; margin-bottom:10px; font-size:1em;
    }
    #contentText {
      white-space: pre-wrap;
      line-height: 1.4;
      font-size: 0.95em;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 8px;
      border-radius: 4px;
    }

    /* (ì‹ ê·œ) ì„ ì‚¬ë³„ AI ìš”ì•½ ëª¨ë‹¬ */
    #ownerAIModal {
      display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%;
      background:rgba(0,0,0,0.3);
    }
    #ownerAIModal .modal-content {
      background:#fff; margin:5% auto; width:600px; border-radius:6px;
      padding:10px; position:relative; max-height:70%; overflow-y:auto;
    }
    #ownerAIModal .close {
      position:absolute; right:15px; top:10px; font-size:18px; cursor:pointer;
    }
    #ownerAISummaryText {
      white-space: pre-wrap;
      line-height:1.4; 
      font-size:0.95em;
      border:1px solid #ccc; 
      padding:8px; 
      border-radius:4px;
      margin-top:10px;
      min-height:200px;
    }
  </style>
</head>
<body>

  <!-- 1) ë¡œê·¸ì¸ ëª¨ë‹¬ -->
  <div id="loginModal">
    <div class="modal-content">
      <h2>ì‚¬ìš©ì ë¡œê·¸ì¸</h2>
      <div class="form-group">
        <label>ì‚¬ìš©ìëª…</label>
        <input type="text" id="loginUser">
      </div>
      <div class="form-group">
        <label>ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" id="loginPw">
      </div>
      <div class="btn-row">
        <button id="loginConfirmBtn">ë¡œê·¸ì¸</button>
      </div>
      <p id="loginError" style="color:red; margin-top:5px; font-size:0.85em;"></p>
    </div>
  </div>

  <!-- 2) ì‚¬ì´ë“œë°” -->
  <div class="sidebar hidden" id="sidebar">
    <div class="mode-buttons">
      <button id="btnManager" class="active">ë‹´ë‹¹ì</button>
      <button id="btnOwner">ì„ ì£¼ì‚¬</button>
    </div>
    <h3 id="listTitle">ë‹´ë‹¹ì ëª©ë¡</h3>
    <div class="item-list" id="itemList"></div>
    <div class="bottom-area">
      <button class="user-manage-btn" id="userManageBtn">ì‚¬ìš©ì ê´€ë¦¬</button>
    </div>
  </div>

  <!-- 3) ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
  <div class="container hidden" id="mainContainer">
    <div class="header">
      <h1>AS í˜„í™© ê´€ë¦¬</h1>
      <div id="connectionStatus">ì—°ê²° ìƒíƒœ: í™•ì¸ ì¤‘...</div>
    </div>

    <!-- ë™ì‘ì—¬ë¶€ ì§‘ê³„ -->
    <div class="status-summary">
      <div class="status-card">
        <h3>ì •ìƒA</h3>
        <div class="count" id="countì •ìƒA">0</div>
      </div>
      <div class="status-card">
        <h3>ì •ìƒB</h3>
        <div class="count" id="countì •ìƒB">0</div>
      </div>
      <div class="status-card">
        <h3>ìœ ìƒì •ìƒ</h3>
        <div class="count" id="countìœ ìƒì •ìƒ">0</div>
      </div>
      <div class="status-card">
        <h3>ë¶€ë¶„ë™ì‘</h3>
        <div class="count" id="countë¶€ë¶„ë™ì‘">0</div>
      </div>
      <div class="status-card">
        <h3>ë™ì‘ë¶ˆê°€</h3>
        <div class="count" id="countë™ì‘ë¶ˆê°€">0</div>
      </div>
    </div>

    <!-- í•„í„° ì˜ì—­ -->
    <div class="filters">
      <div class="filter-group">
        <label>IMO NO.</label>
        <input type="text" id="filterIMO" oninput="renderTable()">
      </div>
      <div class="filter-group">
        <label>HULL NO.</label>
        <input type="text" id="filterHull" oninput="renderTable()">
      </div>
      <div class="filter-group">
        <label>SHIPNAME</label>
        <input type="text" id="filterName" oninput="renderTable()">
      </div>
      <div class="filter-group">
        <label>SHIPOWNER</label>
        <input type="text" id="filterOwner" oninput="renderTable()">
      </div>
      <div class="filter-group">
        <label>ì£¼ìš”ì„ ì‚¬</label>
        <input type="text" id="filterMajor" oninput="renderTable()">
      </div>
      <div class="filter-group">
        <label>ê·¸ë£¹</label>
        <select id="filterGroup" onchange="renderTable()">
          <option value="">ì „ì²´</option>
          <option value="1">1</option><option value="2">2</option>
          <option value="3">3</option><option value="4">4</option>
          <option value="5">5</option><option value="6">6</option>
        </select>
      </div>
      <div class="filter-group">
        <label>AS êµ¬ë¶„</label>
        <select id="filterAsType" onchange="renderTable()">
          <option value="">ì „ì²´</option>
          <option value="ë¬´ìƒ">ë¬´ìƒ</option>
          <option value="ìœ ìƒ">ìœ ìƒ</option>
          <option value="ìœ„íƒ">ìœ„íƒ</option>
        </select>
      </div>
      <div class="filter-group">
        <label>í˜„ ë‹´ë‹¹</label>
        <input type="text" id="filterManager" oninput="renderTable()">
      </div>
      <div class="filter-group">
        <label>ë™ì‘ì—¬ë¶€</label>
        <select id="filterActive" onchange="renderTable()">
          <option value="">ì „ì²´</option>
          <option value="ì •ìƒA">ì •ìƒA</option>
          <option value="ì •ìƒB">ì •ìƒB</option>
          <option value="ìœ ìƒì •ìƒ">ìœ ìƒì •ìƒ</option>
          <option value="ë¶€ë¶„ë™ì‘">ë¶€ë¶„ë™ì‘</option>
          <option value="ë™ì‘ë¶ˆê°€">ë™ì‘ë¶ˆê°€</option>
        </select>
      </div>
    </div>

    <div class="table-container" id="tableContainer">
      <table id="asTable">
        <thead>
          <tr>
            <th style="width:30px;"><input type="checkbox" id="selectAll"></th>
            <th data-field="ê³µë²ˆ">ê³µë²ˆ<div class="col-resizer"></div></th>
            <th data-field="ê³µì‚¬">ê³µì‚¬<div class="col-resizer"></div></th>
            <th data-field="imo">IMO NO.<div class="col-resizer"></div></th>
            <th data-field="hull">HULL NO.<div class="col-resizer"></div></th>
            <th data-field="shipName">SHIPNAME<div class="col-resizer"></div></th>
            <th data-field="repMail">í˜¸ì„  ëŒ€í‘œë©”ì¼<div class="col-resizer"></div></th>
            <th data-field="shipType">SHIP TYPE<div class="col-resizer"></div></th>
            <th data-field="scale">SCALE<div class="col-resizer"></div></th>
            <th data-field="êµ¬ë¶„">êµ¬ë¶„<div class="col-resizer"></div></th>
            <th data-field="shipowner">SHIPOWNER<div class="col-resizer"></div></th>
            <th data-field="major">ì£¼ìš”ì„ ì‚¬<div class="col-resizer"></div></th>
            <th data-field="group">ê·¸ë£¹<div class="col-resizer"></div></th>
            <th data-field="shipyard">SHIPYARD<div class="col-resizer"></div></th>
            <th data-field="contract">ê³„ì•½<div class="col-resizer"></div></th>
            <th data-field="asType">AS êµ¬ë¶„<div class="col-resizer"></div></th>
            <th data-field="delivery">ì¸ë„ì¼<div class="col-resizer"></div></th>
            <th data-field="warranty">ë³´ì¦ì¢…ë£Œì¼<div class="col-resizer"></div></th>
            <th data-field="prevManager">ì „ ë‹´ë‹¹<div class="col-resizer"></div></th>
            <th data-field="manager">í˜„ ë‹´ë‹¹<div class="col-resizer"></div></th>
            <th data-field="í˜„í™©">í˜„í™©<div class="col-resizer"></div></th>
            <th data-field="ë™ì‘ì—¬ë¶€">ë™ì‘ì—¬ë¶€<div class="col-resizer"></div></th>

            <th data-field="ì¡°ì¹˜ê³„íš">ì¡°ì¹˜ê³„íš<div class="col-resizer"></div></th>
            <th data-field="ì ‘ìˆ˜ë‚´ìš©">ì ‘ìˆ˜ë‚´ìš©<div class="col-resizer"></div></th>
            <th data-field="ì¡°ì¹˜ê²°ê³¼">ì¡°ì¹˜ê²°ê³¼<div class="col-resizer"></div></th>
            <th data-field="ASì ‘ìˆ˜ì¼ì">ASì ‘ìˆ˜ì¼ì<div class="col-resizer"></div></th>
            <th data-field="ê¸°ìˆ ì ì¢…ë£Œì¼">ê¸°ìˆ ì ì¢…ë£Œì¼<div class="col-resizer"></div></th>

            <!-- AI ìš”ì•½ ë²„íŠ¼ -->
            <th>AI ìš”ì•½</th>

            <!-- ê²½ê³¼ì¼ / ì •ìƒì§€ì—° / ì§€ì—° ì‚¬ìœ  -->
            <th data-field="ê²½ê³¼ì¼">ê²½ê³¼ì¼<div class="col-resizer"></div></th>
            <th data-field="ì •ìƒì§€ì—°">ì •ìƒì§€ì—°<div class="col-resizer"></div></th>
            <th data-field="ì§€ì—° ì‚¬ìœ ">ì§€ì—° ì‚¬ìœ <div class="col-resizer"></div></th>
          </tr>
        </thead>
        <tbody id="asBody"></tbody>
      </table>
    </div>

    <div class="bottom-controls">
      <button id="addRowBtn">í–‰ ì¶”ê°€</button>
      <button id="deleteRowBtn">ì„ íƒ í–‰ ì‚­ì œ</button>
      <button id="saveBtn">ì €ì¥</button>
      <button id="loadBtn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button id="downloadExcelBtn">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
      <input type="file" id="uploadExcelInput" style="display:none;" accept=".xlsx,.xls">
      <button id="uploadExcelBtn">ì—‘ì…€ ì—…ë¡œë“œ</button>

      <input type="file" id="uploadAsStatusInput" style="display:none;" accept=".xlsx,.xls">
      <button id="uploadAsStatusBtn">AS í˜„í™© ì—…ë¡œë“œ</button>
      <button id="historyBtn">íˆìŠ¤í† ë¦¬ ì¡°íšŒ</button>
      <button id="clearHistoryBtn">íˆìŠ¤í† ë¦¬ ì „ì²´ ì‚­ì œ</button>
      <button id="ownerAISummaryBtn" style="background:#6c757d;">ì„ ì‚¬ë³„ AI ìš”ì•½</button>
    </div>
  </div>

  <!-- 4) íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ -->
  <div id="historyModal">
    <div class="modal-content">
      <span class="close" onclick="closeHistoryModal()">&times;</span>
      <h2>ë³€ê²½ ì´ë ¥</h2>
      <ul class="history-list" id="historyList"></ul>
    </div>
  </div>

  <!-- 5) ì‚¬ìš©ì ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="userModal">
    <div class="modal-content">
      <span class="close" onclick="closeUserModal()">&times;</span>
      <h2>ì‚¬ìš©ì ê´€ë¦¬</h2>
      <div id="userList" style="border:1px solid #ccc; padding:6px; margin-bottom:10px; max-height:150px; overflow:auto;"></div>
      <div class="btn-row">
        <button id="deleteSelectedUsersBtn">ì„ íƒ ì‚¬ìš©ì ì‚­ì œ</button>
      </div>
      <hr style="margin:10px 0;">
      <h3>ìƒˆ ì‚¬ìš©ì ì¶”ê°€</h3>
      <div class="form-group">
        <label>ì‚¬ìš©ìëª…</label>
        <input type="text" id="newUserName">
      </div>
      <div class="form-group">
        <label>ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" id="newUserPw">
      </div>
      <div class="btn-row">
        <button id="addUserConfirmBtn">ì¶”ê°€</button>
        <button onclick="closeUserModal()">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <!-- 6) ì—‘ì…€ ì—…ë¡œë“œ ëª¨ë‹¬ -->
  <div id="excelModal">
    <div class="modal-content">
      <h3>ì—‘ì…€ ì—…ë¡œë“œ ë°©ì‹ ì„ íƒ</h3>
      <div class="btn-row">
        <button id="excelReplaceBtn">ê¸°ì¡´ ì‚­ì œ í›„ ì—…ë¡œë“œ</button>
        <button id="excelAppendBtn">ì¶”ê°€ë§Œ</button>
        <button id="excelCancelBtn">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <!-- 7) ë‚´ìš© ë³´ê¸° ëª¨ë‹¬ -->
  <div id="contentModal">
    <div class="modal-content">
      <span class="close" onclick="closeContentModal()">&times;</span>
      <h2>ì „ì²´ ë‚´ìš©</h2>
      <div id="contentText"></div>
    </div>
  </div>

  <!-- 8) ì„ ì‚¬ë³„ AI ìš”ì•½ ëª¨ë‹¬ -->
  <div id="ownerAIModal">
    <div class="modal-content">
      <span class="close" onclick="document.getElementById('ownerAIModal').style.display='none';">&times;</span>
      <h2>ì„ ì‚¬ë³„ ì ‘ìˆ˜ë‚´ìš©/ì¡°ì¹˜ê²°ê³¼ ìš”ì•½</h2>
      <p style="font-size:0.85em; color:#666;">(í˜„ì¬ í•„í„°ì˜ ì„ ì‚¬(SHIPOWNER) ê¸°ì¤€ìœ¼ë¡œ AI ìš”ì•½)</p>
      <div id="ownerAISummaryText">ë¡œë”© ì „...</div>
    </div>
  </div>

  <!-- =========
       ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ 
       ========= -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
  /************************************************************
   * 0) ì „ì—­ ë³€ìˆ˜
   ************************************************************/
  let db = null;        // Firebase Database
  let asData = [];      // AS ì „ì²´ ë°ì´í„°
  let currentUser = null;
  let adminAuthorized = false;
  let currentMode = 'manager';
  let sortField = '';
  let sortAsc = true;

  const asPath = 'as-service/data';
  const histPath = 'as-service/history';
  const userPath = 'as-service/users';

  /************************************************************
   * 1) Firebase ì´ˆê¸°í™”: Netlify Functionsë¡œ í‚¤ ìˆ¨ê¸°ê¸°
   *    (fetch('/.netlify/functions/firebaseConfig'))
   ************************************************************/
  async function initFirebase(){
    try {
      const res = await fetch('/.netlify/functions/firebaseConfig');
      if(!res.ok){
        throw new Error('Firebase Config í˜¸ì¶œ ì‹¤íŒ¨');
      }
      const data = await res.json();
      if(!data.config){
        throw new Error('Firebase config ì—†ìŒ');
      }
      // í´ë¼ì´ì–¸íŠ¸ì—ì„œ Firebase ì´ˆê¸°í™”
      firebase.initializeApp(data.config);
      db = firebase.database();
      document.getElementById('connectionStatus').textContent="Firebase ì—°ê²°ë¨ (ì„œë²„ë¦¬ìŠ¤)";
      document.getElementById('connectionStatus').style.color="green";
    } catch(e){
      console.error(e);
      document.getElementById('connectionStatus').textContent="Firebase ì—°ê²° ì‹¤íŒ¨";
      document.getElementById('connectionStatus').style.color="red";
    }
  }

  /************************************************************
   * 2) Gemini í˜¸ì¶œ: Netlify Functionsë¡œ í‚¤ ìˆ¨ê¸°ê¸°
   *    (fetch('/.netlify/functions/gemini'))
   ************************************************************/
  async function callGeminiForSummary(contentText){
    try {
      const res = await fetch('/.netlify/functions/gemini', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ contentText })
      });
      const data = await res.json();
      if(!res.ok){
        console.error("Gemini API error:", data);
        return "";
      }
      return data.summary || "ìš”ì•½ ì‹¤íŒ¨";
    } catch(err){
      console.error("Gemini fetch error:", err);
      return "";
    }
  }

  /************************************************************
   * í˜ì´ì§€ ë¡œë“œ ì‹œ
   ************************************************************/
  window.onload = async ()=>{
    // (A) Firebase init
    await initFirebase();

    // (B) ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬
    const loggedIn = sessionStorage.getItem("loggedIn");
    if(loggedIn==="true"){
      document.getElementById('loginModal').style.display='none';
      document.getElementById('sidebar').classList.remove('hidden');
      document.getElementById('mainContainer').classList.remove('hidden');
      loadData();
    } else {
      document.getElementById('loginModal').style.display='block';
    }

    // ì—”í„°í‚¤ ë¡œê·¸ì¸
    document.getElementById('loginPw').addEventListener('keydown', e=>{
      if(e.key==='Enter') doLogin();
    });
  };

  /************************************************************
   * 3) ë¡œê·¸ì¸
   ************************************************************/
  async function doLogin(){
    const un = document.getElementById('loginUser').value.trim();
    const pw = document.getElementById('loginPw').value.trim();
    if(!un || !pw){
      document.getElementById('loginError').textContent="ì‚¬ìš©ìëª…/ë¹„ë²ˆ ì…ë ¥ í•„ìˆ˜.";
      return;
    }
    // Firebase ì‚¬ìš©ì ì²´í¬
    const snap = await db.ref(userPath).once('value');
    const val = snap.val()||{};
    const arr = Object.values(val);
    const found = arr.find(u=>u.username===un && u.password===pw);
    if(found){
      currentUser = found;
      sessionStorage.setItem('loggedIn','true');
      document.getElementById('loginModal').style.display='none';
      document.getElementById('sidebar').classList.remove('hidden');
      document.getElementById('mainContainer').classList.remove('hidden');
      loadData();
    } else {
      document.getElementById('loginError').textContent="ë¡œê·¸ì¸ ì‹¤íŒ¨. ì‚¬ìš©ì/ë¹„ë²ˆ í™•ì¸.";
    }
  }
  document.getElementById('loginConfirmBtn').addEventListener('click', doLogin);

  /************************************************************
   * 4) ë¶ˆëŸ¬ì˜¤ê¸°/ì €ì¥
   ************************************************************/
  async function loadData(){
    const snap = await db.ref(asPath).once('value');
    const val = snap.val()||{};
    asData = Object.values(val);
    renderTable();
  }
  document.getElementById('loadBtn').addEventListener('click', loadData);

  document.getElementById('saveBtn').addEventListener('click', async ()=>{
    if(!confirm("ì „ì²´ ë°ì´í„°ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    const updates = {};
    asData.forEach(r=>{
      updates[r.uid] = r;
    });
    await db.ref(asPath).set(updates);
    alert("ì „ì²´ ì €ì¥ ì™„ë£Œ");
    addHistory("ì „ì²´ ì €ì¥");
  });

  /************************************************************
   * 5) í–‰ ì¶”ê°€/ì‚­ì œ
   ************************************************************/
  document.getElementById('addRowBtn').addEventListener('click',()=>{
    const uid = db.ref().push().key;
    const obj = {
      uid,
      ê³µë²ˆ:'', ê³µì‚¬:'', imo:'', hull:'', shipName:'', repMail:'',
      shipType:'', scale:'', êµ¬ë¶„:'', shipowner:'', major:'', group:'',
      shipyard:'', contract:'', asType:'ìœ ìƒ', delivery:'', warranty:'',
      prevManager:'', manager:'', í˜„í™©:'', ë™ì‘ì—¬ë¶€:'ì •ìƒA',
      ì¡°ì¹˜ê³„íš:'', ì ‘ìˆ˜ë‚´ìš©:'', ì¡°ì¹˜ê²°ê³¼:'',
      ASì ‘ìˆ˜ì¼ì:'', ê¸°ìˆ ì ì¢…ë£Œì¼:'', ì •ìƒì§€ì—°:'', 'ì§€ì—° ì‚¬ìœ ':''
    };
    asData.unshift(obj);
    renderTable();
  });
  document.getElementById('deleteRowBtn').addEventListener('click',()=>{
    const cks=document.querySelectorAll('.rowSelectChk:checked');
    if(!cks.length){ alert("ì‚­ì œí•  í–‰ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
    if(!confirm("ì •ë§ ì‚­ì œ?")) return;
    cks.forEach(chk=>{
      const uid=chk.dataset.uid;
      asData=asData.filter(x=>x.uid!==uid);
    });
    renderTable();
    document.getElementById('selectAll').checked=false;
  });
  document.getElementById('selectAll').addEventListener('change',(e)=>{
    const cks=document.querySelectorAll('.rowSelectChk');
    cks.forEach(ck=>ck.checked=e.target.checked);
  });

  /************************************************************
   * 6) ì •ë ¬/í•„í„°/í…Œì´ë¸”
   ************************************************************/
  let resizingCol=null, startX=0, startW=0;
  document.addEventListener('mousedown',(e)=>{
    if(e.target.classList.contains('col-resizer')){
      resizingCol=e.target.parentElement;
      startX=e.pageX;
      startW=resizingCol.offsetWidth;
      document.addEventListener('mousemove',doColResize);
      document.addEventListener('mouseup',stopColResize);
      e.preventDefault();
    }
  });
  function doColResize(e){
    if(!resizingCol) return;
    const dx=e.pageX-startX;
    resizingCol.style.width=(startW+dx)+'px';
  }
  function stopColResize(){
    document.removeEventListener('mousemove',doColResize);
    document.removeEventListener('mouseup',stopColResize);
    resizingCol=null;
  }

  function renderTable(){
    // ì •ë ¬
    if(sortField){
      asData.sort((a,b)=>{
        const aa=a[sortField]||'';
        const bb=b[sortField]||'';
        if(aa<bb) return sortAsc? -1:1;
        if(aa>bb) return sortAsc? 1:-1;
        return 0;
      });
    }

    // í•„í„°
    const fIMO    = document.getElementById('filterIMO').value.trim().toLowerCase();
    const fHull   = document.getElementById('filterHull').value.trim().toLowerCase();
    const fName   = document.getElementById('filterName').value.trim().toLowerCase();
    const fOwner  = document.getElementById('filterOwner').value.trim().toLowerCase();
    const fMajor  = document.getElementById('filterMajor').value.trim().toLowerCase();
    const fGroup  = document.getElementById('filterGroup').value;
    const fAsType = document.getElementById('filterAsType').value;
    const fMgr    = document.getElementById('filterManager').value.trim().toLowerCase();
    const fActive = document.getElementById('filterActive').value;

    let counts={ì •ìƒA:0, ì •ìƒB:0, ìœ ìƒì •ìƒ:0, ë¶€ë¶„ë™ì‘:0, ë™ì‘ë¶ˆê°€:0};

    const tbody=document.getElementById('asBody');
    tbody.innerHTML='';

    asData.forEach(row=>{
      const imoVal=(row.imo||'').toLowerCase();
      const hullVal=(row.hull||'').toLowerCase();
      const nameVal=(row.shipName||'').toLowerCase();
      const ownVal=(row.shipowner||'').toLowerCase();
      const majVal=(row.major||'').toLowerCase();
      const mgrVal=(row.manager||'').toLowerCase();
      const actVal=(row.ë™ì‘ì—¬ë¶€||'');

      // í•„í„° ì ìš©
      if(fIMO && !imoVal.includes(fIMO)) return;
      if(fHull && !hullVal.includes(fHull)) return;
      if(fName && !nameVal.includes(fName)) return;
      if(fOwner && !ownVal.includes(fOwner)) return;
      if(fMajor && !majVal.includes(fMajor)) return;
      if(fGroup && row.group!==fGroup) return;
      if(fAsType && row.asType!==fAsType) return;
      if(fMgr && !mgrVal.includes(fMgr)) return;
      if(fActive && actVal!==fActive) return;

      if(counts[row.ë™ì‘ì—¬ë¶€]!==undefined){
        counts[row.ë™ì‘ì—¬ë¶€]++;
      }

      const tr=document.createElement('tr');
      // ì²´í¬ë°•ìŠ¤
      let td=document.createElement('td');
      const chk=document.createElement('input');
      chk.type='checkbox';
      chk.classList.add('rowSelectChk');
      chk.dataset.uid=row.uid;
      td.appendChild(chk);
      tr.appendChild(td);

      function onCellChange(e){
        const fld=e.target.dataset.field;
        const oldVal=row[fld]||'';
        let newVal='';
        if(e.target.type==='checkbox'){
          newVal=e.target.checked ? 'Y':'';
        } else {
          newVal=e.target.value;
        }
        if(oldVal===newVal) return;
        row[fld]=newVal;
        // ê²½ê³¼ì¼ ë“± ë°˜ì˜
        if(['ì •ìƒì§€ì—°','ASì ‘ìˆ˜ì¼ì','ê¸°ìˆ ì ì¢…ë£Œì¼'].includes(fld)){
          renderTable();
        }
      }
      function makeCell(val,fld){
        const c=document.createElement('td');
        c.dataset.field=fld;

        // ë‚ ì§œ
        if(['delivery','warranty','ê¸°ìˆ ì ì¢…ë£Œì¼','ASì ‘ìˆ˜ì¼ì'].includes(fld)){
          const inp=document.createElement('input');
          inp.type='date';
          inp.value=val||'';
          inp.dataset.uid=row.uid;
          inp.dataset.field=fld;
          inp.addEventListener('change',onCellChange);
          c.appendChild(inp);
        }
        else if(fld==='asType'){
          const sel=document.createElement('select');
          ['ìœ ìƒ','ë¬´ìƒ','ìœ„íƒ'].forEach(op=>{
            const o=document.createElement('option');
            o.value=op; o.textContent=op;
            sel.appendChild(o);
          });
          sel.value=val||'ìœ ìƒ';
          sel.dataset.uid=row.uid;
          sel.dataset.field=fld;
          sel.addEventListener('change',onCellChange);
          c.appendChild(sel);
        }
        else if(fld==='ë™ì‘ì—¬ë¶€'){
          const sel=document.createElement('select');
          ['ì •ìƒA','ì •ìƒB','ìœ ìƒì •ìƒ','ë¶€ë¶„ë™ì‘','ë™ì‘ë¶ˆê°€'].forEach(op=>{
            const o=document.createElement('option');
            o.value=op; o.textContent=op;
            sel.appendChild(o);
          });
          sel.value=val||'ì •ìƒA';
          sel.dataset.uid=row.uid;
          sel.dataset.field=fld;
          sel.addEventListener('change',onCellChange);
          c.appendChild(sel);
        }
        else if(fld==='imo'){
          const inp=document.createElement('input');
          inp.type='text';
          inp.value=val||'';
          inp.style.width='75%';
          inp.dataset.uid=row.uid;
          inp.dataset.field=fld;
          inp.addEventListener('change',onCellChange);
          c.appendChild(inp);

          const linkIcon=document.createElement('span');
          linkIcon.textContent=' ğŸ”';
          linkIcon.style.cursor='pointer';
          linkIcon.title='ìƒˆ ì°½ì—ì„œ ì¡°íšŒ';
          linkIcon.addEventListener('click',()=>{
            const vv=inp.value.trim();
            if(vv){
              window.open('https://www.vesselfinder.com/vessels/details/'+encodeURIComponent(vv),'_blank');
            }
          });
          c.appendChild(linkIcon);
        }
        else if(['ì¡°ì¹˜ê³„íš','ì ‘ìˆ˜ë‚´ìš©','ì¡°ì¹˜ê²°ê³¼'].includes(fld)){
          const inp=document.createElement('input');
          inp.type='text';
          inp.value=val||'';
          inp.style.width='95%';
          inp.readOnly=true;
          inp.dataset.uid=row.uid;
          inp.dataset.field=fld;
          c.addEventListener('click',()=>openContentModal(val||''));
          c.appendChild(inp);
        }
        else {
          const inp=document.createElement('input');
          inp.type='text';
          inp.value=val||'';
          inp.style.width='95%';
          inp.dataset.uid=row.uid;
          inp.dataset.field=fld;
          inp.addEventListener('change',onCellChange);
          c.appendChild(inp);
        }
        return c;
      }
      function makeElapsedCell(r){
        const c=document.createElement('td');
        c.dataset.field="ê²½ê³¼ì¼";
        if(r.ê¸°ìˆ ì ì¢…ë£Œì¼){
          c.textContent="";
        } else {
          const asDate=r.ASì ‘ìˆ˜ì¼ì||"";
          if(!asDate){
            c.textContent="";
          } else {
            const today=new Date();
            const asD=new Date(asDate+"T00:00");
            if(asD.toString()==='Invalid Date'){
              c.textContent="";
            } else {
              const diff=Math.floor((today-asD)/(1000*3600*24));
              c.textContent= diff<0 ? "0ì¼": diff+"ì¼";
              if(!r.ì •ìƒì§€ì—°){
                if(diff>=90){
                  c.style.backgroundColor='red';
                  c.style.color='#fff';
                } else if(diff>=60){
                  c.style.backgroundColor='orange';
                } else if(diff>=30){
                  c.style.backgroundColor='yellow';
                }
              }
            }
          }
        }
        return c;
      }
      function makeNormalDelayCell(r){
        const c=document.createElement('td');
        c.dataset.field="ì •ìƒì§€ì—°";
        const check=document.createElement('input');
        check.type='checkbox';
        check.dataset.uid=row.uid;
        check.dataset.field="ì •ìƒì§€ì—°";
        check.checked=(r.ì •ìƒì§€ì—°==="Y");
        check.addEventListener('change',onCellChange);
        c.appendChild(check);
        return c;
      }
      function makeDelayReasonCell(r){
        const c=document.createElement('td');
        c.dataset.field="ì§€ì—° ì‚¬ìœ ";
        const inp=document.createElement('input');
        inp.type='text';
        inp.value=r["ì§€ì—° ì‚¬ìœ "]||'';
        inp.style.width='95%';
        inp.dataset.uid=row.uid;
        inp.dataset.field="ì§€ì—° ì‚¬ìœ ";
        inp.addEventListener('change',onCellChange);
        c.appendChild(inp);
        return c;
      }

      tr.appendChild(makeCell(row.ê³µë²ˆ,'ê³µë²ˆ'));
      tr.appendChild(makeCell(row.ê³µì‚¬,'ê³µì‚¬'));
      tr.appendChild(makeCell(row.imo,'imo'));
      tr.appendChild(makeCell(row.hull,'hull'));
      tr.appendChild(makeCell(row.shipName,'shipName'));
      tr.appendChild(makeCell(row.repMail,'repMail'));
      tr.appendChild(makeCell(row.shipType,'shipType'));
      tr.appendChild(makeCell(row.scale,'scale'));
      tr.appendChild(makeCell(row.êµ¬ë¶„,'êµ¬ë¶„'));
      tr.appendChild(makeCell(row.shipowner,'shipowner'));
      tr.appendChild(makeCell(row.major,'major'));
      tr.appendChild(makeCell(row.group,'group'));
      tr.appendChild(makeCell(row.shipyard,'shipyard'));
      tr.appendChild(makeCell(row.contract,'contract'));
      tr.appendChild(makeCell(row.asType,'asType'));
      tr.appendChild(makeCell(row.delivery,'delivery'));
      tr.appendChild(makeCell(row.warranty,'warranty'));
      tr.appendChild(makeCell(row.prevManager,'prevManager'));
      tr.appendChild(makeCell(row.manager,'manager'));
      tr.appendChild(makeCell(row.í˜„í™©,'í˜„í™©'));

      const activeCell=makeCell(row.ë™ì‘ì—¬ë¶€,'ë™ì‘ì—¬ë¶€');
      tr.appendChild(activeCell);

      tr.appendChild(makeCell(row.ì¡°ì¹˜ê³„íš,'ì¡°ì¹˜ê³„íš'));
      tr.appendChild(makeCell(row.ì ‘ìˆ˜ë‚´ìš©,'ì ‘ìˆ˜ë‚´ìš©'));
      tr.appendChild(makeCell(row.ì¡°ì¹˜ê²°ê³¼,'ì¡°ì¹˜ê²°ê³¼'));
      tr.appendChild(makeCell(row.ASì ‘ìˆ˜ì¼ì,'ASì ‘ìˆ˜ì¼ì'));
      tr.appendChild(makeCell(row.ê¸°ìˆ ì ì¢…ë£Œì¼,'ê¸°ìˆ ì ì¢…ë£Œì¼'));

      // AI ìš”ì•½ ë²„íŠ¼
      const aiTd=document.createElement('td');
      const aiBtn=document.createElement('button');
      aiBtn.textContent="AI ìš”ì•½";
      aiBtn.style.background="#6c757d";
      aiBtn.style.color="#fff";
      aiBtn.style.cursor="pointer";
      aiBtn.addEventListener('click',()=>summarizeAndUpdateRow(row.uid));
      aiTd.appendChild(aiBtn);
      tr.appendChild(aiTd);

      tr.appendChild(makeElapsedCell(row));
      tr.appendChild(makeNormalDelayCell(row));
      tr.appendChild(makeDelayReasonCell(row));

      // ìƒ‰ìƒ ê°•ì¡°
      if(row.warranty){
        const wDate=new Date(row.warranty+"T00:00");
        const today=new Date(new Date().toLocaleDateString());
        if(wDate<today && row.asType!=='ìœ ìƒ'){
          tr.cells[17].style.backgroundColor='yellow';
        }
      }
      if(row.ê¸°ìˆ ì ì¢…ë£Œì¼ && ["ì •ìƒB","ë¶€ë¶„ë™ì‘","ë™ì‘ë¶ˆê°€"].includes(row.ë™ì‘ì—¬ë¶€)){
        activeCell.style.backgroundColor='yellow';
      }
      if(row.ì ‘ìˆ˜ë‚´ìš© && !row.ê¸°ìˆ ì ì¢…ë£Œì¼ && ["ì •ìƒA","ìœ ìƒì •ìƒ"].includes(row.ë™ì‘ì—¬ë¶€)){
        activeCell.style.backgroundColor='lightgreen';
      }

      // í–‰ ë†’ì´ì¡°ì ˆ
      const rowRes=document.createElement('div');
      rowRes.className='row-resizer';
      rowRes.addEventListener('mousedown',(ev)=>{
        startRowResize(ev,tr);
      });
      tr.appendChild(rowRes);

      tbody.appendChild(tr);
    });
    document.getElementById('countì •ìƒA').textContent=counts.ì •ìƒA;
    document.getElementById('countì •ìƒB').textContent=counts.ì •ìƒB;
    document.getElementById('countìœ ìƒì •ìƒ').textContent=counts.ìœ ìƒì •ìƒ;
    document.getElementById('countë¶€ë¶„ë™ì‘').textContent=counts.ë¶€ë¶„ë™ì‘;
    document.getElementById('countë™ì‘ë¶ˆê°€').textContent=counts.ë™ì‘ë¶ˆê°€;

    updateSidebarList();
  }

  let resizingRow=null, startY=0, startH=0;
  function startRowResize(e,tr){
    resizingRow=tr;
    startY=e.pageY;
    startH=tr.offsetHeight;
    document.addEventListener('mousemove',doRowResize);
    document.addEventListener('mouseup',stopRowResize);
    e.preventDefault();
  }
  function doRowResize(e){
    if(!resizingRow) return;
    const dy=e.pageY-startY;
    const newH=startH+dy;
    if(newH>20) resizingRow.style.height=newH+'px';
  }
  function stopRowResize(){
    document.removeEventListener('mousemove',doRowResize);
    document.removeEventListener('mouseup',stopRowResize);
    resizingRow=null;
  }

  /************************************************************
   * 7) Excel ë‹¤ìš´ë¡œë“œ/ì—…ë¡œë“œ
   ************************************************************/
  document.getElementById('downloadExcelBtn').addEventListener('click',()=>{
    const arr=asData.map(d=>({
      ê³µë²ˆ:d.ê³µë²ˆ, ê³µì‚¬:d.ê³µì‚¬, IMO:d.imo, HULL:d.hull,
      SHIPNAME:d.shipName, 'í˜¸ì„  ëŒ€í‘œë©”ì¼':d.repMail, 'SHIP TYPE':d.shipType,
      SCALE:d.scale, êµ¬ë¶„:d.êµ¬ë¶„, SHIPOWNER:d.shipowner, ì£¼ìš”ì„ ì‚¬:d.major,
      ê·¸ë£¹:d.group, SHIPYARD:d.shipyard, ê³„ì•½:d.contract, 'AS êµ¬ë¶„':d.asType,
      ì¸ë„ì¼:d.delivery, ë³´ì¦ì¢…ë£Œì¼:d.warranty, 'ì „ ë‹´ë‹¹':d.prevManager,
      'í˜„ ë‹´ë‹¹':d.manager, í˜„í™©:d.í˜„í™©, ë™ì‘ì—¬ë¶€:d.ë™ì‘ì—¬ë¶€,
      ì¡°ì¹˜ê³„íš:d.ì¡°ì¹˜ê³„íš, ì ‘ìˆ˜ë‚´ìš©:d.ì ‘ìˆ˜ë‚´ìš©, ì¡°ì¹˜ê²°ê³¼:d.ì¡°ì¹˜ê²°ê³¼,
      ASì ‘ìˆ˜ì¼ì:d.ASì ‘ìˆ˜ì¼ì, ê¸°ìˆ ì ì¢…ë£Œì¼:d.ê¸°ìˆ ì ì¢…ë£Œì¼,
      ì •ìƒì§€ì—°:d.ì •ìƒì§€ì—°, 'ì§€ì—° ì‚¬ìœ ':d['ì§€ì—° ì‚¬ìœ ']
    }));
    const ws=XLSX.utils.json_to_sheet(arr);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"AS_Data");
    XLSX.writeFile(wb,"AS_Data.xlsx");
  });

  document.getElementById('uploadExcelBtn').addEventListener('click',()=>{
    document.getElementById('excelModal').style.display='block';
  });
  document.getElementById('excelReplaceBtn').addEventListener('click',()=>{
    document.getElementById('excelModal').style.display='none';
    proceedExcelUpload('replace');
  });
  document.getElementById('excelAppendBtn').addEventListener('click',()=>{
    document.getElementById('excelModal').style.display='none';
    proceedExcelUpload('append');
  });
  document.getElementById('excelCancelBtn').addEventListener('click',()=>{
    document.getElementById('excelModal').style.display='none';
  });

  function proceedExcelUpload(mode){
    document.getElementById('uploadExcelInput').click();
    document.getElementById('uploadExcelInput').onchange=e=>{
      const file=e.target.files[0];
      if(!file)return;
      readExcelFile(file,mode);
      e.target.value='';
    };
  }
  function readExcelFile(file,mode){
    const reader=new FileReader();
    reader.onload=function(evt){
      const data=new Uint8Array(evt.target.result);
      const wb=XLSX.read(data,{type:'array',cellDates:true,dateNF:'yyyy-mm-dd'});
      const sheet=wb.Sheets[wb.SheetNames[0]];
      const json=XLSX.utils.sheet_to_json(sheet,{defval:''});
      let newData=[];
      json.forEach(r=>{
        const uid=db.ref().push().key;
        function parseDate(v){
          if(typeof v==='object'&&v instanceof Date){
            return toYMD(v);
          }
          if(typeof v==='string'){
            let s=v.trim().replace(/\//g,'-').replace(/\./g,'-');
            if(s==='#N/A'||s==='0'||s==='') return '';
            if(s.includes('-')){
              const parts=s.split('-');
              if(parts.length===3){
                let yy=parts[0].padStart(4,'0');
                let mm=parts[1].padStart(2,'0');
                let dd=parts[2].padStart(2,'0');
                return `${yy}-${mm}-${dd}`;
              }
            }
            return s;
          }
          return '';
        }
        function parseCell(v){
          if(typeof v==='number') return String(v);
          if(v==='#N/A') return '';
          return v;
        }
        const delivery=parseDate(r['ì¸ë„ì¼']||'');
        const warranty=parseDate(r['ë³´ì¦ì¢…ë£Œì¼']||'');
        const asReceipt=parseDate(r['ASì ‘ìˆ˜ì¼ì']||'');
        const techEnd=parseDate(r['ê¸°ìˆ ì ì¢…ë£Œì¼']||'');
        const normalDelay=(r['ì •ìƒì§€ì—°']==='Y')?'Y':'';
        const delayReason=r['ì§€ì—° ì‚¬ìœ ']||'';

        newData.push({
          uid,
          ê³µë²ˆ:parseCell(r['ê³µë²ˆ']),
          ê³µì‚¬:parseCell(r['ê³µì‚¬']),
          imo:parseCell(r['IMO']),
          hull:parseCell(r['HULL']),
          shipName:parseCell(r['SHIPNAME']),
          repMail:parseCell(r['í˜¸ì„  ëŒ€í‘œë©”ì¼']),
          shipType:parseCell(r['SHIP TYPE']),
          scale:parseCell(r['SCALE']),
          êµ¬ë¶„:parseCell(r['êµ¬ë¶„']),
          shipowner:parseCell(r['SHIPOWNER']),
          major:parseCell(r['ì£¼ìš”ì„ ì‚¬']),
          group:String(parseCell(r['ê·¸ë£¹'])||''),
          shipyard:parseCell(r['SHIPYARD']),
          contract:parseCell(r['ê³„ì•½']),
          asType:parseCell(r['AS êµ¬ë¶„'])||'ìœ ìƒ',
          delivery, warranty,
          prevManager:parseCell(r['ì „ ë‹´ë‹¹']),
          manager:parseCell(r['í˜„ ë‹´ë‹¹']),
          í˜„í™©:parseCell(r['í˜„í™©']),
          ë™ì‘ì—¬ë¶€:parseCell(r['ë™ì‘ì—¬ë¶€'])||'ì •ìƒA',
          ì¡°ì¹˜ê³„íš:parseCell(r['ì¡°ì¹˜ê³„íš']),
          ì ‘ìˆ˜ë‚´ìš©:parseCell(r['ì ‘ìˆ˜ë‚´ìš©']),
          ì¡°ì¹˜ê²°ê³¼:parseCell(r['ì¡°ì¹˜ê²°ê³¼']),
          ASì ‘ìˆ˜ì¼ì:asReceipt,
          ê¸°ìˆ ì ì¢…ë£Œì¼:techEnd,
          ì •ìƒì§€ì—°:normalDelay,
          'ì§€ì—° ì‚¬ìœ ':delayReason
        });
      });
      if(mode==='replace'){
        db.ref(asPath).remove().then(()=>{
          newData.forEach(obj=>{
            db.ref(asPath+'/'+obj.uid).set(obj);
          });
          asData=newData;
          renderTable();
          alert(`ì—‘ì…€ ì—…ë¡œë“œ(êµì²´) ì™„ë£Œ (ì´ ${json.length}ê±´)`);
        });
      } else {
        newData.forEach(obj=>{
          db.ref(asPath+'/'+obj.uid).set(obj);
        });
        asData=asData.concat(newData);
        renderTable();
        alert(`ì—‘ì…€ ì—…ë¡œë“œ(ì¶”ê°€) ì™„ë£Œ (ì´ ${json.length}ê±´)`);
      }
    };
    reader.readAsArrayBuffer(file);
  }
  function toYMD(dt){
    const y=dt.getFullYear();
    const m=('0'+(dt.getMonth()+1)).slice(-2);
    const d=('0'+dt.getDate()).slice(-2);
    return `${y}-${m}-${d}`;
  }

  // AS í˜„í™© ì—…ë¡œë“œ
  document.getElementById('uploadAsStatusBtn').addEventListener('click',()=>{
    document.getElementById('uploadAsStatusInput').click();
  });
  document.getElementById('uploadAsStatusInput').addEventListener('change',e=>{
    const file=e.target.files[0];
    if(!file)return;
    readAsStatusFile(file);
    e.target.value='';
  });
  function readAsStatusFile(file){
    const reader=new FileReader();
    reader.onload=function(evt){
      const data=new Uint8Array(evt.target.result);
      const wb=XLSX.read(data,{type:'array',cellDates:true,dateNF:'yyyy-mm-dd'});
      const sheet=wb.Sheets[wb.SheetNames[0]];
      const json=XLSX.utils.sheet_to_json(sheet,{defval:''});
      const map={};

      function dateToYMD(ms){
        if(!ms) return '';
        let d=new Date(ms);
        if(isNaN(d.getTime())) return '';
        let yy=d.getFullYear();
        let mm=('0'+(d.getMonth()+1)).slice(-2);
        let dd=('0'+d.getDate()).slice(-2);
        return `${yy}-${mm}-${dd}`;
      }
      for(let row of json){
        const asStatus=(row['ASì§„í–‰ìƒíƒœ']||'').trim();
        if(asStatus==='ì ‘ìˆ˜ì·¨ì†Œ')continue;
        const project=(row['ìˆ˜ìµí”„ë¡œì íŠ¸']||'').trim();
        if(!project)continue;
        const asDateRaw=row['ASì ‘ìˆ˜ì¼ì']||'';
        const asDateObj=new Date(asDateRaw.replace(/[./]/g,'-')+"T00:00");
        const asDateMS=asDateObj.getTime();

        const plan=row['ì¡°ì¹˜ê³„íš']||'';
        const rec=row['ì ‘ìˆ˜ë‚´ìš©']||'';
        const res=row['ì¡°ì¹˜ê²°ê³¼']||'';
        const tEnd=row['ê¸°ìˆ ì ì¢…ë£Œì¼ì']||'';

        if(!map[project]){
          map[project]={asDate:asDateMS,plan,rec,res,tEnd};
        } else {
          if(asDateMS>map[project].asDate){
            map[project]={asDate:asDateMS,plan,rec,res,tEnd};
          }
        }
      }
      let updateCount=0;
      mapKeys: for(let project in map){
        const item=map[project];
        const row=asData.find(x=>x.ê³µë²ˆ===project);
        if(row){
          row.ì¡°ì¹˜ê³„íš=item.plan;
          row.ì ‘ìˆ˜ë‚´ìš©=item.rec;
          row.ì¡°ì¹˜ê²°ê³¼=item.res;
          row.ê¸°ìˆ ì ì¢…ë£Œì¼=parseDateString(item.tEnd);
          row.ASì ‘ìˆ˜ì¼ì=dateToYMD(item.asDate);

          db.ref(asPath+'/'+row.uid+'/ì¡°ì¹˜ê³„íš').set(row.ì¡°ì¹˜ê³„íš);
          db.ref(asPath+'/'+row.uid+'/ì ‘ìˆ˜ë‚´ìš©').set(row.ì ‘ìˆ˜ë‚´ìš©);
          db.ref(asPath+'/'+row.uid+'/ì¡°ì¹˜ê²°ê³¼').set(row.ì¡°ì¹˜ê²°ê³¼);
          db.ref(asPath+'/'+row.uid+'/ê¸°ìˆ ì ì¢…ë£Œì¼').set(row.ê¸°ìˆ ì ì¢…ë£Œì¼);
          db.ref(asPath+'/'+row.uid+'/ASì ‘ìˆ˜ì¼ì').set(row.ASì ‘ìˆ˜ì¼ì);

          addHistory(`AS í˜„í™© ì—…ë¡œë“œ - [${row.uid}] (ê³µë²ˆ=${project})`);
          updateCount++;
        }
      }
      renderTable();
      alert(`AS í˜„í™© ì—…ë¡œë“œ ì™„ë£Œ (ì´ ${updateCount}ê±´ ì—…ë°ì´íŠ¸)`);
    };
    reader.readAsArrayBuffer(file);
  }
  function parseDateString(str){
    if(!str)return'';
    let v=str.trim().replace(/[./]/g,'-');
    let d=new Date(v+"T00:00");
    if(!isNaN(d.getTime())){
      const yy=d.getFullYear();
      const mm=('0'+(d.getMonth()+1)).slice(-2);
      const dd=('0'+d.getDate()).slice(-2);
      return `${yy}-${mm}-${dd}`;
    }
    return '';
  }

  /************************************************************
   * 8) íˆìŠ¤í† ë¦¬
   ************************************************************/
  document.getElementById('historyBtn').addEventListener('click',showHistoryModal);
  document.getElementById('clearHistoryBtn').addEventListener('click',clearHistory);

  function addHistory(msg){
    const k=db.ref(histPath).push().key;
    const t=new Date().toISOString();
    db.ref(histPath+'/'+k).set({time:t,msg});
  }
  async function showHistoryModal(){
    const snap=await db.ref(histPath).once('value');
    const val=snap.val()||{};
    let arr=Object.values(val).sort((a,b)=> new Date(b.time)-new Date(a.time));
    const hl=document.getElementById('historyList');
    hl.innerHTML='';
    arr.forEach(it=>{
      const li=document.createElement('li');
      li.textContent=`[${it.time}] ${it.msg}`;
      hl.appendChild(li);
    });
    document.getElementById('historyModal').style.display='block';
  }
  function closeHistoryModal(){
    document.getElementById('historyModal').style.display='none';
  }
  async function clearHistory(){
    if(!confirm("íˆìŠ¤í† ë¦¬ ì „ì²´ ì‚­ì œ?"))return;
    await db.ref(histPath).remove();
    document.getElementById('historyList').innerHTML='';
    alert("íˆìŠ¤í† ë¦¬ ì‚­ì œ ì™„ë£Œ");
  }

  /************************************************************
   * 9) ì‚¬ì´ë“œë°” (ë‹´ë‹¹ì/ì„ ì£¼ì‚¬)
   ************************************************************/
  document.getElementById('btnManager').addEventListener('click',()=>switchSideMode('manager'));
  document.getElementById('btnOwner').addEventListener('click',()=>switchSideMode('owner'));

  function switchSideMode(mode){
    currentMode=mode;
    document.getElementById('btnManager').classList.remove('active');
    document.getElementById('btnOwner').classList.remove('active');

    document.getElementById('filterIMO').value='';
    document.getElementById('filterHull').value='';
    document.getElementById('filterName').value='';
    document.getElementById('filterOwner').value='';
    document.getElementById('filterMajor').value='';
    document.getElementById('filterGroup').value='';
    document.getElementById('filterAsType').value='';
    document.getElementById('filterManager').value='';
    document.getElementById('filterActive').value='';

    if(mode==='manager'){
      document.getElementById('btnManager').classList.add('active');
      document.getElementById('listTitle').textContent='ë‹´ë‹¹ì ëª©ë¡';
    } else {
      document.getElementById('btnOwner').classList.add('active');
      document.getElementById('listTitle').textContent='ì„ ì£¼ì‚¬ ëª©ë¡';
    }
    updateSidebarList();
    renderTable();
  }

  function updateSidebarList(){
    const listDiv=document.getElementById('itemList');
    listDiv.innerHTML='';
    if(currentMode==='manager'){
      const mgrMap={};
      let allTotal=0, allProgress=0;
      asData.forEach(d=>{
        const mgr=d.manager||'';
        if(!mgr)return;
        if(!mgrMap[mgr])mgrMap[mgr]={total:0,progress:0};
        mgrMap[mgr].total++;
        allTotal++;
        if(d.ì ‘ìˆ˜ë‚´ìš© && !d.ê¸°ìˆ ì ì¢…ë£Œì¼){
          mgrMap[mgr].progress++;
          allProgress++;
        }
      });
      const allBtn=document.createElement('button');
      allBtn.style.display='flex';
      allBtn.style.justifyContent='space-between';
      const allLeft=document.createElement('span');
      allLeft.textContent=`ì „ì²´(${allTotal})`;
      const allRight=document.createElement('span');
      allRight.textContent=`ASì§„í–‰(${allProgress})`;
      allBtn.appendChild(allLeft);
      allBtn.appendChild(allRight);
      allBtn.onclick=()=>{
        document.getElementById('filterManager').value='';
        renderTable();
      };
      listDiv.appendChild(allBtn);

      let arr=Object.entries(mgrMap).map(([k,v])=>({mgr:k,...v}));
      arr.sort((a,b)=>b.total-a.total);
      arr.forEach(item=>{
        const btn=document.createElement('button');
        btn.style.display='flex';
        btn.style.justifyContent='space-between';
        const left=document.createElement('span');
        left.textContent=`${item.mgr}(${item.total})`;
        const right=document.createElement('span');
        right.textContent=`ASì§„í–‰(${item.progress})`;
        btn.appendChild(left);
        btn.appendChild(right);

        btn.onclick=()=>{
          document.getElementById('filterManager').value=item.mgr;
          renderTable();
        };
        listDiv.appendChild(btn);
      });

    } else {
      const owMap={};
      let allTotal=0, allProgress=0;
      asData.forEach(d=>{
        const ow=d.shipowner||'';
        if(!ow)return;
        if(!owMap[ow])owMap[ow]={total:0,progress:0};
        owMap[ow].total++;
        allTotal++;
        if(d.ì ‘ìˆ˜ë‚´ìš© && !d.ê¸°ìˆ ì ì¢…ë£Œì¼){
          owMap[ow].progress++;
          allProgress++;
        }
      });
      const allBtn=document.createElement('button');
      allBtn.style.display='flex';
      allBtn.style.justifyContent='space-between';
      const allLeft=document.createElement('span');
      allLeft.textContent=`ì „ì²´(${allTotal})`;
      const allRight=document.createElement('span');
      allRight.textContent=`ASì§„í–‰(${allProgress})`;
      allBtn.appendChild(allLeft);
      allBtn.appendChild(allRight);
      allBtn.onclick=()=>{
        document.getElementById('filterOwner').value='';
        renderTable();
      };
      listDiv.appendChild(allBtn);

      let arr=Object.entries(owMap).map(([k,v])=>({owner:k,...v}));
      arr.sort((a,b)=>b.total-a.total);
      arr.forEach(item=>{
        const btn=document.createElement('button');
        btn.style.display='flex';
        btn.style.justifyContent='space-between';
        const left=document.createElement('span');
        left.textContent=`${item.owner}(${item.total})`;
        const right=document.createElement('span');
        right.textContent=`ASì§„í–‰(${item.progress})`;
        btn.appendChild(left);
        btn.appendChild(right);

        btn.onclick=()=>{
          document.getElementById('filterOwner').value=item.owner;
          renderTable();
        };
        listDiv.appendChild(btn);
      });
    }
  }

  /************************************************************
   * 10) ì‚¬ìš©ì ê´€ë¦¬
   ************************************************************/
  document.getElementById('userManageBtn').addEventListener('click',openUserModal);
  function openUserModal(){
    if(!adminAuthorized){
      const pw=prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:");
      if(pw!=='snsys1234'){
        alert("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ë‹¤ë¦…ë‹ˆë‹¤.");
        return;
      }
      adminAuthorized=true;
    }
    db.ref(userPath).once('value').then(snap=>{
      const val=snap.val()||{};
      userData=Object.entries(val).map(([k,v])=>({uid:k,...v}));
      renderUserList();
      document.getElementById('userModal').style.display='block';
    });
  }
  function closeUserModal(){
    document.getElementById('userModal').style.display='none';
  }
  let userData=[];
  function renderUserList(){
    const listDiv=document.getElementById('userList');
    listDiv.innerHTML='';
    userData.forEach(u=>{
      const row=document.createElement('div');
      row.style.marginBottom='4px';
      const chk=document.createElement('input');
      chk.type='checkbox';
      chk.dataset.uid=u.uid;
      chk.style.marginRight='6px';
      row.appendChild(chk);

      const txt=document.createElement('span');
      txt.textContent=`ì‚¬ìš©ìëª…: ${u.username}, ë¹„ë²ˆ: ${u.password}`;
      row.appendChild(txt);

      listDiv.appendChild(row);
    });
  }
  document.getElementById('deleteSelectedUsersBtn').addEventListener('click',()=>{
    const cks=document.querySelectorAll('#userList input[type=checkbox]:checked');
    if(!cks.length){
      alert("ì‚­ì œí•  ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ì„¸ìš”.");
      return;
    }
    if(!confirm("ì„ íƒí•œ ì‚¬ìš©ìë“¤ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))return;
    cks.forEach(chk=>{
      const uid=chk.dataset.uid;
      db.ref(userPath+'/'+uid).remove();
    });
    db.ref(userPath).once('value').then(snap=>{
      const val=snap.val()||{};
      userData=Object.entries(val).map(([k,v])=>({uid:k,...v}));
      renderUserList();
    });
  });
  document.getElementById('addUserConfirmBtn').addEventListener('click',()=>{
    const uname=document.getElementById('newUserName').value.trim();
    const upw=document.getElementById('newUserPw').value.trim();
    if(!uname||!upw){
      alert("ì‚¬ìš©ìëª…/ë¹„ë²ˆ í•„ìˆ˜ ì…ë ¥");
      return;
    }
    const key=db.ref(userPath).push().key;
    db.ref(userPath+'/'+key).set({username:uname,password:upw}).then(()=>{
      alert("ì‚¬ìš©ì ë“±ë¡ ì™„ë£Œ");
      document.getElementById('newUserName').value='';
      document.getElementById('newUserPw').value='';
      db.ref(userPath).once('value').then(snap=>{
        const val=snap.val()||{};
        userData=Object.entries(val).map(([k,v])=>({uid:k,...v}));
        renderUserList();
      });
    });
  });

  /************************************************************
   * 11) AI ìš”ì•½
   ************************************************************/
  async function summarizeAndUpdateRow(uid){
    const row=asData.find(x=>x.uid===uid);
    if(!row){ alert("ëŒ€ìƒ í–‰ ì—†ìŒ"); return; }
    const text="[í•œêµ­ì–´ ìš”ì•½]\n\n[ì ‘ìˆ˜ë‚´ìš©]\n"+(row.ì ‘ìˆ˜ë‚´ìš©||"ì—†ìŒ")+"\n\n[ì¡°ì¹˜ê²°ê³¼]\n"+(row.ì¡°ì¹˜ê²°ê³¼||"ì—†ìŒ");
    const summary=await callGeminiForSummary(text);
    if(!summary){
      alert("AI ìš”ì•½ ì‹¤íŒ¨");
      return;
    }
    row.í˜„í™©=summary;
    await db.ref(asPath+'/'+uid+'/í˜„í™©').set(summary);
    addHistory(`AI ìš”ì•½ ì™„ë£Œ - [${uid}]`);
    renderTable();
    alert("AI ìš”ì•½ ê²°ê³¼ê°€ í˜„í™©ì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }

  /************************************************************
   * 12) ë‚´ìš© ëª¨ë‹¬
   ************************************************************/
  function openContentModal(text){
    document.getElementById('contentText').textContent=text;
    document.getElementById('contentModal').style.display='block';
  }
  function closeContentModal(){
    document.getElementById('contentModal').style.display='none';
  }

  /************************************************************
   * 13) ì„ ì‚¬ë³„ AI ìš”ì•½
   ************************************************************/
  document.getElementById('ownerAISummaryBtn').addEventListener('click',openOwnerAIModal);
  async function openOwnerAIModal(){
    const filterVal=document.getElementById('filterOwner').value.trim();
    if(!filterVal){
      alert("SHIPOWNER í•„í„° ë¨¼ì € ì…ë ¥/ì„ íƒ");
      return;
    }
    const targetRows=asData.filter(r=>(r.shipowner||'').toLowerCase().includes(filterVal.toLowerCase()));
    if(!targetRows.length){
      alert("í•´ë‹¹ ì„ ì‚¬ë¡œ í•„í„°ëœ í•­ëª© ì—†ìŒ");
      return;
    }
    let combined=`ì„ ì‚¬ëª…:${filterVal}\n\n`;
    combined+=`ì´ ${targetRows.length}ê±´\n\n`;
    targetRows.forEach(r=>{
      combined+=`SHIPNAME:${r.shipName||'N/A'}\n[ì ‘ìˆ˜ë‚´ìš©]\n${r.ì ‘ìˆ˜ë‚´ìš©||''}\n\n[ì¡°ì¹˜ê²°ê³¼]\n${r.ì¡°ì¹˜ê²°ê³¼||''}\n\n----\n`;
    });

    const finalSummary=await callGeminiForSummary(combined);
    document.getElementById('ownerAISummaryText').textContent=finalSummary||"ìš”ì•½ ì‹¤íŒ¨";
    document.getElementById('ownerAIModal').style.display='block';
  }

  /************************************************************
   * 14) í…Œì´ë¸” ê°€ë¡œ ìŠ¤í¬ë¡¤, ì—´í­ ìë™ë§ì¶¤
   ************************************************************/
  window.addEventListener('DOMContentLoaded',()=>{
    const styleElem=document.createElement('style');
    styleElem.textContent=`
      .table-container {
        overflow-x:auto !important;
        white-space:nowrap !important;
      }
      #asTable {
        display:inline-table !important;
        width:auto !important;
        min-width:0 !important;
        table-layout:auto !important;
      }
    `;
    document.head.appendChild(styleElem);
  });
  document.addEventListener('dblclick',(e)=>{
    const colRes=e.target.closest('.col-resizer');
    if(colRes){
      const th=colRes.parentElement;
      if(th) autoFitColumn(th);
    } else {
      const th=e.target.closest('th');
      if(th) autoFitColumn(th);
    }
  });
  function autoFitColumn(th){
    const table=document.getElementById('asTable');
    if(!table) return;
    const colIndex=[...th.parentElement.children].indexOf(th);
    let maxWidth=0;
    const rows=table.rows;
    for(let i=0;i<rows.length;i++){
      const cell=rows[i].cells[colIndex];
      if(!cell) continue;
      let textContent='';
      const widget=cell.querySelector('input,select,span');
      if(widget){
        if(widget.tagName==='SELECT'){
          textContent=widget.options[widget.selectedIndex]?.text||'';
        } else if(widget.tagName==='INPUT'){
          textContent=widget.value||'';
        } else if(widget.tagName==='SPAN'){
          textContent=widget.textContent||'';
        }
      } else {
        textContent=cell.innerText||cell.textContent||'';
      }
      const span=document.createElement('span');
      span.style.position='absolute';
      span.style.visibility='hidden';
      span.style.whiteSpace='nowrap';
      span.style.font='14px sans-serif';
      span.textContent=textContent;
      document.body.appendChild(span);
      const w=span.offsetWidth+16;
      document.body.removeChild(span);
      if(w>maxWidth) maxWidth=w;
    }
    th.style.width=maxWidth+'px';
  }
  </script>
</body>
</html>
